// ==UserScript==
// @name        VoiceLinks
// @namespace   Sanya
// @description Makes RJ codes more useful.(8-bit RJCode supported.)
// @match       *://*/*
// @match       file:///*
// @version     4.8.9
// @connect     dlsite.com
// @connect     media.ci-en.jp
// @grant       GM_setClipboard
// @grant       GM_openInTab
// @grant       GM_registerMenuCommand
// @grant       GM_setValue
// @grant       GM_getValue
// @grant       GM_addElement
// @grant       GM.xmlHttpRequest
// @grant       GM_xmlhttpRequest
// @run-at      document-start
// @homepage    https://sleazyfork.org/zh-CN/scripts/456775-voicelinks
// @downloadURL https://update.sleazyfork.org/scripts/456775/VoiceLinks.user.js
// @updateURL https://update.sleazyfork.org/scripts/456775/VoiceLinks.meta.js
// ==/UserScript==

(function () {
    'use strict';

    const IS_PREVIEW = false;

    //------ÊåÅ‰πÖÂåñËÆæÁΩÆÈ°π------
    let settings = {
        //ËØ≠Ë®ÄËÆæÁΩÆ
        _s_lang: "zh_CN",
        _s_popup_lang: "zh_CN",

        //Â∏∏ËßÑËÆæÁΩÆ
        _s_parse_url: true,
        _s_parse_url_in_dl: false,
        _s_show_translated_title_in_dl: true,
        _s_copy_as_filename_btn: true,
        _s_show_compatibility_warning: true,
        _s_url_insert_mode: "before_rj",
        _s_url_insert_text: "üîó",
        _s_sfw_mode: false,
        _s_sfw_blur_level: "medium",
        _s_sfw_remove_when_hover: true,
        _s_sfw_blur_transition: true,

        //‰ø°ÊÅØÊòæÁ§∫ËÆæÁΩÆ
        _s_category_preset: "voice",
        _s_voice__info_display_order: [
            "voice__dl_count",
            "voice__circle_name",
            "voice__translator_name",
            "voice__release_date",
            "voice__update_date",
            "voice__age_rating",
            "voice__scenario",
            "voice__illustration",
            "voice__voice_actor",
            "voice__music",
            "voice__genre",
            "voice__file_size"
        ],
        _s_voice__dl_count: false,
        _s_voice__circle_name: true,
        _s_voice__translator_name: true,
        _s_voice__release_date: true,
        _s_voice__update_date: true,
        _s_voice__age_rating: true,
        _s_voice__scenario: false,
        _s_voice__illustration: false,
        _s_voice__voice_actor: true,
        _s_voice__music: true,
        _s_voice__genre: true,
        _s_voice__file_size: true,
        _s_game__info_display_order: [
            "game__dl_count",
            "game__circle_name",
            "game__translator_name",
            "game__release_date",
            "game__update_date",
            "game__age_rating",
            "game__scenario",
            "game__illustration",
            "game__voice_actor",
            "game__music",
            "game__genre",
            "game__file_size"
        ],
        _s_game__dl_count: false,
        _s_game__circle_name: true,
        _s_game__translator_name: true,
        _s_game__release_date: true,
        _s_game__update_date: true,
        _s_game__age_rating: true,
        _s_game__scenario: true,
        _s_game__illustration: true,
        _s_game__voice_actor: true,
        _s_game__music: true,
        _s_game__genre: true,
        _s_game__file_size: true,
        _s_manga__info_display_order:[
            "manga__dl_count",
            "manga__circle_name",
            "manga__translator_name",
            "manga__release_date",
            "manga__update_date",
            "manga__age_rating",
            "manga__scenario",
            "manga__illustration",
            "manga__voice_actor",
            "manga__music",
            "manga__genre",
            "manga__file_size"
        ],
        _s_manga__dl_count: false,
        _s_manga__circle_name: true,
        _s_manga__translator_name: true,
        _s_manga__release_date: true,
        _s_manga__update_date: true,
        _s_manga__age_rating: true,
        _s_manga__scenario: true,
        _s_manga__illustration: true,
        _s_manga__voice_actor: true,  //Èü≥Â£∞Êº´Áîª
        _s_manga__music: true,
        _s_manga__genre: true,
        _s_manga__file_size: true,
        _s_video__info_display_order: [
            "video__dl_count",
            "video__circle_name",
            "video__translator_name",
            "video__release_date",
            "video__update_date",
            "video__age_rating",
            "video__scenario",
            "video__illustration",
            "video__voice_actor",
            "video__music",
            "video__genre",
            "video__file_size"
        ],
        _s_video__dl_count: false,
        _s_video__circle_name: true,
        _s_video__translator_name: true,
        _s_video__release_date: true,
        _s_video__update_date: true,
        _s_video__age_rating: true,
        _s_video__scenario: true,
        _s_video__illustration: true,
        _s_video__voice_actor: true,
        _s_video__music: true,
        _s_video__genre: true,
        _s_video__file_size: true,
        _s_novel__info_display_order: [
            "novel__dl_count",
            "novel__circle_name",
            "novel__translator_name",
            "novel__release_date",
            "novel__update_date",
            "novel__age_rating",
            "novel__scenario",
            "novel__illustration",
            "novel__voice_actor",
            "novel__music",
            "novel__genre",
            "novel__file_size"
        ],
        _s_novel__dl_count: false,
        _s_novel__circle_name: true,
        _s_novel__translator_name: true,
        _s_novel__release_date: true,
        _s_novel__update_date: true,
        _s_novel__age_rating: true,
        _s_novel__scenario: true,
        _s_novel__illustration: true,
        _s_novel__voice_actor: false,
        _s_novel__music: false,
        _s_novel__genre: true,
        _s_novel__file_size: true,
        _s_other__info_display_order: [
            "other__dl_count",
            "other__circle_name",
            "other__translator_name",
            "other__release_date",
            "other__update_date",
            "other__age_rating",
            "other__scenario",
            "other__illustration",
            "other__voice_actor",
            "other__music",
            "other__genre",
            "other__file_size"
        ],
        _s_other__dl_count: false,
        _s_other__circle_name: true,
        _s_other__translator_name: true,
        _s_other__release_date: true,
        _s_other__update_date: true,
        _s_other__age_rating: true,
        _s_other__scenario: true,
        _s_other__illustration: true,
        _s_other__voice_actor: true,
        _s_other__music: true,
        _s_other__genre: true,
        _s_other__file_size: true,

        //Ê†áÁ≠æÊòæÁ§∫ËÆæÁΩÆ
        _s_tag_main_switch: true,
        _s_tag_display_order: [
            "tag_no_longer_available",
            "tag_rate",
            "tag_work_type",
            "tag_translatable",
            "tag_not_translatable",
            "tag_translated",
            "tag_bonus_work",
            "tag_has_bonus",
            "tag_language_support",
            "tag_file_format",
            "tag_ai",
        ],
        _s_tag_rate: true,
        _s_tag_work_type: true,
        _s_tag_translatable: true,
        _s_tag_not_translatable: true,
        _s_tag_translated: true,
        _s_tag_language_support: true,
        _s_tag_bonus_work: true,
        _s_tag_has_bonus: true,
        _s_tag_file_format: false,
        _s_tag_no_longer_available: true,
        _s_tag_ai: true,

        _s_show_rate_count: false,

        _s_tag_translation_request: true,
        _s_tag_translation_request_display_order: [
            "tag_translation_request_simplified_chinese",
            "tag_translation_request_traditional_chinese",
            "tag_translation_request_english",
            "tag_translation_request_korean",
            "tag_translation_request_spanish",
            "tag_translation_request_german",
            "tag_translation_request_french",
            "tag_translation_request_indonesian",
            "tag_translation_request_italian",
            "tag_translation_request_portuguese",
            "tag_translation_request_swedish",
            "tag_translation_request_thai",
            "tag_translation_request_vietnamese",
        ],
        _s_tag_translation_request_english: false,
        _s_tag_translation_request_simplified_chinese: true,
        _s_tag_translation_request_traditional_chinese: true,
        _s_tag_translation_request_korean: false,
        _s_tag_translation_request_spanish: false,
        _s_tag_translation_request_german: false,
        _s_tag_translation_request_french: false,
        _s_tag_translation_request_indonesian: false,
        _s_tag_translation_request_italian: false,
        _s_tag_translation_request_portuguese: false,
        _s_tag_translation_request_swedish: false,
        _s_tag_translation_request_thai: false,
        _s_tag_translation_request_vietnamese: false,

        backup: function() {
            let backup = {};
            for (let key in this) {
                if(!key.startsWith("_s_")) continue;
                //Â¶ÇÊûúÁ±ªÂûã‰∏∫ÂàóË°®ÔºåÂàôÈúÄË¶ÅÂ∞ÜÂÖ∂Êã∑Ë¥ùÂá∫Êù•
                if(this[key] && Array.isArray(this[key])){
                    backup[key] = [...this[key]];
                }else{
                    backup[key] = this[key];
                }
            }
            this.default_backup = backup;
        },

        //Â§á‰ªΩÈªòËÆ§ÂÄº
        default_backup: {},

        //ÊöÇÂ≠òÂ∑≤‰øÆÊîπÂÄºÔºå‰∏çÊõ¥Êñ∞Âà∞ËÆæÁΩÆ
        temp_edited: {},

        load: function(){
            let need_reorder = false;
            for(let key in this){
                if(!key.startsWith("_s_")) continue;
                let val = GM_getValue(key.substring(3), this[key]);
                if(typeof val !== typeof this[key]){
                    val = this[key];
                }
                if(Array.isArray(val) && val.length !== this[key].length){
                    val = this[key];
                    need_reorder = true;
                }
                this[key] = val !== undefined ? val : this[key];
            }

            if(need_reorder) {
                window.addEventListener("load", () => {
                    window.alert("VoiceLinks: " + localize(localizationMap.need_reorder));
                });
                this.save();
            }
        },

        save: function () {
            //Â∞ÜÊöÇÂ≠ò‰øÆÊîπÂ∫îÁî®Ëá≥Settings
            for (let key in this.temp_edited) {
                if(!key.startsWith("_s_")) continue;
                if(this[key] === undefined || this.temp_edited[key] === undefined) continue;
                this[key] = this.temp_edited[key];
                this.temp_edited[key] = undefined;
            }

            //Â∞Ü‰øÆÊîπ‰øùÂ≠òËá≥GM
            for(let key in this){
                if(!key.startsWith("_s_")) continue;
                GM_setValue(key.substring(3), this[key]);
            }
        },

        //‰øùÂ≠ò‰∏¥Êó∂‰øÆÊîπ
        saveTemp: function (key, value){
            if(!key.startsWith("_s_")) key = "_s_" + key;
            this.temp_edited[key] = value;
        },

        clearTemp: function (){
            this.temp_edited = {};
        },

        reset: function () {
            if(!this.default_backup) return;
            for(let key in this.default_backup){
                if(!key.startsWith("_s_")) continue;
                GM_setValue(key.substring(3), this.default_backup[key]);
            }
        },

        hasEdited: function (key) {
            if(!key.startsWith("_s_")) key = "_s_" + key;
            if(this[key] === undefined) return false;
            return this[key] !== this.default_backup[key];
        },

        getDefaultValue: function (key) {
            if(!key.startsWith("_s_")) key = "_s_" + key;
            return this.default_backup[key];
        }
    }
    settings.backup();
    settings.load();
    //----------------------

    //------Êú¨Âú∞Âåñ-----------
    const localizationMap = {
        notice_update: {
            zh_CN: "VoiceLinksÂÖ¨ÂëäÊõ¥Êñ∞ÔºåÂèØËÉΩÂåÖÂê´ÈáçË¶ÅÁöÑÊñ∞ÂäüËÉΩËØ¥ÊòéÔºåÊòØÂê¶Ë∑≥ËΩ¨Ëá≥ËØ¥ÊòéÈ°µÈù¢Ôºü",
            zh_TW: "VoiceLinksÂÖ¨ÂëäÊõ¥Êñ∞ÔºåÂèØËÉΩÂåÖÂê´ÈáçË¶ÅÁöÑÊñ∞ÂäüËÉΩË™¨ÊòéÔºåÊòØÂê¶Ë∑≥ËΩâËá≥Ë™¨ÊòéÈ†ÅÈù¢Ôºü",
            en_US: "VoiceLinks Notice Update, may contain important new features, do you want to jump to the notice page?"
        },

        title_settings: {
            zh_CN: "VoiceLinks ËÆæÁΩÆ",
            zh_TW: "VoiceLinks Ë®≠ÂÆö",
            en_US: "VoiceLinks Settings"
        },

        title_language_settings: {
            zh_CN: "ËØ≠Ë®ÄËÆæÁΩÆ",
            zh_TW: "Ë™ûË®ÄË®≠ÂÆö",
            en_US: "Language Settings"
        },

        display_language: {
            zh_CN: "ÊòæÁ§∫ËØ≠Ë®Ä",
            zh_TW: "È°ØÁ§∫Ë™ûË®Ä",
            en_US: "Language"
        },

        popup_language: {
            zh_CN: "ÂºπÁ™óËØ≠Ë®Ä",
            zh_TW: "ÂΩàÁ™óË™ûË®Ä",
            en_US: "Popup Language"
        },

        popup_language_tooltip: {
            zh_CN: "‰ªÖ‰øÆÊîπÊ†áÈ¢òÂíåÊ†áÁ≠æÊòæÁ§∫ËØ≠Ë®ÄÔºå‰ø°ÊÅØÊú¨Ë∫´ÁöÑËØ≠Ë®Ä‰ª•DLSiteÁΩëÈ°µËÆæÁΩÆÁöÑËØ≠Ë®Ä‰∏∫ÂáÜ„ÄÇ",
            zh_TW: "Âè™‰øÆÊîπÊ®ôÈ°åÂíåÊ®ôÁ±§È°ØÁ§∫Ë™ûË®ÄÔºåË≥áË®äÊú¨Ë∫´ÁöÑË™ûË®Ä‰ª•DLSiteÁ∂≤È†ÅË®≠ÂÆöÁöÑË™ûË®ÄÁÇ∫Ê∫ñ„ÄÇ",
            en_US: "Only modify the title and tag display language, the language of the information itself is determined by the language of the DLSite page settings."
        },

        title_general_settings: {
            zh_CN: "Â∏∏ËßÑ",
            zh_TW: "Â∏∏Ë¶è",
            en_US: "General"
        },

        parse_url: {
            zh_CN: "Ëß£ÊûêURL",
            zh_TW: "Ëß£ÊûêURL",
            en_US: "Parse URL"
        },

        parse_url_tooltip: {
            zh_CN: "Èº†Ê†áÊÇ¨ÂÅúÂØºÊåáÂêëDLSite‰ΩúÂìÅÈ°µÈù¢ÁöÑURLÊó∂ÔºåÂêåÊ†∑ÊòæÁ§∫‰ΩúÂìÅ‰ø°ÊÅØ",
            zh_TW: "Èº†Ê®ôÊá∏ÂÅúÂ∞éÂêëDLSite‰ΩúÂìÅÈ†ÅÈù¢ÁöÑURLÊôÇÔºåÂêåÊ®£È°ØÁ§∫‰ΩúÂìÅË≥áË®ä",
            en_US: "Show work info when hovering over DLSite work URL"
        },

        parse_url_in_dl: {
            zh_CN: "Âú®DLSite‰∏äËß£ÊûêURL",
            zh_TW: "Âú®DLSite‰∏äËß£ÊûêURL",
            en_US: "Parse URL in DLSite"
        },

        parse_url_in_dl_tooltip: {
            zh_CN: "URLËæÉÂ§öÂèØËÉΩÂΩ±ÂìçÊ≠£Â∏∏ÈòÖËØª",
            zh_TW: "URLËºÉÂ§öÂèØËÉΩÂΩ±ÈüøÊ≠£Â∏∏Èñ±ËÆÄ",
            en_US: "URL is more likely to affect normal reading"
        },

        show_translated_title_in_dl: {
            zh_CN: "Âú®DLSiteÊòæÁ§∫ÂØπÂ∫îËØ≠Ë®ÄÁöÑÁøªËØëÊ†áÈ¢ò",
            zh_TW: "Âú®DLSiteÈ°ØÁ§∫Â∞çÊáâË™ûË®ÄÁöÑÁøªË≠ØÊ®ôÈ°å",
            en_US: "Show translated title in DLSite"
        },

        show_translated_title_in_dl_tooltip: {
            zh_CN: "‰ΩúÂìÅ‰ø°ÊÅØÈ°µÈù¢ÁöÑÊ†áÈ¢òÂ∞Ü‰ºöË¢´‰øÆÊîπ‰∏∫‰∏éÁøªËØëËØ≠Ë®ÄÂØπÂ∫îÁöÑÊ†áÈ¢òÔºåÈÅøÂÖçÁÆÄ‰∏≠ÁúãÁπÅ‰∏≠‰ΩúÂìÅÊ†áÈ¢ò‰∏∫Êó•ÊñáÁöÑÈóÆÈ¢ò",
            zh_TW: "‰ΩúÂìÅË≥áË®äÈ†ÅÈù¢ÁöÑÊ®ôÈ°åÂ∞áÊúÉË¢´‰øÆÊîπÁÇ∫ËàáÁøªË≠ØË™ûË®ÄÂ∞çÊáâÁöÑÊ®ôÈ°åÔºåÈÅøÂÖçÁπÅ‰∏≠ÁúãÁ∞°‰∏≠‰ΩúÂìÅÊ®ôÈ°åÁÇ∫Êó•ÊñáÁöÑÂïèÈ°å",
            en_US: "The title of the work info page will be modified to match the corresponding translation language, to avoid viewing the title as Japanese when viewing a work in non-English language."
        },

        copy_as_filename_btn: {
            zh_CN: "‚ÄúÂ§çÂà∂‰∏∫ÊúâÊïàÊñá‰ª∂Âêç‚ÄùÊåâÈíÆ",
            zh_TW: "‚ÄúË§áË£ΩÁÇ∫ÊúâÊïàÊ™îÊ°àÂêç‚ÄùÊåâÈàï",
            en_US: '"Copy as filename" button'
        },

        copy_as_filename_btn_tooltip: {
            zh_CN: "Èº†Ê†áÊÇ¨ÂÅúËá≥DLSite‰ΩúÂìÅÊ†áÈ¢òÈÉ®ÂàÜÂ∞Ü‰ºöÂá∫Áé∞ËØ•ÊåâÈíÆÔºåÁÇπÂáªÂç≥ÂèØÂ∞ÜÊ†áÈ¢òÂ§çÂà∂‰∏∫ÊúâÊïàÊñá‰ª∂ÂêçÔºåÊúâÊïàÊñá‰ª∂ÂêçÊåáÁöÑÊòØ‰ºöÂ∞ÜÊ†áÈ¢ò‰∏≠ÁöÑÈùûÊ≥ïÈÉ®ÂàÜÁî®Áõ∏‰ººÁöÑÁ¨¶Âè∑‰ª£Êõø",
            zh_TW: "Èº†Ê®ôÊá∏ÂÅúËá≥DLSite‰ΩúÂìÅÊ®ôÈ°åÈÉ®ÂàÜÂ∞áÊúÉÂá∫ÁèæÊåâÈàïÔºåÈªûÊìäÂç≥ÂèØÂ∞áÊ®ôÈ°åË§áË£ΩÁÇ∫ÊúâÊïàÊ™îÊ°àÂêçÔºåÊúâÊïàÊ™îÊ°àÂêçÊåáÁöÑÊòØÊúÉÂ∞áÊ®ôÈ°å‰∏≠ÁöÑÈùûÊ≥ïÈÉ®ÂàÜÁî®Áõ∏‰ººÁöÑÁ¨¶Ëôü‰ª£Êõø",
            en_US: "Show button when hovering over DLSite work title. Clicking it will copy the title to a valid filename, which will replace the illegal part of the title with similar symbols."
        },

        show_compatibility_warning: {
            zh_CN: "ÊòæÁ§∫ÂÖºÂÆπÊÄßË≠¶Âëä",
            zh_TW: "È°ØÁ§∫ÂÖºÂÆπÊÄßË≠¶Âëä",
            en_US: "Show compatibility warning"
        },

        show_compatibility_warning_tooltip: {
            zh_CN: "Â¶ÇÊûúËÑöÊú¨‰∏≠Ôºå‰øÆÊîπDLSiteÈ°µÈù¢ÂÖÉÁ¥†ÁöÑÂäüËÉΩË¶ÜÁõñ‰∫ÜÂÖ∂ÂÆÉËÑöÊú¨ÁöÑ‰øÆÊîπÔºåÂàô‰ºöËß¶ÂèëËØ•ÂºπÁ™óË≠¶Âëä",
            zh_TW: "Â¶ÇÊûúËÖ≥Êú¨‰∏≠Ôºå‰øÆÊîπDLSiteÈ†ÅÈù¢ÂÖÉÁ¥†ÁöÑÂäüËÉΩË¶ÜËìã‰∫ÜÂÖ∂ÂÆÉËÖ≥Êú¨ÁöÑ‰øÆÊîπÔºåÂàôÊúÉËß∏ÁôºË©≤ÂΩàÁ™óË≠¶Âëä",
            en_US: "If the script modifies the functionality of DLSite elements that are covered by other scripts, the warning will be triggered"
        },

        url_insert_mode: {
            zh_CN: "ÂØºÂêëÊñáÊú¨ÁöÑÊèíÂÖ•ÊñπÂºè",
            zh_TW: "Â∞éÂêëÊñáÊú¨ÁöÑÊèíÂÖ•ÊñπÂºè",
            en_US: "Type of the insertion"
        },

        url_insert_mode_tooltip: {
            zh_CN: "Â¶ÇÊûúÊüêÊÆµÈìæÊé•‰∏≠ÁöÑRJÂè∑Ë¢´Ëß£ÊûêÊàêÂäüÔºå‰∏∫‰∫Ü‰øùËØÅÂéüÈìæÊé•‰∏çË¢´ÂÆåÂÖ®Ë¶ÜÁõñÔºå‰ºöÊ†πÊçÆÈúÄË¶ÅÔºåÂú®URLÁöÑÊñáÊú¨Ââç/ÂêéÊèíÂÖ•ÁâπÂÆöÂØºÂêëÊñáÊú¨",
            zh_TW: "Â¶ÇÊûúÊüêÊÆµÈÄ£Áµê‰∏≠ÁöÑRJËôüË¢´Ëß£ÊûêÊàêÂäüÔºåÁÇ∫‰∫Ü‰øùË≠âÂéüÈÄ£Áµê‰∏çË¢´ÂÆåÂÖ®Ë¶ÜËìãÔºåÊúÉÊ†πÊìöÈúÄË¶ÅÔºåÂú®URLÁöÑÊñáÊú¨Ââç/ÂæåÊèíÂÖ•ÁâπÂÆöÂ∞éÂêëÊñáÊú¨",
            en_US: "If the RJ number in a link is parsed successfully, it is necessary to insert a specific text in the URL before/after the link when the link is almost completely covered by the script"
        },

        url_insert_mode_none: {
            zh_CN: "‰∏çÊèíÂÖ•",
            zh_TW: "‰∏çÊèíÂÖ•",
            en_US: "None"
        },

        url_insert_mode_prefix: {
            zh_CN: "ÂâçÁºÄÊèíÂÖ•‰ª£ÊõøÂéüÈìæÊé•",
            zh_TW: "ÂâçÁ∂¥ÊèíÂÖ•‰ª£ÊõøÂéüÈÄ£Áµê",
            en_US: "Insert before the link as original link."
        },

        url_insert_mode_before_rj: {
            zh_CN: "ÊèíÂÖ•Âà∞RJÂè∑Ââç‰ª£ÊõøRJÈìæÊé•",
            zh_TW: "ÊèíÂÖ•Âà∞RJËôüÂâç‰ª£ÊõøRJÈÄ£Áµê",
            en_US: "Insert before the RJ link as the RJ link."
        },

        url_insert_text: {
            zh_CN: "ÂØºÂêëÊñáÊú¨",
            zh_TW: "Â∞éÂêëÊñáÊú¨",
            en_US: "Text to insert"
        },

        sfw_mode: {
            zh_CN: "SFW Ê®°Âºè",
            zh_TW: "SFW Ê®°Âºè",
            en_US: "SFW Mode"
        },

        sfw_mode_tooltip: {
            zh_CN: "ÂêØÁî®ÂêéÔºåÊâÄÊúâ‰ΩúÂìÅÂ∞ÅÈù¢Âùá‰ºöÊ®°Á≥äÂ§ÑÁêÜÔºàÂõ∫ÂÆöÁ™óÂè£Êó∂Â∞ÜÈº†Ê†áÁßªÂä®Âà∞ÂõæÁâá‰∏äÂèØ‰∏¥Êó∂ÂéªÈô§Ê®°Á≥äÔºâ",
            zh_TW: "ÂïüÁî®ÂæåÔºåÊâÄÊúâ‰ΩúÂìÅÂ∞ÅÈù¢ÂùáÊúÉÊ®°Á≥äËôïÁêÜÔºàÂõ∫ÂÆöË¶ñÁ™óÊôÇÂ∞áÊªëÈº†ÁßªÂãïÂà∞ÂúñÁâá‰∏äÂèØÊö´ÊôÇÂéªÈô§Ê®°Á≥äÔºâ",
            en_US: "Turn on to blur the cover of all works (temporarily remove the blur by moving the mouse over the image when the window is fixed)."
        },

        sfw_blur_level: {
            zh_CN: "Ê®°Á≥äÁ®ãÂ∫¶",
            zh_TW: "Ê®°Á≥äÁ®ãÂ∫¶",
            en_US: "Blur level"
        },

        sfw_remove_when_hover: {
            zh_CN: "Èº†Ê†áÁßªÂà∞ÂõæÁâá‰∏äÊó∂ÁßªÈô§Ê®°Á≥ä",
            zh_TW: "ÊªëÈº†ÁßªÂà∞ÂúñÁâá‰∏äÊôÇÁßªÈô§Ê®°Á≥ä",
            en_US: "Remove the blur when the mouse moves over the image"
        },

        sfw_blur_transition: {
            zh_CN: "Ê®°Á≥äÂä®ÁîªÔºàÂç°È°øËØ∑ÂÖ≥Èó≠Ôºâ",
            zh_TW: "Ê®°Á≥äÂãïÁï´ÔºàÂç°È†ìË´ãÈóúÈñâÔºâ",
            en_US: "Blur animation"
        },

        low: {
            zh_CN: "‰Ωé - ‰ªÖÊ®°Á≥äÁªÜËäÇ",
            zh_TW: "‰Ωé - ÂÉÖÊ®°Á≥äÁ¥∞ÁØÄ",
            en_US: "Low - Only blur details"
        },

        medium: {
            zh_CN: "‰∏≠ - ‰æùÁ®ÄÂèØËßÅ",
            zh_TW: "‰∏≠ - ‰æùÁ®ÄÂèØË¶ã",
            en_US: "Medium - Hard to see"
        },

        high: {
            zh_CN: "È´ò - ÂÆåÂÖ®Êó†Ê≥ïËæ®ËÆ§",
            zh_TW: "È´ò - ÂÆåÂÖ®ÁÑ°Ê≥ïËæ®Ë≠ò",
            en_US: "High - Unrecognizable"
        },

        title_info_settings: {
            zh_CN: "‰ø°ÊÅØÊòæÁ§∫",
            zh_TW: "‰ø°ÊÅØÈ°ØÁ§∫",
            en_US: "Info Display"
        },

        category_preset: {
            zh_CN: "Á±ªÂà´È¢ÑËÆæ",
            zh_TW: "È°ûÂà•È†êË®≠",
            en_US: "Category Preset"
        },

        category_preset_tooltip: {
            zh_CN: "‰Ωø‰∏çÂêåÁ±ªÂà´ÁöÑ‰ΩúÂìÅÊ†πÊçÆÈúÄË¶ÅÊòæÁ§∫‰∏çÂêåÁöÑ‰ø°ÊÅØ<br/><br/>Ê≥®ÊÑèÔºöÂç≥‰ΩøÂãæÈÄâ‰∫ÜÊòæÁ§∫ÔºåËã•‰ΩúÂìÅ‰∏≠‰∏çÂ≠òÂú®ËØ•‰ø°ÊÅØÂàô‰πü‰ºöÈöêËóè„ÄÇ",
            zh_TW: "‰Ωø‰∏çÂêåÈ°ûÂà•ÁöÑ‰ΩúÂìÅÊ†πÊìöÈúÄË¶ÅÈ°ØÁ§∫‰∏çÂêåÁöÑ‰ø°ÊÅØ<br/><br/>Ê≥®ÊÑèÔºöÂç≥‰ΩøÂãæÈÅ∏‰∫ÜÈ°ØÁ§∫ÔºåËã•‰ΩúÂìÅ‰∏≠‰∏çÂ≠òÂú®Ë©≤‰ø°ÊÅØÂâá‰πüÊúÉÈö±Ëóè„ÄÇ",
            en_US: "Show the information of different categories of works. <br/><br/>Note: even if checked, the information of a work that does not exist will be hidden."
        },

        rate: {
            zh_CN: "ËØÑÂàÜ",
            zh_TW: "Ë©ïÂàÜ",
            en_US: "Rate"
        },

        rate_tooltip: {
            zh_CN: "ÊòüÊï∞‚òÖ (ËØÑÂàÜ‰∫∫Êï∞ (ËÆæÁΩÆÂºÄÂêØ))",
            zh_TW: "ÊòüÊï∏‚òÖ (Ë©ïÂàÜ‰∫∫Êï∏ (Ë®≠ÁΩÆÈñãÂïü))",
            en_US: "Star‚òÖ (number of ratings (enable in settings))"
        },

        dl_count: {
            zh_CN: "ÈîÄÈáè",
            zh_TW: "Èä∑Èáè",
            en_US: "Sales"
        },

        circle_name: {
            zh_CN: "Á§æÂõ¢Âêç",
            zh_TW: "Á§æÂúòÂêç",
            en_US: "Circle Name"
        },

        translator_name: {
            zh_CN: "ÁøªËØëËÄÖ",
            zh_TW: "ÁøªË≠ØËÄÖ",
            en_US: "Translator"
        },

        release_date: {
            zh_CN: "ÂèëÂîÆÊó•",
            zh_TW: "ÁôºÂîÆÊó•",
            en_US: "Release Date"
        },

        update_date: {
            zh_CN: "Êõ¥Êñ∞Êó•",
            zh_TW: "Êõ¥Êñ∞Êó•",
            en_US: "Update Date"
        },

        age_rating: {
            zh_CN: "Âπ¥ÈæÑÊåáÂÆö",
            zh_TW: "Âπ¥ÈΩ°ÊåáÂÆö",
            en_US: "Age Rating"
        },

        scenario: {
            zh_CN: "ÂâßÊÉÖ",
            zh_TW: "ÂäáÊÉÖ",
            en_US: "Scenario"
        },

        illustration: {
            zh_CN: "ÊèíÁîª",
            zh_TW: "ÊèíÂúñ",
            en_US: "Illustration"
        },

        voice_actor: {
            zh_CN: "Â£∞‰ºò",
            zh_TW: "ËÅ≤ÂÑ™",
            en_US: "Voice Actor"
        },

        music: {
            zh_CN: "Èü≥‰πê",
            zh_TW: "Èü≥Ê®Ç",
            en_US: "Music"
        },

        genre: {
            zh_CN: "ÂàÜÁ±ª",
            zh_TW: "ÂàÜÈ°û",
            en_US: "Genre"
        },

        file_size: {
            zh_CN: "Êñá‰ª∂ÂÆπÈáè",
            zh_TW: "Ê™îÊ°àÂÆπÈáè",
            en_US: "File Size"
        },

        title_tag_settings: {
            zh_CN: "Ê†áÁ≠æÊòæÁ§∫",
            zh_TW: "Ê®ôÁ±§È°ØÁ§∫",
            en_US: "Tag Display"
        },

        tag_main_switch: {
            zh_CN: "Ê†áÁ≠æÊÄªÂºÄÂÖ≥",
            zh_TW: "Ê®ôÁ±§Á∏ΩÈñãÈóú",
            en_US: "Tag Main Switch"
        },

        tag_main_switch_tooltip: {
            zh_CN: "ÂÖ≥Èó≠ÂàôÊâÄÊúâÊ†áÁ≠æÂùá‰∏çÊòæÁ§∫",
            zh_TW: "ÈóúÈñâÂâáÊâÄÊúâÊ®ôÁ±§ÈÉΩ‰∏çÈ°ØÁ§∫",
            en_US: "If turned off, all tags will not be displayed"
        },

        tag_work_type: {
            zh_CN: "‰ΩúÂìÅÁ±ªÂûã",
            zh_TW: "‰ΩúÂìÅÈ°ûÂûã",
            en_US: "Work Type"
        },

        work_type_game: {
            zh_CN: "Ê∏∏Êàè",
            zh_TW: "ÈÅäÊà≤",
            en_US: "Game"
        },

        work_type_comic: {
            zh_CN: "Êº´Áîª",
            zh_TW: "Êº´Áï´",
            en_US: "Manga"
        },

        work_type_illustration: {
            zh_CN: "CG„ÉªÊèíÁîª",
            zh_TW: "CG„ÉªÊèíÁï´",
            en_US: "CG + Illustrations"
        },

        work_type_novel: {
            zh_CN: "Â∞èËØ¥",
            zh_TW: "Â∞èË™™",
            en_US: "Novel"
        },

        work_type_video: {
            zh_CN: "ËßÜÈ¢ë",
            zh_TW: "ÂΩ±Áâá",
            en_US: "Video"
        },

        work_type_voice: {
            zh_CN: "Èü≥Â£∞„ÉªASMR",
            zh_TW: "ËÅ≤Èü≥‰ΩúÂìÅ„ÉªASMR",
            en_US: "Voice / ASMR"
        },

        work_type_music: {
            zh_CN: "Èü≥‰πê",
            zh_TW: "Èü≥Ê®Ç",
            en_US: "Music"
        },

        work_type_tool: {
            zh_CN: "Â∑•ÂÖ∑/Ë£ÖÈ•∞",
            zh_TW: "Â∑•ÂÖ∑/ÈÖç‰ª∂",
            en_US: "Tools / Accessories"
        },

        work_type_voice_comic: {
            zh_CN: "Èü≥Â£∞Êº´Áîª",
            zh_TW: "ÊúâËÅ≤Êº´Áï´",
            en_US: "Voiced Comics"
        },

        work_type_other: {
            zh_CN: "ÂÖ∂‰ªñ",
            zh_TW: "ÂÖ∂‰ªñ",
            en_US: "Miscellaneous"
        },

        tag_translatable: {
            zh_CN: "ÂèØÁøªËØë",
            zh_TW: "ÂèØÁøªË≠Ø",
            en_US: "Translatable"
        },

        tag_translatable_tooltip: {
            zh_CN: "Â§ßÂÆ∂‰∏ÄËµ∑Êù•ÁøªËØë ÊéàÊùÉ‰ΩúÂìÅ",
            zh_TW: "Â§ßÂÆ∂‰∏ÄËµ∑ÁøªË≠Ø ÊéàÊùÉ‰ΩúÂìÅ",
            en_US: "Translators Unite translation permitted work"
        },

        tag_not_translatable: {
            zh_CN: "‰∏çÂèØÁøªËØë",
            zh_TW: "‰∏çÂèØÁøªË≠Ø",
            en_US: "Not Translatable"
        },

        tag_not_translatable_tooltip: {
            zh_CN: "Êú™ÊéàÊùÉ Â§ßÂÆ∂‰∏ÄËµ∑Êù•ÁøªËØë",
            zh_TW: "Êú™ÊéàÊ¨ä Â§ßÂÆ∂‰∏ÄËµ∑‰æÜÁøªË≠Ø",
            en_US: "Not Translators Unite translation permitted work"
        },

        tag_translated: {
            zh_CN: "ÁøªËØë‰ΩúÂìÅ",
            zh_TW: "ÁøªË≠Ø‰ΩúÂìÅ",
            en_US: "Translated"
        },

        tag_translated_tooltip: {
            zh_CN: "ÂΩìÂâç‰ΩúÂìÅ‰∏∫ Â§ßÂÆ∂‰∏ÄËµ∑Êù•ÁøªËØë ‰ΩúÂìÅ",
            zh_TW: "Áï∂Ââç‰ΩúÂìÅÁÇ∫ Â§ßÂÆ∂‰∏ÄËµ∑‰æÜÁøªË≠Ø ‰ΩúÂìÅ",
            en_US: "Current work is Translators Unite translation work"
        },

        tag_language_support: {
            zh_CN: "ËØ≠Ë®ÄÊîØÊåÅ",
            zh_TW: "Ë™ûË®ÄÊîØÊè¥",
            en_US: "Language Support"
        },

        language_japanese: {
            zh_CN: "Êó•Êñá",
            zh_TW: "Êó•Êñá",
            en_US: "Japanese"
        },

        language_english: {
            zh_CN: "Ëã±Êñá",
            zh_TW: "Ëã±Êñá",
            en_US: "English"
        },

        language_korean: {
            zh_CN: "Èü©ËØ≠",
            zh_TW: "ÈüìË™û",
            en_US: "Korean"
        },

        language_simplified_chinese: {
            zh_CN: "ÁÆÄ‰Ωì‰∏≠Êñá",
            zh_TW: "Á∞°È´î‰∏≠Êñá",
            en_US: "Simplified Chinese"
        },

        language_traditional_chinese: {
            zh_CN: "ÁπÅ‰Ωì‰∏≠Êñá",
            zh_TW: "ÁπÅÈ´î‰∏≠Êñá",
            en_US: "Traditional Chinese"
        },

        language_german: {
            zh_CN: "Âæ∑ËØ≠",
            zh_TW: "Âæ∑Ë™û",
            en_US: "German"
        },

        language_french: {
            zh_CN: "Ê≥ïËØ≠",
            zh_TW: "Ê≥ïË™û",
            en_US: "French"
        },

        language_russian: {
            zh_CN: "‰øÑËØ≠",
            zh_TW: "‰øÑË™û",
            en_US: "Russian"
        },

        language_spanish: {
            zh_CN: "Ë•øÁè≠ÁâôËØ≠",
            zh_TW: "Ë•øÁè≠ÁâôË™û",
            en_US: "Spanish"
        },

        language_indonesian: {
            zh_CN: "Âç∞Â∞ºÊñá",
            zh_TW: "Âç∞Â∞ºÊñá",
            en_US: "Indonesian"
        },

        language_italian: {
            zh_CN: "ÊÑèÂ§ßÂà©ËØ≠",
            zh_TW: "Áæ©Â§ßÂà©Ë™û",
            en_US: "Italian"
        },

        language_arabic: {
            zh_CN: "ÈòøÊãâ‰ºØËØ≠",
            zh_TW: "ÈòøÊãâ‰ºØË™û",
            en_US: "Arabic"
        },

        language_portuguese: {
            zh_CN: "Ëë°ËêÑÁâôËØ≠",
            zh_TW: "Ëë°ËêÑÁâôË™û",
            en_US: "Portuguese"
        },

        language_finnish: {
            zh_CN: "Ëä¨ÂÖ∞ËØ≠",
            zh_TW: "Ëä¨Ëò≠Ë™û",
            en_US: "Finnish"
        },

        language_polish: {
            zh_CN: "Ê≥¢ÂÖ∞ËØ≠",
            zh_TW: "Ê≥¢Ëò≠Ë™û",
            en_US: "Polish"
        },

        language_swedish: {
            zh_CN: "ÁëûÂÖ∏Êñá",
            zh_TW: "ÁëûÂÖ∏Êñá",
            en_US: "Swedish"
        },

        language_thai: {
            zh_CN: "Ê≥∞ËØ≠",
            zh_TW: "Ê≥∞Ë™û",
            en_US: "Thai"
        },

        language_vietnamese: {
            zh_CN: "Ë∂äÂçóËØ≠",
            zh_TW: "Ë∂äÂçóË™û",
            en_US: "Vietnamese"
        },

        language_japanese_abbr: {
            zh_CN: "Êó•",
            zh_TW: "Êó•",
            en_US: "JP"
        },

        language_english_abbr: {
            zh_CN: "Ëã±",
            zh_TW: "Ëã±",
            en_US: "EN"
        },

        language_korean_abbr: {
            zh_CN: "Èü©",
            zh_TW: "Èü©",
            en_US: "KO"
        },

        language_simplified_chinese_abbr: {
            zh_CN: "ÁÆÄ‰∏≠",
            zh_TW: "Á∞°‰∏≠",
            en_US: "ZH"
        },

        language_traditional_chinese_abbr: {
            zh_CN: "ÁπÅ‰∏≠",
            zh_TW: "ÁπÅ‰∏≠",
            en_US: "TW"
        },

        language_german_abbr: {
            zh_CN: "Âæ∑",
            zh_TW: "Âæ∑",
            en_US: "DE"
        },

        language_french_abbr: {
            zh_CN: "Ê≥ï",
            zh_TW: "Ê≥ï",
            en_US: "FR"
        },

        language_spanish_abbr: {
            zh_CN: "Ë•ø",
            zh_TW: "Ë•ø",
            en_US: "ES"
        },

        language_indonesian_abbr: {
            zh_CN: "Âç∞",
            zh_TW: "Âç∞",
            en_US: "ID"
        },

        language_italian_abbr: {
            zh_CN: "ÊÑè",
            zh_TW: "ÊÑè",
            en_US: "IT"
        },

        language_portuguese_abbr: {
            zh_CN: "Ëë°",
            zh_TW: "Ëë°",
            en_US: "PT"
        },

        language_swedish_abbr: {
            zh_CN: "ÁëûÂÖ∏",
            zh_TW: "ÁëûÂÖ∏",
            en_US: "SV"
        },

        language_thai_abbr: {
            zh_CN: "Ê≥∞",
            zh_TW: "Ê≥∞",
            en_US: "TH"
        },

        language_vietnamese_abbr: {
            zh_CN: "Ë∂ä",
            zh_TW: "Ë∂ä",
            en_US: "VN"
        },

        show_rate_count: {
            zh_CN: "ÊòæÁ§∫ËØÑÂàÜ‰∫∫Êï∞",
            zh_TW: "È°ØÁ§∫Ë©ïÂàÜ‰∫∫Êï∏",
            en_US: "Show Rate Count"
        },

        tag_translation_request: {
            zh_CN: "ÁøªËØëÁî≥ËØ∑ÊÉÖÂÜµ",
            zh_TW: "ÁøªË≠ØÁî≥Ë´ãÊÉÖÂÜµ",
            en_US: "Translation Request"
        },

        tag_translation_request_tooltip: {
            zh_CN: "ÂΩìÂâç‰ΩúÂìÅÁõÆÂâçÁöÑÁøªËØëÁî≥ËØ∑ÊÉÖÂÜµÔºåÊ†ºÂºè‰∏∫ÔºöËØ≠Ë®ÄÁÆÄÂÜô Áî≥ËØ∑Êï∞-ÂèëÂîÆÊï∞",
            zh_TW: "Áï∂Ââç‰ΩúÂìÅÁõÆÂâçÁöÑÁøªË≠ØÁî≥Ë´ãÊÉÖÊ≥ÅÔºåÊ†ºÂºèÁÇ∫ÔºöËØ≠Ë®ÄÁ∞°Á®± Áî≥Ë´ãÊï∏-ÁôºÂîÆÊï∏",
            en_US: "Current work's translation request. Format: Language_Abbr Number_of_Requests - Number_of_Sales"
        },

        tag_bonus_work: {
            zh_CN: "ÁâπÂÖ∏",
            zh_TW: "ÁâπÂÖ∏",
            en_US: "Bonus"
        },

        tag_bonus_work_tooltip: {
            zh_CN: "ÂΩìÂâç‰ΩúÂìÅÊòØÊüêÈÉ®‰ΩúÂìÅÁöÑÁâπÂÖ∏",
            zh_TW: "Áï∂Ââç‰ΩúÂìÅÊòØÊüêÈÉ®‰ΩúÂìÅÁöÑÁâπÂÖ∏",
            en_US: "Current work is a bonus work"
        },

        tag_has_bonus: {
            zh_CN: "ÊúâÁâπÂÖ∏",
            zh_TW: "ÊúâÁâπÂÖ∏",
            en_US: "Has Bonus"
        },

        tag_has_bonus_tooltip: {
            zh_CN: "ÂΩìÂâç‰ΩúÂìÅÁõÆÂâçÈôÑËµ†ÁâπÂÖ∏ÔºåËã•ÁâπÂÖ∏Â∑≤‰∏ãÊû∂Âàô‰∏ç‰ºöÊòæÁ§∫ËØ•Ê†áÁ≠æ",
            zh_TW: "Áï∂Ââç‰ΩúÂìÅÁõÆÂâçÈôÑËµ†ÁâπÂÖ∏ÔºåËã•ÁâπÂÖ∏Â∑≤‰∏ãÊû∂Ââá‰∏çÊúÉÈ°ØÁ§∫Ë©≤Ê®ôÁ±§",
            en_US: "Current work has bonus. If bonus is not available, the tag will not be displayed."
        },

        tag_file_format: {
            zh_CN: "Êñá‰ª∂Ê†ºÂºè",
            zh_TW: "Ê™îÊ°àÂΩ¢Âºè",
            en_US: "File Format"
        },

        tag_file_format_tooltip: {
            zh_CN: "WAV„ÄÅEXE„ÄÅMP3Á≠â",
            zh_TW: "WAV„ÄÅEXE„ÄÅMP3Á≠â",
            en_US: "WAV, EXE, MP3, etc."
        },

        tag_no_longer_available: {
            zh_CN: "Â∑≤‰∏ãÊû∂",
            zh_TW: "Â∑≤‰∏ãÊû∂",
            en_US: "Unavailable"
        },

        tag_announce: {
            zh_CN: "È¢ÑÂëä",
            zh_TW: "È†êÂëä",
            en_US: "Announce"
        },

        tag_ai: {
            zh_CN: "AI & ÈÉ®ÂàÜAI",
            zh_TW: "AI & ÈÉ®ÂàÜAI",
            en_US: "AI & Partial AI"
        },

        tag_aig: {
            zh_CN: "AIÁîüÊàê",
            zh_TW: "AIÁîüÊàê",
            en_US: "AI Gen",
        },

        tag_aip: {
            zh_CN: "AIÈÉ®ÂàÜ‰ΩøÁî®",
            zh_TW: "AIÈÉ®ÂàÜ‰ΩøÁî®",
            en_US: "AI Partial",
        },

        tag_ai_tooltip: {
            zh_CN: "ÂÖ®ÈÉ®ÊàñÈÉ®ÂàÜ‰ΩøÁî®AIÁöÑ‰ΩúÂìÅ",
            zh_TW: "ÂÖ®ÈÉ®ÊàñÈÉ®ÂàÜ‰ΩøÁî®AIÁöÑ‰ΩúÂìÅ",
            en_US: "Full or partial use of AI",
        },

        button_save: {
            zh_CN: "‰øùÂ≠òËÆæÁΩÆ",
            zh_TW: "‰øùÂ≠òË®≠ÁΩÆ",
            en_US: "Save",
        },

        button_cancel: {
            zh_CN: "ÂèñÊ∂àËÆæÁΩÆ",
            zh_TW: "ÂèñÊ∂àË®≠ÁΩÆ",
            en_US: "Cancel",
        },

        button_reset: {
            zh_CN: "ÈáçÁΩÆËÆæÁΩÆ",
            zh_TW: "ÈáçÁΩÆË®≠ÁΩÆ",
            en_US: "Reset",
        },

        need_reorder: {
            zh_CN: "Ê£ÄÊµãÂà∞ËÆæÁΩÆÊõ¥Êñ∞ÔºåÂèØËÉΩÊ∑ªÂä†‰∫ÜÊñ∞ÁöÑ‰ø°ÊÅØ‰ΩçÔºåËØ∑ÈáçÊñ∞ËÆæÁΩÆÂØπÂ∫îËÆæÁΩÆÈ°πÁöÑÊéíÂàó",
            zh_TW: "Ê™¢Êü•Âà∞Ë®≠ÁΩÆÊõ¥Êñ∞ÔºåÂèØËÉΩÊ∑ªÂä†‰∫ÜÊñ∞ÁöÑ‰ø°ÊÅØ‰ΩçÔºåËØ∑ÈáçÊñ∞Ë®≠ÁΩÆÂ∞çÊáâË®≠ÁΩÆÈ†ÖÁöÑÊéíÂàó",
            en_US: "There is a new setting item added. Please reorder the corresponding setting item",
        },

        save_complete: {
            zh_CN: "ËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºåÈÉ®ÂàÜËÆæÁΩÆÈúÄË¶ÅÂà∑Êñ∞ÂØπÂ∫îÈ°µÈù¢‰ª•ÁîüÊïà",
            zh_TW: "Ë®≠ÁΩÆÂ∑≤‰øùÂ≠òÔºåÈÉ®ÂàÜË®≠ÁΩÆÈúÄË¶ÅÂà∑Êñ∞Â∞çÊáâÈ†ÅÈù¢‰ª•ÁîüÊïà",
            en_US: "Settings saved, some settings need to refresh the corresponding page to take effect",
        },

        save_failed: {
            zh_CN: "ËÆæÁΩÆ‰øùÂ≠òÂ§±Ë¥•",
            zh_TW: "Ë®≠ÁΩÆ‰øùÂ≠òÂ§±Êïó",
            en_US: "Settings save failed",
        },

        reset_confirm: {
            zh_CN: "Á°ÆÂÆöË¶ÅÂ∞ÜËÆæÁΩÆÈáçÁΩÆÂà∞ÊúÄÂàùÂßãÁöÑÁä∂ÊÄÅÂêóÔºüÔºàÈáçÁΩÆÂêéÔºåÈúÄË¶ÅÂÜçÁÇπÂáª‰øùÂ≠òÊâç‰ºöÁîüÊïàÔºâ",
            zh_TW: "Á¢∫ÂÆöË¶ÅÂ∞áË®≠ÁΩÆÈáçÁΩÆÂà∞ÊúÄÂàùÂßãÁöÑÁãÄÊÖãÂóéÔºüÔºàÈáçÁΩÆÂæåÔºåÈúÄË¶ÅÂÜçÈªûÊìä‰øùÂ≠òÊâçÊúÉÁîüÊïàÔºâ",
            en_US: "Are you sure you want to reset the settings to the initial state? (After resetting, you need to click Save to take effect)",
        },

        reset_complete: {
            zh_CN: "ËÆæÁΩÆÂ∑≤ÈáçÁΩÆ",
            zh_TW: "Ë®≠ÁΩÆÂ∑≤ÈáçÁΩÆ",
            en_US: "Settings reset",
        },

        reset_failed: {
            zh_CN: "ËÆæÁΩÆÈáçÁΩÆÂ§±Ë¥•",
            zh_TW: "Ë®≠ÁΩÆÈáçÁΩÆÂ§±Êïó",
            en_US: "Settings reset failed",
        },

        reset_order: {
            zh_CN: "ÈáçÁΩÆÈ°∫Â∫è",
            zh_TW: "ÈáçÁΩÆÈ†ÜÂ∫è",
            en_US: "Reset Order",
        },

        reset_order_confirm: {
            zh_CN: "Á°ÆÂÆöË¶ÅÂ∞ÜÂÖÉÁ¥†È°∫Â∫èÈáçÁΩÆÂà∞ÊúÄÂàùÂßãÁöÑÁä∂ÊÄÅÂêóÔºü",
            zh_TW: "Á¢∫ÂÆöË¶ÅÂ∞áÂÖÉÁ¥†È†ÜÂ∫èÈáçÁΩÆÂà∞ÊúÄÂàùÂßãÁöÑÁãÄÊÖãÂóéÔºü",
            en_US: "Are you sure you want to reset the element order to the initial state?",
        },

        reset_order_and_setting: {
            zh_CN: "ÈáçÁΩÆÂÖÉÁ¥†È°∫Â∫èÂíåÂêÑËá™ÁöÑËÆæÁΩÆÂÄº",
            zh_TW: "ÈáçÁΩÆÂÖÉÁ¥†È†ÜÂ∫èÂíåÂêÑËá™ÁöÑË®≠ÁΩÆÂÄº",
            en_US: "Reset element order and their settings",
        },

        hint_pin: {
            zh_CN: "Êåâ‰ΩèCTRL‰ª•Âõ∫ÂÆöÂºπÊ°ÜÔºåÂõ∫ÂÆöÊó∂ÂèØÂ§çÂà∂‰ø°ÊÅØ",
            zh_TW: "Êåâ‰ΩèCTRL‰ª•Âõ∫ÂÆöÂΩàÁ™óÔºåÂõ∫ÂÆöÊôÇÂèØË§áË£ΩË≥áË®ä",
            en_US: "Hold CTRL to pin the popup, info can be copied.",
        },

        hint_unpin: {
            zh_CN: "Êä¨Ëµ∑CTRL‰ª•ÂÖ≥Èó≠ÂºπÊ°Ü & Êü•ÁúãÂÖ∂ÂÆÉ‰ΩúÂìÅRJ‰ø°ÊÅØ",
            zh_TW: "Êä¨Ëµ∑CTRL‰ª•ÈóúÈñâÂΩàÁ™ó & Êü•ÁúãÂÖ∂ÂÆÉ‰ΩúÂìÅRJ‰ø°ÊÅØ",
            en_US: "Release CTRL to close the popup & view other works.",
        },

        hint_copy: {
            zh_CN: "Â∑¶ÈîÆÂçïÂáª‰ª•Â§çÂà∂‰ø°ÊÅØ",
            zh_TW: "Â∑¶ÈçµÂñÆÊìä‰ª•Ë§áË£ΩË≥áË®ä",
            en_US: "Left click to copy info.",
        },

        hint_copy_all: {
            zh_CN: "Â∑¶ÈîÆÂçïÂáª‰ª•Â§çÂà∂ÂÜÖÈÉ®ÊâÄÊúâ‰ø°ÊÅØ",
            zh_TW: "Â∑¶ÈçµÂñÆÊìä‰ª•Ë§áË£ΩÂÖßÈÉ®ÊâÄÊúâË≥áË®ä",
            en_US: "Left click to copy all contained info.",
        },

        hint_copy_work_title: {
            zh_CN: "ÂçïÂáªÂ§çÂà∂Ê†áÈ¢òÔºåAlt+ÂçïÂáªÂ§çÂà∂‰∏∫ÊúâÊïàÊñá‰ª∂Âêç",
            zh_TW: "ÂñÆÊìäË§áË£ΩÊ®ôÈ°åÔºåAlt+ÂñÆÊìäË§áË£ΩÁÇ∫ÊúâÊïàÊ™îÂêç",
            en_US: "Click to copy title, Alt+click to copy as valid filename.",
        },

        get: function (key, langKey = "_s_lang") {
            return typeof key === "string" ? localizationMap[key][settings[langKey]] : key[settings[langKey]];
        }
    }

    function localize(key) {
        return localizationMap.get(key);
    }

    function localizePopup(key) {
        return localizationMap.get(key, "_s_popup_lang");
    }
    //----------------------


    const RJ_REGEX = new RegExp("(R[JE][0-9]{8})|(R[JE][0-9]{6})|([VB]J[0-9]{8})|([VB]J[0-9]{6})", "gi");
    const URL_REGEX = new RegExp("dlsite.com/.*/product_id/((R[JE][0-9]{8})|(R[JE][0-9]{6})|([VB]J[0-9]{8})|([VB]J[0-9]{6}))", "g");
    const VOICELINK_CLASS = 'voicelink-' + Math.random().toString(36).slice(2);
    const VOICELINK_IGNORED_CLASS = `${VOICELINK_CLASS}_ignored`;
    const RJCODE_ATTRIBUTE = 'rjcode';
    const POPUP_CSS = `
    .${VOICELINK_CLASS}_voicepopup {
        min-width: 630px !important;
        z-index: 2147483646 !important;
        max-width: 80% !important;
        position: fixed !important;
        line-height: normal !important;  /*Âéü1.4em !important;*/
        font-size:1.1em!important;
        margin-bottom: 10px !important;
        box-shadow: 0 0 .125em 0 rgba(0,0,0,.5) !important;
        border-radius: 0.5em !important;
        background-color:#8080C0 !important;
        color:#F6F6F6 !important;
        text-align: left !important;
        padding: 10px !important;
        pointer-events: none !important;
    }
    
    .${VOICELINK_CLASS}_voicepopup[pin][mouse-in] *[copy-text] {
        text-decoration: underline !important;
        cursor: pointer !important;
    }
    .${VOICELINK_CLASS}_voicepopup[pin][mouse-in] *[copy-text]:active {
        opacity: 0.5 !important;
    }
    
    #${VOICELINK_CLASS}_info-container {
        font-size: 1em !important;
    }
    #${VOICELINK_CLASS}_info-container > div {
        margin-bottom: 3px !important;
        font-size: 1em !important;
    }
    #${VOICELINK_CLASS}_info-container > div > .info-title {
        margin-right: 5px !important;
    }
    #${VOICELINK_CLASS}_info-container > div > .info-title::after {
        content: ":" !important;
        text-decoration: none !important;
        display: inline-block !important;
    }
    #${VOICELINK_CLASS}_info-container .${VOICELINK_CLASS}_tags {
        margin-top: 12px !important;
        margin-bottom: 0 !important;
        font-size: 0.909091em !important;
    }
    
    .${VOICELINK_CLASS}_loader {
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        position: absolute !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        width: 100% !important;
        height: 100% !important;
        min-width: 300px !important;
        min-height: 30px !important;
        z-index: -1 !important;
    }
    .${VOICELINK_CLASS}_dot {
        width: 20px !important;
        height: 20px !important;
        margin: 0 8px !important;
        background-color: #fbfbfb !important;
        border-radius: 50% !important;
        animation: ${VOICELINK_CLASS}_scale 1s infinite !important;
    }
    .${VOICELINK_CLASS}_dot:nth-child(1) {
        animation-delay: 0s !important;
    }
    .${VOICELINK_CLASS}_dot:nth-child(2) {
        animation-delay: 0.2s !important;
    }
    .${VOICELINK_CLASS}_dot:nth-child(3) {
        animation-delay: 0.4s !important;
    }
    @keyframes ${VOICELINK_CLASS}_scale {
      0%, 100% {
          transform: scale(1);
      }
      50% {
          transform: scale(1.5);
      }
    }
    
    .${VOICELINK_CLASS}_voicepopup-maniax{
        background-color:#8080C0 !important;
    }
    
    .${VOICELINK_CLASS}_voicepopup-girls{
        background-color:#B33761 !important;
    }
    
    .${VOICELINK_CLASS}_voicepopup .${VOICELINK_CLASS}_left_panel{
        display: flex !important;
        flex-direction: column !important;
        justify-content: space-between !important;
        margin: 0 16px 0 0 !important;
        width: 310px !important;
        flex-shrink: 0 !important;
    }
    
    .${VOICELINK_CLASS}_voicepopup .${VOICELINK_CLASS}_img_container{
        width: 100% !important;
        padding: 3px !important;
    }

    .${VOICELINK_CLASS}_img_container img {
        width: 100% !important;
        height: auto !important;
    }
    
    #${VOICELINK_CLASS}_hint {
        font-size: 0.8em !important;
        opacity: 0.5 !important;
        max-width: 300px !important;
        margin-top: 5px !important;
    }
    
    .${VOICELINK_CLASS}_voicepopup a {
        text-decoration: none !important;
        color: pink !important;
    }
    
    .${VOICELINK_CLASS}_voicepopup .${VOICELINK_CLASS}_age-18{
        color: hsl(300deg 76% 77%) !important;
    }
    
    .${VOICELINK_CLASS}_voicepopup .${VOICELINK_CLASS}_age-all{
        color: hsl(157deg 82% 52%) !important;
    }

    .${VOICELINK_CLASS}_voice-title {
        font-size: 1.363636em !important;   /*Âéü1.4em*/
        font-weight: bold !important;
        text-align: center !important;
        margin: 5px 10px 0 0 !important;
        display: block !important;
    }

    .${VOICELINK_CLASS}_rjcode {
        text-align: center !important;
        margin: 5px 0 !important;
        font-size: 1.2012987em !important;  /*Âéü1.2em !important;*/
        font-style: italic !important;
        opacity: 0.3 !important;
    }

    .${VOICELINK_CLASS}_error {
        height: 210px !important;
        line-height: 210px !important;
        text-align: center !important;
    }

    .${VOICELINK_CLASS}_discord-dark {
        background-color: #36393f !important;
        color: #dcddde !important;
        font-size: 0.9375rem !important;
    }
    
    .${VOICELINK_CLASS}_work_title:hover #${VOICELINK_CLASS}_copy_btn {
        opacity: 1 !important;
    }
    
    #${VOICELINK_CLASS}_copy_btn {
        background: transparent !important;
        border-color: transparent !important;
        cursor: pointer !important;
        transition: all 0.3s !important;
        opacity: 0 !important;
        font-size: 0.75em !important;
        user-select: none !important;
        position: absolute !important;
    }
    
    #${VOICELINK_CLASS}_copy_btn:hover {
        scale: 1.2 !important;
    }
    
    #${VOICELINK_CLASS}_copy_btn:active {
        scale: 1.1 !important;
    }
    
  `
    const SETTINGS_CSS = `
        #${VOICELINK_CLASS}_settings-container {
            font-family: Arial, sans-serif !important;
            background-color: #f4f4f9 !important;
            margin: auto !important;
            padding: 20px 30px !important;
            line-height: unset !important;
            
            position: fixed !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            top: 20px !important;
            bottom: 20px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            box-sizing: border-box !important;
            max-width: 800px !important;
            width: 100% !important;
            height: calc(100% - 40px) !important;
            z-index: 2147483647 !important;
            border-radius: 20px !important;
            box-shadow: darkgray 0px 0px 17px 2px !important;
            
            /*scrollbar-width: none;*/
            /*-ms-overflow-style: none;*/
        }
        #${VOICELINK_CLASS}_settings-container::-webkit-scrollbar {
            width: 5px !important;
            height: 5px !important;
        }
        #${VOICELINK_CLASS}_settings-container::-webkit-scrollbar-track {
            background-color: #f4f4f9 !important;
            border-radius: 5px !important;
        }
        #${VOICELINK_CLASS}_settings-container::-webkit-scrollbar-thumb {
            background-color: #888 !important;
            border-radius: 5px !important; 
        }
        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_container {
            max-width: 800px !important;
            margin: auto !important;
            background: #fff !important;
            padding: 20px !important;
            border-radius: 10px !important;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1) !important;
        }
        #${VOICELINK_CLASS}_settings-container h1 {
            display: block !important;
            text-align: center !important;
            color: #333 !important;
            font-size: 32px !important;
            margin: 21.44px 0 !important;
            font-weight: bold !important;
            line-height: normal !important;
        }
        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_section-container {
            margin: 20px 0 !important;
        }
        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_section-container h2 {
            display: block !important;
            color: #007bff !important;
            font-size: 24px !important;
            margin: 22px 0 14px 0 !important;
            font-weight: bold !important;
            line-height: normal !important;
        }
        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_setting {
            /*display: flex;*/
            /*align-items: center;*/
            /*justify-content: space-between;*/
            margin: 10px 0 !important;
        }
        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_setting .${VOICELINK_CLASS}_row-title {
            margin: 0 0 0 10px !important;
            color: #555 !important;
            font-size: 18px !important;
            font-weight: normal !important;
            /*flex-grow: 1;*/
        }
        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_setting input[type="text"],
        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_setting input[type="password"],
        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_setting input[type="number"],
        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_setting input[type="email"],
        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_setting select {
            width: 100% !important;
            padding: 10px !important;
            border: 1px solid #ddd !important;
            border-radius: 5px !important;
            background: #fafafa !important;
            box-sizing: border-box !important;
            color: #666666FF !important;
            font-size: 13.3333px !important;
            height: unset !important;
            max-height: unset !important;
            max-width: unset !important;
            /*margin-bottom: 10px;*/
        }
        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_setting input[type="checkbox"] {
            display: none !important;
        }
        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_toggle-container {
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            justify-content: flex-end !important;
        }
        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_setting .${VOICELINK_CLASS}_toggle {
            display: inline-block !important;
            margin: 0 !important;
            width: 60px !important;
            height: 30px !important;
            padding: 0 !important;
            background: #ccc !important;
            border-radius: 15px !important;
            position: relative !important;
            cursor: pointer !important;
            transition: background 0.3s !important;
        }
        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_toggle:before {
            content: "" !important;
            display: block !important;
            width: 24px !important;
            height: 24px !important;
            background: #fff !important;
            border-radius: 50% !important;
            position: absolute !important;
            top: 3px !important;
            left: 3px !important;
            transition: transform 0.3s !important;
        }
        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_setting input[type="checkbox"]:checked + label {
            background: #007bff !important;
        }
        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_setting input[type="checkbox"]:checked + label:before {
            transform: translateX(30px) !important;
        }
        #${VOICELINK_CLASS}_button-close{
            position: absolute !important;
            top: 20px !important;
            right: 20px !important;
            font-size: 24px !important;
            cursor: pointer !important;
            background: rgba(0, 0, 0, 0.05) !important;
            border: none !important;
            width: 42px !important;
            height: 42px !important;
            border-radius: 50% !important;
        }
        #${VOICELINK_CLASS}_button-save,
        #${VOICELINK_CLASS}_button-cancel,
        #${VOICELINK_CLASS}_button-reset{
            display: block !important;
            width: 100% !important;
            padding: 10px !important;
            border: none !important;
            border-radius: 5px !important;
            background: #007bff !important;
            color: #fff !important;
            font-size: 16px !important;
            cursor: pointer !important;
            margin-top: 10px !important;

            transition: background 0.3s, filter 0.3s !important;
        }
        #${VOICELINK_CLASS}_button-reset{
            background: #999 !important;
        }
        #${VOICELINK_CLASS}_button-save:hover,
        #${VOICELINK_CLASS}_button-cancel:hover,
        #${VOICELINK_CLASS}_button-reset:hover{
            filter: brightness(1.3) !important;
        }
        #${VOICELINK_CLASS}_button-save:active,
        #${VOICELINK_CLASS}_button-cancel:active,
        #${VOICELINK_CLASS}_button-reset:active{
            filter: brightness(0.9) !important;
        }

        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_tooltip {
            position: relative !important;
        }
        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_tooltip .${VOICELINK_CLASS}_tooltip-text {
            visibility: hidden !important;
            min-width: 200px !important;
            max-width: 100% !important;
            background-color: #555 !important;
            color: #fff !important;
            font-size: 14px !important;
            text-align: center !important;
            border-radius: 5px !important;
            padding: 8px 10px !important;
            position: absolute !important;
            z-index: 1 !important;
            bottom: 125% !important;
            left: 0 !important;
            /*margin-left: -100px;*/
            opacity: 0 !important;
            filter: brightness(1.0) !important;
            transition: opacity 0.3s !important;
        }
        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_tooltip:hover .${VOICELINK_CLASS}_tooltip-text {
            visibility: visible !important;
            opacity: 1 !important;
        }
        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_sortable {
            cursor: move !important;
        }
        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_sortable span{
            cursor: default !important;
        }
        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_dragging{
            background-color: #1e82ff38 !important;
            user-select: none !important;
            transition: background-color 0.3s !important;
        }
        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_sortable .${VOICELINK_CLASS}_setting {
            cursor: move !important;
        }
        #${VOICELINK_CLASS}_settings-container table {
            width: 100% !important;
            margin-bottom: 20px !important;
            border-collapse: collapse !important;
            font-size: unset !important;
        }
        #${VOICELINK_CLASS}_settings-container table,
        #${VOICELINK_CLASS}_settings-container th,
        #${VOICELINK_CLASS}_settings-container td {
            border: 0 solid #ddd !important;
        }
        #${VOICELINK_CLASS}_settings-container th,
        #${VOICELINK_CLASS}_settings-container td {
            border-bottom: 1px dashed rgba(221, 221, 221, 0.64) !important;
            /*border-top: 1px solid #ddd;*/
            padding: 8px 10px !important;
            text-align: left !important;
            vertical-align: middle !important;
        }

        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_hidden{
            display: none !important;
        }
        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_input-cell{
            text-align: right !important;
            padding-right: 20px !important;
        }
        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_indent-1 > td {
            padding: 8px 24px !important;
        }
        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_indent-1 .${VOICELINK_CLASS}_input-cell {
            padding: 8px 20px !important;
        }

        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_tags {
            font-size: 14px;
        }
        .${VOICELINK_CLASS}_tags {
            display: flex !important;
            flex-wrap: wrap !important;
            justify-content: left !important;
            align-items: stretch !important;
        }
        .${VOICELINK_CLASS}_tags > label,
        .${VOICELINK_CLASS}_tags > span {
            border-radius: 5px !important;
            font-size: 1em !important;
            margin-right: 8px !important;
            margin-bottom: 8px !important;
            padding: 5px 8px !important;
            
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;

            transition: color 0.3s, background-color 0.3s !important;
        }
        .${VOICELINK_CLASS}_tags > label.${VOICELINK_CLASS}_tag_tight,
        .${VOICELINK_CLASS}_tags > span.${VOICELINK_CLASS}_tag_tight{
            padding: 2px 7px !important;
        }
        .${VOICELINK_CLASS}_tags > label.${VOICELINK_CLASS}_tag_small,
        .${VOICELINK_CLASS}_tags > span.${VOICELINK_CLASS}_tag_small{
            padding: 2px 7px !important;
            font-size: 0.857143em !important;
        }

        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_tag-off{
            background-color: #ffffff !important;
            color: #aaaaaa !important;
        }

        .${VOICELINK_CLASS}_tag-purple{
            background-color: #EED9F2 !important;
            color: #7B1FA2 !important;
        }

        .${VOICELINK_CLASS}_tag-blue{
            background-color: #d9eefc !important;
            color: #4285F4 !important;
        }

        .${VOICELINK_CLASS}_tag-red{
            background-color: #ffd6da !important;
            color: #EA4335 !important;
        }

        .${VOICELINK_CLASS}_tag-yellow{
            background-color: #FFF8E1 !important;
            color: #F57F17 !important;
        }

        .${VOICELINK_CLASS}_tag-green{
            background-color: #dcf5e4 !important;
            color: #34A853 !important;
        }

        .${VOICELINK_CLASS}_tag-teal{
            background-color: #d8eced !important;
            color: #0097A7 !important;
        }

        .${VOICELINK_CLASS}_tag-gray{
            background-color: #E0E0E0 !important;
            color: #424242 !important;
        }

        .${VOICELINK_CLASS}_tag-pink{
            background-color: #ffd9e7 !important;
            color: #f032a7 !important;
        }

        .${VOICELINK_CLASS}_tag-orange{
            background-color: #ffebcc !important;
            color: #f04000 !important;
        }

        .${VOICELINK_CLASS}_tag-darkblue{
            background-color: #d2e7fa !important;
            color: #0D47A1 !important;
        }

        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_reset-btn-small {
            position: relative !important;
            display: inline-block !important;
            width: 16px !important;
            height: 16px !important;
            margin-right: 4px !important;
            padding: 0 !important;
            color: transparent !important;
            background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAA6xJREFUeF7tmlFy2jAQhn+ZHIScJOEixYQ++BYJt/BDSU0vUnKSuvcoVkeq3RpXsndlScYAMzwwyLL20+rXarUCN/4RN24/7gDuHnDjBO5LYEoHSF+ytHjPiynHMJkHrLfZVwApgOKwzzdTQZgEQMv4xu7JIEQHYDB+UghRAfQYDyGwKr7kx9hLIRqASzRewY4C4FKNjwKgz3gAZesLIfGhBhVzawzqAQPG9y13DUZIHFDhWBS5+h3kEwxA+jl7lhLfPYxaGX8UJ+xCgAgHIM2WVYK1EHjzAEF1UUqJ4tt7vvPUn+4mGADVeeofggYhTlj58oagAAgQSiGwwS+UeMASFZZS4KkOkXs1wpc3BAdAgmCYUeU9coHXPhhS4m3skogCwBVC85xcQB2cnk0uMRZCNAAECMfDPl+ZjBzQEr2MXMPoqAB6IJSHff44pO6fXrJXy67iLIzRARggkIxv4KgkihR6SXQ/rH6ahycB0IbgImI2TxASG24YPRmAIXcf+t8Cge0FswVQb5Mq1F62YXG9YLYA9DIy6wHLC+YN4E+w9F+MwMkuzRqA8gKTFnCCo9kDqLXgR0c0rUFVV1xnD0AZtN5mSgzPQuXDPifZRmo0tCVN/b8JgDjhkXJkvhYAzS3T37mgCuFVADAJoVcASmiQdI6jgZOVnGVligeoARHJA0wJTs5WwzHGpa3RA4jngqsAYEq/exXBsXuty6xyngkOoN5rZWdQrJibYxC37XqbqUDo7FDkPQ4w7rUT3eh2Aa23WXdy4B3A2JibO6vU9pYTIbnggiSCTQZHLuAcc1MN4rYbEwWqd5EB2GJuasDBNYzS3pYfpLo/G4CPBATFMGobk/hx4xOWB1i2Q3BfSjWwr50tMcqZfbYHaC2wpKGExI6bkXUFYbt6p4a/7feyPKAlhqarqlE3NFQYNi9Ut8aUy5Xue9gANAR78YPzDQ0FQF/RhasYOwFQg+27pvJ1dd2G0ms88eBjguwMYACCFsakwoGSlembfUKRBTn/5x0AYXDOZS2EvpU9o4x32gW6FIkD/Vf1laC0XWW3+lIJTmM9QPN+X1vvqCXQhtGjCTYPb5e+nZ3khgTRVfC8LwGTNwyVtQwZN/C/KpfbjNWVUXEAxYB6r7aWtVD66LQJFmN4WwImo+qokVL1ZXpcC2gC/AwZYQYF0Fils8oPWFYVnoTQmZv2t9ECLZRSokwSfLjW/HC9KwoA7qBitr8DiEn7Et9194BLnJWYY7p5D/gNXP0HX03p5E0AAAAASUVORK5CYII=") !important;
            background-position: center !important;
            background-size: contain !important;
            background-color: transparent !important;
            border-radius: 3px !important;
            border: none !important;
            opacity: 0.5 !important;
        }
        #${VOICELINK_CLASS}_settings-container button.${VOICELINK_CLASS}_reset-btn-small:hover {
            opacity: 1 !important;
        }

        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_button-flat {
            background-color: transparent !important;
            border: none !important;
            color: #aaa !important;
            cursor: pointer !important;
            border-radius: 5px !important;
            padding: 5px 5px !important;
            margin-bottom: 6px !important;
            margin-right: 6px !important;

            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;

            transition: background-color 0.3s !important;
        }
        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_button-flat:hover {
            background-color: rgba(0, 0, 0, 0.1) !important;
        }
        #${VOICELINK_CLASS}_settings-container .${VOICELINK_CLASS}_button-flat span{
            display: inline-block !important;
        }
    `

    /**
     * Work promise cache
     * @type {{info:{}, api:{}, api2: {}, circle: {}}}
     */
    const work_promise = {};

    function getAdditionalPopupClasses() {
        const hostname = document.location.hostname;
        switch (hostname) {
            case "boards.4chan.org": return "post reply";
            case "discordapp.com": return `${VOICELINK_CLASS}_discord-dark`;
            default: return null;
        }
    }

    function getOS() {
        const userAgent = navigator.userAgent;
        if (userAgent.indexOf("Windows NT 10.0") !== -1) return "Windows 10";
        if (userAgent.indexOf("Windows NT 6.2") !== -1) return "Windows 8";
        if (userAgent.indexOf("Windows NT 6.1") !== -1) return "Windows 7";
        if (userAgent.indexOf("Windows NT 6.0") !== -1) return "Windows Vista";
        if (userAgent.indexOf("Windows NT 5.1") !== -1) return "Windows XP";
        if (userAgent.indexOf("Windows NT 5.0") !== -1) return "Windows 2000";
        if (userAgent.indexOf("Mac") !== -1) return "Mac";
        if (userAgent.indexOf("X11") !== -1) return "UNIX";
        if (userAgent.indexOf("Linux") !== -1) return "Linux";
        return "Other";
    }

    function getVoiceLinkTarget(target){
        while (target && !target.classList.contains(VOICELINK_CLASS)){
            target = target.parentElement;
        }
        return target;
    }

    function isInDLSite(){
        return document.location.hostname.endsWith("dlsite.com");
    }

    /**
     * Convert to valid file name.
     * @param {String} original
     */
    function convertToValidFileName(original){
        const charMapRegs = {
            "\\/": "Ôºè",
            "\\\\": "Ôºº",
            "\\:": "Ôºö",
            "\\*": "Ôºä",
            "\\?": "Ôºü",
            "\"": "ÔºÇ",
            "\\<": "Ôºú",
            "\\>": "Ôºû",
            "\\|": "ÔΩú"
        }

        let fileName = original;
        for (let key in charMapRegs){
            fileName = fileName.replaceAll(new RegExp(key, "g"), charMapRegs[key]);
        }
        return fileName;
    }

    function setUserSelectTitle(){
        // Make title selectable
        const hostname = document.location.hostname;
        if(!hostname.endsWith("dlsite.com")){
            return;
        }
        const rjList = document.URL.match(RJ_REGEX)
        const rj = rjList[rjList.length - 1]

        const title = document.getElementById("work_name");
        if(!title){
            return;
        }
        let titleStr = title.innerText;
        let titleHtml = title.innerHTML;

        const button = document.createElement("button");
        button.id = `${VOICELINK_CLASS}_copy_btn`;
        button.innerText = "üìÉ";
        button.addEventListener("mouseenter", function(){
            button.innerText = "üìÉ Â§çÂà∂‰∏∫ÊúâÊïàÊñá‰ª∂Âêç";
        });
        button.addEventListener("mouseleave", function(){
            button.innerText = "üìÉ";
        });
        button.addEventListener("click", function(){
            const fileName = convertToValidFileName(titleStr);
            // const promise = navigator.clipboard.writeText(fileName);
            const promise = GM_setClipboard(fileName, "text");
            promise?.then(() => {
                button.innerText = "‚úî Â§çÂà∂ÊàêÂäü";
            });
            promise?.catch(e => {
                window.prompt("Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂", fileName);
                button.innerText = "üìÉ";
            });
        });

        title.style.setProperty("user-select", "text", "important");  //userSelect = "text !important";
        title.classList.add(`${VOICELINK_CLASS}_work_title`);

        if(settings._s_show_translated_title_in_dl){
            //Â∞ÜTitleÊõøÊç¢ÊàêÂ§ßÂÆ∂ÁøªÂØπÂ∫îÁöÑËØ≠Ë®ÄÁøªËØëÁâàÊú¨
            WorkPromise.getTranslationInfo(rj).then(info => {
                if(info.is_original) {
                    return null;
                }
                else{
                    return WorkPromise.getWorkTitle(rj);
                }
            }).then(t => {
                if(!t){
                    if(settings._s_copy_as_filename_btn) title.appendChild(button);
                    return;
                }
                compatibilityCheck(title, titleHtml);
                titleStr = t
                title.innerText = t
                if(settings._s_copy_as_filename_btn) title.appendChild(button);
            })
        }else{
            if(settings._s_copy_as_filename_btn) title.appendChild(button);
        }
    }

    function compatibilityCheck(titleElement, titleHtml){
        if(!settings._s_show_compatibility_warning) return;

        if(titleElement.innerHTML.trim() === titleHtml.trim()){
            return;
        }

        //ÂÖ∂ÂÆÉËÑöÊú¨‰øÆÊîπ‰∫ÜÊ†áÈ¢òÂÜÖÈÉ®ÔºåËøõË°åË≠¶Âëä
        window.alert("Ë≠¶ÂëäÔºö\n" +
            "VoiceLinksÊ£ÄÊµãÂà∞DL‰ΩúÂìÅÊ†áÈ¢òÂÖÉÁ¥†ÂèëÁîüÂèòÂåñÔºåËØ•ÂèòÂåñÂèØËÉΩÊòØËÑöÊú¨‰∏éÂÖ∂ÂÆÉÊèí‰ª∂ÂÜ≤Á™ÅÂØºËá¥ÁöÑ„ÄÇ\n" +
            "ÂèØ‰ª•ÂÖ≥Èó≠Êú¨ËÑöÊú¨‰∏≠ÁöÑ ‚ÄúÂú®DLSiteÊòæÁ§∫ÂØπÂ∫îËØ≠Ë®ÄÁöÑÁøªËØëÊ†áÈ¢ò‚Äù ËÆæÁΩÆÈ°πÔºå‰ª•Â∞ùËØïËß£ÂÜ≥ÂÜ≤Á™Å„ÄÇÔºà‰πüÂèØÊ†πÊçÆÊÉÖÂÜµÈÖåÊÉÖÂÖ≥Èó≠ ‚ÄúÂú®DL‰ΩúÂìÅÊ†áÈ¢òÊóÅÊ∑ªÂä†Â§çÂà∂‰∏∫Êñá‰ª∂ÂêçÊåâÈíÆ‚Äù ÈÄâÈ°πÔºâ\n\n" +
            "Êú¨ËÑöÊú¨ÁöÑËÆæÁΩÆÊñπÊ≥ïÔºöÁÇπÂáªTampermonkeyÁ≠âÊâ©Â±ïÁ®ãÂ∫èÁöÑÊåâÈíÆÔºåÂú®ÂºπÂá∫ÁöÑËÑöÊú¨ÂàóË°®‰∏≠ÊâæÂà∞ÂΩìÂâçËÑöÊú¨ÔºåÁÇπÂáª‰∏ãÊñπÁöÑSettingsÊåâÈíÆÂç≥ÂèØÊâìÂºÄËÆæÁΩÆÈ°µÈù¢„ÄÇ\n\n" +
            "Ê≥®ÊÑèÔºöÂ¶ÇÊûú‰∏çÊÉ≥ÁúãÂà∞ËØ•Ë≠¶ÂëäÔºåÂèØ‰ª•ÂêåÊó∂ÂÖ≥Èó≠‚ÄúÊòæÁ§∫ÂÖºÂÆπÊÄßË≠¶Âëä‚ÄùËÆæÁΩÆÈ°π„ÄÇ")
    }

    function getXmlHttpRequest() {
        return (typeof GM !== "undefined" && GM !== null ? GM.xmlHttpRequest : GM_xmlhttpRequest);
    }

    const Parser = {
        walkNodes: function (elem) {
            const rjNodeTreeWalker = document.createTreeWalker(
                elem,
                NodeFilter.SHOW_ELEMENT | NodeFilter.SHOW_TEXT,
                {
                    acceptNode: function (node) {
                        if(node.nodeName === "SCRIPT" || node.parentElement && node.parentElement.nodeName === "SCRIPT"){
                            return NodeFilter.FILTER_REJECT;
                        }

                        if(node.parentElement.isContentEditable){
                            return NodeFilter.FILTER_SKIP;
                        }

                        if(settings._s_parse_url && node.nodeName === "A"){
                            if(!settings._s_parse_url_in_dl && document.location.hostname.endsWith("dlsite.com")){
                                return NodeFilter.FILTER_SKIP;
                            }

                            let href = node.href;
                            if(href.match(URL_REGEX) && !node.classList.contains(VOICELINK_IGNORED_CLASS)){
                                return NodeFilter.FILTER_ACCEPT;
                            }
                        }

                        if (node.nodeName !== "#text") return NodeFilter.FILTER_SKIP;
                        if(node.parentElement.classList.contains(VOICELINK_IGNORED_CLASS)
                            || node.parentElement.hasAttribute(RJCODE_ATTRIBUTE)){
                            return NodeFilter.FILTER_SKIP;
                        }

                        if (node.parentElement.classList.contains(VOICELINK_CLASS))
                            return NodeFilter.FILTER_ACCEPT;
                        if (node.nodeValue.match(RJ_REGEX))
                            return NodeFilter.FILTER_ACCEPT;

                        return NodeFilter.FILTER_SKIP;
                    }
                },
                false,
            );
            while (rjNodeTreeWalker.nextNode()) {
                const node = rjNodeTreeWalker.currentNode;

                //Ignore Element which let user input (textarea), input can be ignored because it's not a text node.
                if(node.parentElement.nodeName === "TEXTAREA"){
                    continue;
                }

                if (node.parentElement.classList.contains(VOICELINK_CLASS)) {
                    Parser.rebindEvents(node.parentElement);
                }else if(node.nodeName === "A") {
                    // alert("ÂáÜÂ§áËß£ÊûêÈìæÊé•Ôºö" + node.nodeValue)
                    Parser.linkifyURL(node);
                }else{
                    // alert("ÂáÜÂ§áËß£ÊûêÊñáÊú¨Ôºö" + node.nodeValue)
                    Parser.linkify(node);
                }
            }
        },

        wrapPlaceholder: function (content) {
            let e;
            e = document.createElement("span");
            e.classList = VOICELINK_CLASS;
            e.innerText = content;
            e.classList.add(VOICELINK_IGNORED_CLASS);
            e.setAttribute(RJCODE_ATTRIBUTE, "");
            return e;
        },

        wrapRJCode: function (rjCode) {
            let e;
            e = document.createElement("a");
            e.classList = VOICELINK_CLASS;
            e.href = `https://www.dlsite.com/maniax/work/=/product_id/${rjCode.toUpperCase()}.html`
            e.innerText = rjCode;
            e.target = "_blank";
            e.rel = "noreferrer";
            e.classList.add(VOICELINK_IGNORED_CLASS);
            e.style.setProperty("display", "inline", "important");  //display = "inline !important";

            e.setAttribute(RJCODE_ATTRIBUTE, rjCode.toUpperCase());
            e.setAttribute("voicelink-linkified", "true");
            e.addEventListener("mouseover", Popup.over);
            e.addEventListener("mouseout", Popup.out);
            e.addEventListener("mousemove", Popup.move);
            e.addEventListener("keydown", Popup.keydown);
            //e.addEventListener("keyup", Popup.keyup);
            return e;
        },

        calculateCoverage: function(text){
            const matches = text.match(RJ_REGEX);
            if (!matches) return 0;
            //Ë¶ÜÁõñÂ§ßÂ∞è = ÊâÄÊúâÂåπÈÖçÈ°πÁöÑÈïøÂ∫¶ÊÄªÂíå
            const coverSize = matches.reduce((total, current) => total + current.length, 0);
            return (coverSize / text.length) * 100;
        },

        /***
         * Â§ÑÁêÜÁõ¥Èìæ
         * @param {Node} node
         ***/
        linkifyURL: function(node) {
            const e = node;
            const href = e.href;
            const rjs = href.match(RJ_REGEX);
            const rj = rjs[rjs.length - 1];
            if(!rj) return;

            // alert(`Ëß£ÊûêÈìæÊé•Ôºö${e.nodeValue}`)

            e.classList.add(VOICELINK_CLASS);
            e.setAttribute(RJCODE_ATTRIBUTE, rj.toUpperCase());
            e.addEventListener("mouseover", Popup.over);
            e.addEventListener("mouseout", Popup.out);
            e.addEventListener("mousemove", Popup.move);
            e.addEventListener("keydown", Popup.keydown);
            //e.addEventListener("keyup", Popup.keyup);
        },

        linkify: function (textNode) {
            const nodeOriginalText = textNode.nodeValue;
            const matches = [];

            let insert = settings._s_url_insert_mode;
            let tagA = textNode.parentElement.closest("a");
            let tagB = textNode.parentElement.closest("button");
            let tag = tagA ? tagA : tagB;
            if((!tagA && !tagB) || insert.trim() !== "none" && this.calculateCoverage(tag.innerText) < 71){
                insert = "none";
            }

            let match;
            while (match = RJ_REGEX.exec(nodeOriginalText)) {
                matches.push({
                    index: match.index,
                    value: match[0],
                });
            }
            if(matches.length === 0) return;

            // alert(`Ëß£ÊûêÊñáÊú¨Ôºö${textNode.nodeValue}`)

            // Keep text in text node until first RJ code
            textNode.nodeValue = nodeOriginalText.substring(0, matches[0].index);
            if(insert.startsWith("prefix")){
                //Âä†ÂâçÁºÄ
                textNode.nodeValue = `${settings._s_url_insert_text}${textNode.nodeValue}`
            }

            // Insert rest of text while linkifying RJ codes
            let prevNode = null;
            for (let i = 0; i < matches.length; ++i) {
                // Insert linkified RJ code
                let code = matches[i].value
                let rjLinkNode = Parser.wrapRJCode(code);
                //‰øùËØÅÂêéÁª≠Ê∏∏Ëµ∞Êó∂ÂøΩÁï•ÂΩìÂâçËäÇÁÇπ
                if(insert.startsWith("before_rj")){
                    //Áî®ÂØºÂêëÊñáÊú¨Êõø‰ª£RJÂè∑ÈìæÊé•ÔºåRJÂè∑‰øùÁïôÂà∞ÂêéÈù¢ÁöÑÊñáÊú¨Èáå‰∏çÂèò
                    rjLinkNode.innerText = settings._s_url_insert_text;
                    textNode.parentNode.insertBefore(
                        rjLinkNode,
                        prevNode ? prevNode.nextSibling : textNode.nextSibling,
                    );
                    prevNode = rjLinkNode;
                    rjLinkNode = Parser.wrapPlaceholder(code);
                }
                textNode.parentNode.insertBefore(
                    rjLinkNode,
                    prevNode ? prevNode.nextSibling : textNode.nextSibling,
                );

                // Insert text after if there is any
                //ÊâæÂà∞ÂΩìÂâçRJÂíå‰∏ã‰∏Ä‰∏™RJ‰πãÈó¥ÁöÑÂ≠óÁ¨¶‰∏≤
                let nextRJ = undefined;
                if (i < matches.length - 1) {
                    nextRJ = matches[i + 1].index;
                }
                let substring = nodeOriginalText.substring(matches[i].index + matches[i].value.length, nextRJ);

                if (substring) {
                    const subtextNode = document.createTextNode(substring);
                    textNode.parentNode.insertBefore(
                        subtextNode,
                        rjLinkNode.nextElementSibling,
                    );
                    prevNode = subtextNode;
                }
                else {
                    prevNode = rjLinkNode;
                }
            }
        },

        rebindEvents: function (elem) {
            if (elem.nodeName === "A") {
                elem.addEventListener("mouseover", Popup.over);
                elem.addEventListener("mouseout", Popup.out);
                elem.addEventListener("mousemove", Popup.move);
                elem.addEventListener("keydown", Popup.keydown);
                //elem.addEventListener("keyup", Popup.keyup);
            }
            else {
                const voicelinks = elem.querySelectorAll("." + VOICELINK_CLASS);
                for (let i = 0, j = voicelinks.length; i < j; i++) {
                    const voicelink = voicelinks[i];
                    voicelink.addEventListener("mouseover", Popup.over);
                    voicelink.addEventListener("mouseout", Popup.out);
                    voicelink.addEventListener("mousemove", Popup.move);
                    voicelink.addEventListener("keydown", Popup.keydown);
                    //voicelink.addEventListener("keyup", Popup.keyup);
                }
            }
        },

    }

    const DateParser = {
        parseDateStr: function(dateStr, lang){
            dateStr = dateStr.trim().replace(/ /g, "");
            lang = lang.trim().toLowerCase().replace(/_/g, "-");
            let nums = this.parseNumbers(dateStr);
            if(!nums || nums.length < 3 && lang !== "en-us" || nums.length < 2 && lang === "en-us"){
                //Êï∞Â≠ó‰∏çÂ§üÔºåÊó†Ê≥ïËß£Êûê
                return null;
            }

            let parsers = [
                this.parseAsiaDateStr,
                this.parseEnglishDateStr,
                this.parseEuropeanDateStr,
                this.parseSpanishDateStr
            ]
            let date = null;
            for (let i = 0; i < parsers.length; i++){
                date = parsers[i](dateStr, nums, lang);
                if(date){
                    break;
                }
            }

            return date;
        },
        parseNumbers: function (dateStr){
            let nums = dateStr.match(/\d+/g);
            if(!nums) return null;

            for (let i = 0; i < nums.length; i++) {
                nums[i] = Number(nums[i]);
            }
            return nums;
        },
        parseAsiaDateStr: function(dateStr, nums, lang){
            //2024Âπ¥10Êúà05Êó•
            //2024ÎÖÑ 10Ïõî 05ÏùºÔºàÂ∑≤ÂéªÈô§Á©∫Ê†ºÔºâ
            if (!dateStr.match(/\d{4}Âπ¥\d{1,2}Êúà\d{1,2}Êó•/)
                && !dateStr.match(/\d{4}ÎÖÑ\d{1,2}Ïõî\d{1,2}Ïùº/)) {
                return null;
            }
            return new Date(nums[0], nums[1] - 1, nums[2]);
        },
        parseEnglishDateStr: function(dateStr, nums, lang){
            //Oct/05/2024
            if(!dateStr.match(/[a-zA-Z]{3}\/\d{1,2}\/\d{4}/)){
                return null;
            }
            const monthMap = {
                "Jan": 0, "Feb": 1, "Mar": 2,
                "Apr": 3, "May": 4, "Jun": 5,
                "Jul": 6, "Aug": 7, "Sep": 8,
                "Oct": 9, "Nov": 10, "Dec": 11
            }
            let monthStr = dateStr.substring(0, dateStr.indexOf("/")).toLowerCase();
            monthStr = monthStr[0].toUpperCase() + monthStr.substring(1);
            return new Date(nums[1], monthMap[monthStr], nums[0])
        },
        parseSpanishDateStr: function (dateStr, nums, lang) {
            //10/05/2024
            if(lang !== "es-es" || !dateStr.match(/\d{1,2}\/\d{1,2}\/\d{4}/)){
                return null;
            }
            return new Date(nums[2], nums[0] - 1, nums[1]);
        },
        parseEuropeanDateStr: function (dateStr, nums, lang) {
            //05/10/2024
            if(lang === "es-es" || !dateStr.match(/\d{1,2}\/\d{1,2}\/\d{4}/)){
                return null;
            }
            return new Date(nums[2], nums[1] - 1, nums[0]);
        },
        /***
         Ëé∑ÂæóÂ∏¶ÂÄíËÆ°Êó∂ÁöÑÊñáÊú¨HTML
         @param date {Date}
         ***/
        getCountDownDateElement: function(date){
            if(!date) return "";

            const today = new Date();
            today.setHours(0);
            today.setMinutes(0);
            today.setSeconds(0);
            today.setMilliseconds(0);
            date.setHours(0);
            date.setMinutes(0);
            date.setSeconds(0);
            date.setMilliseconds(0);

            if(date.getTime() < today.getTime()) return "";
            let days = (date.getTime() - today.getTime()) / (1000 * 60 * 60 * 24);
            let element = document.createElement("span");
            element.innerText = `(Coming in ${days} day${(days > 1 ? "s" : "")})`;
            element.style.setProperty("color", "#ffeb3b", "important");
            element.style.setProperty("font-style", "italic", "important");
            return element;
            //return `<span style="color:#ffeb3b !important; font-size: 16px !important; font-style: italic !important; margin-left: 16px !important"></span>`
        },
    }

    const Popup = {
        popupElement: {
            popup: null,
            not_found: null,
            left_panel: null,
            img: {container: null},
            right_panel: null,
            title: null,
            rj_code: null,
            info_container: null,
            loader: null,
            flag: null,
            tags: null,
            dl_count: null,
            circle_name: null,
            debug: null,
            translator_name: null,
            release_date: null,
            update_date: null,
            age_rating: null,
            scenario: null,
            illustration: null,
            voice_actor: null,
            music: null,
            genre: null,
            file_size: null,

            _state: {
                mouseX: 0,
                mouseY: 0
            }
        },

        makePopup: function (display) {
            const popup = document.createElement("div");
            const ele = Popup.popupElement;
            ele.popup = popup;

            popup.className = `${VOICELINK_CLASS}_voicepopup ${VOICELINK_CLASS}_voicepopup-maniax ` + (getAdditionalPopupClasses() || '');
            popup.id = `${VOICELINK_CLASS}-voice-popup`;  // + rjCode;
            popup.style.setProperty("display", display === false ? "none" : "flex", "important");  //display = display === false ? "none" : "flex";
            document.body.appendChild(popup);

            popup.addEventListener("mouseenter", () => {
                popup.setAttribute("mouse-in", "");
            });
            popup.addEventListener("mouseleave", () => {
                popup.removeAttribute("mouse-in");
            })

            const notFoundElement = document.createElement("div");
            ele.not_found = notFoundElement;
            //Âç†Êª°Êï¥‰∏™popup
            //"display: none; width: 100%; height: 100%";
            notFoundElement.style.setProperty("display", "none", "important");
            notFoundElement.style.setProperty("width", "100%", "important");
            notFoundElement.style.setProperty("height", "100%", "important");
            notFoundElement.innerText = "Work Not Found.";
            popup.appendChild(notFoundElement);

            const leftPanel = document.createElement("div");
            leftPanel.classList.add(`${VOICELINK_CLASS}_left_panel`);
            popup.appendChild(leftPanel);
            ele.left_panel = leftPanel;

            const imgContainer = document.createElement("div")
            imgContainer.classList.add(`${VOICELINK_CLASS}_img_container`);
            ele.img.container = imgContainer;
            leftPanel.appendChild(imgContainer);

            //Â∑¶‰∏ãËßíÊèêÁ§∫Áä∂ÊÄÅÊ†è
            ele.hint = document.createElement("div");
            leftPanel.appendChild(ele.hint);
            ele.hint.id = `${VOICELINK_CLASS}_hint`;

            const rightPanel = document.createElement("div");
            ele.right_panel = rightPanel;

            const titleElement = Popup.createCopyTag("div", "", false, localizePopup(localizationMap.hint_copy_work_title));
            ele.title = titleElement;
            titleElement.classList.add(`${VOICELINK_CLASS}_voice-title`);
            rightPanel.appendChild(titleElement);

            const rjCodeElement = document.createElement("div");
            ele.rj_code = rjCodeElement;
            rjCodeElement.classList.add(`${VOICELINK_CLASS}_rjcode`);
            rightPanel.appendChild(rjCodeElement);

            const infoContainer = document.createElement("div");
            ele.info_container = infoContainer;
            infoContainer.id = `${VOICELINK_CLASS}_info-container`;
            infoContainer.style.setProperty("position", "relative", "important");  //position = "relative !important";
            infoContainer.style.setProperty("min-height", "70px", "important");  //minHeight = "70px !important";
            rightPanel.appendChild(infoContainer);

            const loader = document.createElement("div");
            loader.className = `${VOICELINK_CLASS}_loader`;
            loader.innerHTML = Csp.createHTML(`
            <div class="${VOICELINK_CLASS}_dot"></div>
            <div class="${VOICELINK_CLASS}_dot"></div>
            <div class="${VOICELINK_CLASS}_dot"></div>
            `);
            ele.loader = loader;
            infoContainer.appendChild(loader);

            ele.tags = document.createElement("div");
            infoContainer.appendChild(ele.tags);

            ele.dl_count = document.createElement("div");
            ele.circle_name = document.createElement("div");
            ele.debug = document.createElement("div");
            ele.translator_name = document.createElement("div");
            ele.release_date = document.createElement("div");
            ele.update_date = document.createElement("div");
            ele.age_rating = document.createElement("div");
            ele.scenario = document.createElement("div");
            ele.illustration = document.createElement("div");
            ele.voice_actor = document.createElement("div");
            ele.music = document.createElement("div");
            ele.genre = document.createElement("div");
            ele.file_size = document.createElement("div");

            rightPanel.style.setProperty("padding-bottom", "3px", "important");  //paddingBottom = "3px !important";
            rightPanel.style.setProperty("flex-grow", "1", "important");  //flexGrow = "1 !important";
            popup.appendChild(rightPanel);
            popup.insertBefore(leftPanel, popup.childNodes[0]);
        },

        updatePopup: function(e, rjCode, isParent=false) {
            const ele = Popup.popupElement;
            const popup = ele.popup;
            popup.className = `${VOICELINK_CLASS}_voicepopup ${VOICELINK_CLASS}_voicepopup-maniax ` + (getAdditionalPopupClasses() || '');
            // popup.id = "voice-" + rjCode;
            popup.style.setProperty("display", "flex", "important");  //= "display: flex";
            popup.setAttribute(RJCODE_ATTRIBUTE, rjCode);

            //------Ê£ÄÊü•‰ΩúÂìÅÂ≠òÂú®ÊÉÖÂÜµ------
            let workFound = true;
            Popup.setFoundState(true);
            WorkPromise.getFound(rjCode).then(async found => {
                if(rjCode !== popup.getAttribute(RJCODE_ATTRIBUTE)) return;

                if(found){
                    //ÊâæÂà∞ÂàôÁõ¥Êé•ËøîÂõû‰∫§Áªô‰∏ã‰∏ÄÁ∫ßÂ§ÑÁêÜ
                    return {found: true, parentRJ: rjCode};
                }

                //Ê≤°ÊâæÂà∞ÂàôÂ∞ùËØïÊâæÂà∞Áà∂‰ΩúÂìÅÁöÑRJÂè∑ÔºåÂ°´Ë°•Â≠ê‰ΩúÂìÅ‰ø°ÊÅØÁöÑÁº∫Â§±
                let parentRJ = await WorkPromise.getParentRJ(rjCode);
                if(parentRJ === rjCode || !parentRJ) {
                    return {found: false, parentRJ: rjCode};
                }
                found = await WorkPromise.getFound(parentRJ);
                return {found: found, parentRJ: parentRJ};

            }).then((state) => {
                if(rjCode !== popup.getAttribute(RJCODE_ATTRIBUTE)) return;

                const found = state.found;
                const rj = state.parentRJ;
                if(found && rj !== rjCode){
                    //Â¶ÇÊûúÊâæÂà∞‰∫ÜÁà∂‰ΩúÂìÅÁöÑ‰ø°ÊÅØ‰ΩÜÂ≠ê‰ΩúÂìÅÊâæ‰∏çÂà∞ÔºåÂ∞±ÈáçÊñ∞update
                    Popup.updatePopup(e, rj, true);
                    return;
                }

                ele.not_found.style.setProperty("display", found ? "none" : "block", "important");  //display = found ? "none" : "block";
                Popup.setFoundState(found);
                workFound = found;
            });

            //------Ê£ÄÊü•ÊòØÂê¶‰∏∫Â•≥ÊÄßÂêë------
            WorkPromise.getGirls(rjCode).then(isGirls => {
                if(rjCode !== popup.getAttribute(RJCODE_ATTRIBUTE)) return;
                if(isGirls) popup.className += (` ${VOICELINK_CLASS}_voicepopup-girls`)
            }).catch(e => {});

            //------Ëé∑Âèñ‰ΩúÂìÅÂ∞ÅÈù¢------
            const imgContainer = ele.img.container;

            //NSFWÊ®°Á≥äÁ≠âÁ∫ß
            const blur_map = {
                low: "6px",
                medium: "12px",
                high: "24px"
            };

            //ÂÖàÂØπContainerÂÜÖÁöÑÊâÄÊúâimgËøõË°åÈöêËóè
            for (let i = 0; i < imgContainer.childNodes.length; ++i) {
                imgContainer.childNodes[i].style.setProperty("display", "none", "important");  //display = "none !important";
            }

            //NOTE: Ê≥®ÊÑèËøôÈáåÂèØËÉΩÂõ†‰∏∫Âø´ÈÄüÁöÑÂ§öÊ¨°Ëé∑ÂèñÂØºËá¥ÂêåÊó∂Âä†ËΩΩ‰∏§‰∏™ÂõæÁâáÔºåÂèØ‰ΩøÁî®Âç†‰ΩçÁ¨¶Êù•È¢ÑÂÖàÂç†Áî®ÂõæÁâá‰ΩçÁΩÆ
            new Promise((resolve, reject) => {
                let img = ele.img[rjCode];
                if(img) resolve(img);
                else throw Error("È¶ñÊ¨°Âä†ËΩΩÂõæÁâá");
            }).catch(_ => {
                //È¶ñÊ¨°Âä†ËΩΩÂõæÁâáÔºåÂØπÂõæÁâáÊ∑ªÂä†Âç†‰Ωç
                ele.img[rjCode] = 1;
                return WorkPromise.getImgLink(rjCode);
            }).then(link => {
                if(typeof link !== "string"){
                    //ÂõæÁâáÂ∑≤ÁªèÂä†ËΩΩËøáÔºå‰º†ÈÄíÁöÑÊòØimgÔºå‰∏çÈÄöËøáÂΩìÂâçthen
                    return link;  //ÂÆûÈôÖ‰∏äÊòØimg
                }

                if(rjCode !== popup.getAttribute(RJCODE_ATTRIBUTE)) {
                    //Ê∏ÖÈô§Âç†‰Ωç
                    ele.img[rjCode] = null;
                    return null;
                }
                let img;
                try{
                    img = GM_addElement("img", {
                        src: link,
                    });
                    if(!img) { // noinspection ExceptionCaughtLocallyJS
                        throw new Error("APIË∞ÉÁî®ÁîüÊàêÂ§±Ë¥•");
                    }
                }catch (e) {
                    img = document.createElement("img");
                    img.src = link;
                }

                imgContainer.appendChild(img);
                console.warn("Ê∑ªÂä†Â∞ÅÈù¢ÔºÅ")
                ele.img[rjCode] = img;

                //ÂºÄÂêØÂä®Áîª
                if(settings._s_sfw_blur_transition){
                    img.style.setProperty("transition", "all 0.3s", "important");
                }

                //Èº†Ê†áÁßªÂä®‰∏äÂéªËß£Èô§Ê®°Á≥ä
                img.addEventListener("mouseenter", e => {
                    if(!settings._s_sfw_remove_when_hover){
                        return;
                    }
                    img.style.setProperty("filter", "inherit", "important");
                });
                img.addEventListener("mouseleave", e => {
                    if(settings._s_sfw_mode){
                        img.style.setProperty("filter", `blur(${blur_map[settings._s_sfw_blur_level]})`, "important");
                    }else{
                        img.style.setProperty("filter", "inherit", "important");
                    }
                });

                return img;
            }).then(img => {
                if(!(img instanceof HTMLElement)) return;
                img.style.setProperty("display", "block", "important");  //display = "block"

                //ËÆæÁΩÆNSFWÊ®°Á≥ä
                if(settings._s_sfw_mode){
                    img.style.setProperty("filter", `blur(${blur_map[settings._s_sfw_blur_level]})`, "important");
                }else{
                    img.style.setProperty("filter", "inherit", "important");
                }
            }).catch(e => {
                //Ê∏ÖÁêÜÂπ∂Âú®‰∏ãÊ¨°ÈáçËØï
                if(ele.img[rjCode] instanceof HTMLElement) img.remove();
                ele.img[rjCode] = null;
                console.error(e)
            });

            //------ËÆæÁΩÆhintÂèØËßÅ------
            ele.hint.style.setProperty("display", "block", "important");

            //------ËÆæÁΩÆÊ†áÈ¢ò------
            const titleElement = ele.title;
            titleElement.innerText = "Loading...";
            titleElement.setHint(localizePopup(localizationMap.hint_copy_work_title));
            titleElement.setCopyText(null);
            titleElement.setSecondaryCopyText(null);
            WorkPromise.getWorkTitle(rjCode).then(title => {
                if(rjCode !== popup.getAttribute(RJCODE_ATTRIBUTE)) return;
                titleElement.innerText = title;
                titleElement.setCopyText(title);
                titleElement.setSecondaryCopyText(convertToValidFileName(title));
            }).catch(_ => {
                if(rjCode !== popup.getAttribute(RJCODE_ATTRIBUTE)) return;
                titleElement.innerHTML = Csp.createHTML("");
            })

            //------ËÆæÁΩÆRJÂè∑------
            const rjCodeElement = ele.rj_code;
            rjCodeElement.innerHTML = Csp.createHTML(`[ ${isParent ? " ‚Üë " : ""}<span class="${VOICELINK_IGNORED_CLASS}" style="font-weight: bold !important;text-decoration-line: underline !important;">${rjCode}</span> ]`);
            WorkPromise.getRJChain(rjCode).then(chain => {
                if(rjCode !== popup.getAttribute(RJCODE_ATTRIBUTE)) return;
                rjCodeElement.innerText = "[ ";
                //ÊûÑÈÄ†chain
                for (let i = 0; i < chain.length; i++) {
                    const rj = chain[i];
                    let e = Popup.createCopyTag("span", rj);
                    e.innerText = rj;
                    e.classList.add(VOICELINK_IGNORED_CLASS);
                    if(i === 0) {
                        //Á¨¨‰∏Ä‰∏™ÂÖÉÁ¥†Ôºå‰πüÂ∞±ÊòØÂΩìÂâçRJÂè∑
                        e.style.setProperty("font-weight", "bold", "important");
                        e.style.setProperty("text-decoration", "underline", "important");
                    }else{
                        rjCodeElement.appendChild(document.createTextNode(" ‚Üí "));
                    }
                    rjCodeElement.appendChild(e);
                }
                rjCodeElement.appendChild(document.createTextNode(" ]"));
            });

            //Ê∏ÖÈô§ÂéüÊúâ‰ø°ÊÅØÂπ∂Â±ïÁ§∫Âä†ËΩΩÁïåÈù¢
            for(let child of [...this.popupElement.info_container.children]){
                if(child === this.popupElement.loader) continue;
                child.remove();
            }
            ele.loader.style.setProperty("display", "flex", "important");  //display = "flex !important";
            WorkPromise.getWorkCategory(rjCode).then(category => {
                if(rjCode !== popup.getAttribute(RJCODE_ATTRIBUTE)) return;
                this.set_info_container(rjCode, category);
            }).catch(e => {
                if (rjCode !== popup.getAttribute(RJCODE_ATTRIBUTE)) return;
                //ÈªòËÆ§other
                this.set_info_container(rjCode, "other");
            });

            Popup.move(e);
        },

        setFoundState(found){
            const ele = Popup.popupElement;

            ele.not_found.style.setProperty("display", found ? "none" : "block", "important");
            //ele.img.container.style.setProperty("display", found && !Popup.hideImg ? "block" : "none", "important");
            ele.left_panel.style.setProperty("display", found ? "flex" : "none", "important");
            ele.right_panel.style.setProperty("display", found ? "block" : "none", "important");
            ele.title.style.setProperty("display", found ? "block" : "none", "important");
            ele.rj_code.style.setProperty("display", found ? "block" : "none", "important");
            ele.info_container.style.setProperty("display", found ? "block" : "none", "important");
            ele.hint.style.setProperty("display", found ? "block" : "none", "important");
            /*ele.dl_count.style.setProperty("display", found ? "block" : "none", "important");
            ele.circle_name.style.setProperty("display", found ? "block" : "none", "important");
            ele.debug.style.setProperty("display", found ? "block" : "none", "important");
            ele.translator_name.style.setProperty("display", found ? "block" : "none", "important");
            ele.release_date.style.setProperty("display", found ? "block" : "none", "important");
            ele.update_date.style.setProperty("display", found ? "block" : "none", "important");
            ele.age_rating.style.setProperty("display", found ? "block" : "none", "important");
            ele.voice_actor.style.setProperty("display", found ? "block" : "none", "important");
            ele.music.style.setProperty("display", found ? "block" : "none", "important");
            ele.genre.style.setProperty("display", found ? "block" : "none", "important");
            ele.file_size.style.setProperty("display", found ? "block" : "none", "important");*/
        },

        /**
         * ÂàõÂª∫ÂèØÂ§çÂà∂Ê†áÁ≠æ
         * @param tag {string|HTMLElement} Ê†áÁ≠æÂêçÊàñÊ†áÁ≠æÂØπË±°ÔºàÂ¶ÇÊûú‰∏∫Ê†áÁ≠æÂØπË±°ÔºåÂàô‰ºöÂ∞ÜÂØπË±°ÂéüÂú∞ËΩ¨ÂåñÊàêÂèØÂ§çÂà∂Ê†áÁ≠æÔºâ
         * @param copyText {string} ÈúÄË¶ÅÂ§çÂà∂ÁöÑÊñáÊú¨
         * @param isTitle {boolean} ÊòØÂê¶‰∏∫Ê†áÈ¢òÂÖÉÁ¥†Ôºà‰ΩøÁî®ÁâπÊÆäclassÔºâ
         * @param hint {string} ÊèêÁ§∫Ê†èÊòæÁ§∫ÁöÑÊèêÁ§∫ÊñáÊú¨
         * @returns {HTMLElement} ÂàõÂª∫/ËΩ¨Êç¢ÂêéÁöÑÊ†áÁ≠æ
         */
        createCopyTag: function (tag, copyText, isTitle = false, hint = isTitle ? localizePopup(localizationMap.hint_copy_all) : localizePopup(localizationMap.hint_copy)) {
            tag = (typeof tag === "string") ? document.createElement(tag) : tag;
            if(isTitle) tag.classList.add("info-title");

            //Ê∑ªÂä†Ëá™ÂÆö‰πâÊñπÊ≥ï
            tag.getCopyText = () => tag.getAttribute("copy-text");
            tag.setCopyText = text => {
                if(!text){
                    tag.removeAttribute("copy-text");
                    return;
                }
                tag.setAttribute("copy-text", text);
            };

            tag.getSecondaryCopyText = () => tag.getAttribute("sec-copy-text");
            tag.setSecondaryCopyText = text => {
                if(!text){
                    tag.removeAttribute("sec-copy-text");
                    return;
                }
                tag.setAttribute("sec-copy-text", text);
            };

            tag.getHint = () => tag.getAttribute("hint");
            tag.setHint = hint => {
                tag.setAttribute("hint", hint);
            };

            tag.setCopyText(copyText);
            tag.setHint(hint);
            tag.addEventListener("click", e => {
                const attr = e.altKey ? "sec-copy-text" : "copy-text";
                if(!tag.hasAttribute(attr)) return;
                GM_setClipboard(tag.getAttribute(attr), "text")?.finally();
                // navigator.clipboard.writeText(tag.getAttribute(attr)).finally();
            });
            tag.addEventListener("mouseenter", e => {
                let hint = tag.getHint();
                Popup.popupElement.hint.innerText = hint ? hint : Popup.popupElement.hint.innerText;
            })
            return tag;
        },

        /**
         * ÊòæÁ§∫ÊüêË°åÁöÑ‰ø°ÊÅØ
         * @param rjCode {string} ‰ø°ÊÅØÂØπÂ∫îÁöÑRJÂè∑
         * @param id {string} ‰ø°ÊÅØÂØπÂ∫îÁöÑID
         * @param rowElement {HTMLElement} Ë°åÂØπÂ∫îÁöÑElementÂÖÉÁ¥†
         * @param title {string} Ë°å‰ø°ÊÅØÊ†áÈ¢ò
         * @param contentProvider {Promise<any|Array|HTMLElement>} Êó†ÂèÇÂÜÖÂÆπProviderÔºåËøîÂõûÂ≠óÁ¨¶‰∏≤/Â≠óÁ¨¶‰∏≤ÂàóË°®Á≠âÁî®‰∫éÁîüÊàêÊñáÊú¨
         * @param suffixProvider {Promise<HTMLElement>} Êó†ÂèÇÂêéÁºÄProviderÔºåËøîÂõû‰∏Ä‰∏™ElementÁî®‰∫éÊîæÂú®ContentÂêéÈù¢
         * @param contentSeperator {string, HTMLElement}  ContentÂ¶ÇÊûúÊòØÂàóË°®ÔºåÂàôËØ•ÂÜÖÂÆπ‰∏∫‰Ωú‰∏∫ÂàÜÈöîÁ¨¶
         * @param contentSeperatorText {string} Â¶ÇÊûúÈááÁî®HTMLElementÁöÑÂàÜÈöîÁ¨¶ÔºåÂàôÂú®Â§çÂà∂ÁöÑÊó∂ÂÄôÈúÄË¶ÅÊúâ‰∏Ä‰∏™ÊñáÊú¨Ë°®Á§∫
         */
        set_info_row: function (rjCode, id, rowElement, title, contentProvider, suffixProvider, contentSeperator = " ", contentSeperatorText = undefined ){
            const settingId = `_s_${id}`;
            //Â¶ÇÊûúËÆæÁΩÆ‰∫Ü‰∏çÂ±ïÁ§∫‰ø°ÊÅØÔºåÊàñ‰ø°ÊÅØÊ≤°Âú®ËÆæÁΩÆ‰∏≠ÂÆö‰πâÔºåÂàô‰∏çÊòæÁ§∫
            if(!settings[settingId]) return;

            const ele = Popup.popupElement;
            const popup = ele.popup;
            const titleElement = Popup.createCopyTag("span", "", true);
            titleElement.innerText = title;
            const contentElement = Popup.createCopyTag("span", null);
            contentElement.innerText = "Loading...";

            rowElement.innerHTML = Csp.createHTML("");
            rowElement.appendChild(titleElement);
            rowElement.appendChild(contentElement);

            contentProvider.then(contents => {
                if(rjCode !== popup.getAttribute(RJCODE_ATTRIBUTE)) return;
                if(!Array.isArray(contents)){
                    //Âçï‰∏™ÁªìÊûúËΩ¨ÂåñÊàêÂàóË°®
                    contents = [contents];
                }

                //Â§ÑÁêÜÁªìÊûúÂàóË°®
                contentElement.setCopyText(null);
                contentElement.innerText = "";
                //‰ª•ÊåáÂÆöÁöÑÂàÜÈöîÁ¨¶ÊñáÊú¨‰∏∫ÂáÜÔºå‰∏çÊåáÂÆöÂàÜÈöîÁ¨¶ÊñáÊú¨ÂÜç‰ΩøÁî®ÂàÜÈöîÁ¨¶ÂÜÖÁöÑÊñáÊú¨
                let sepText = contentSeperatorText ? contentSeperatorText : contentSeperator.toString();
                let sep;
                if(typeof contentSeperator === "string"){
                    sep = document.createElement("span");
                    sep.innerText = contentSeperator;
                }else{
                    sep = contentSeperator;
                }

                let contentsText = [];
                for (let i = 0; i < contents.length; i++) {
                    let c = contents[i];
                    if(i > 0) {
                        //Â¶ÇÊûúSeperatorÊòØElementÔºåÂàôÁõ¥Êé•Â§çÂà∂‰∏Ä‰∏™Âá∫Êù•Ê∑ªÂä†ÔºåÂê¶ÂàôÂàõÂª∫‰∏Ä‰∏™spanÁÑ∂ÂêéÊääÂÜÖÂÆπËΩ¨Êç¢ÊàêÊñáÊú¨ÊîæËøõÂéª„ÄÇ
                        contentElement.appendChild(sep.cloneNode(true));
                    }

                    let element;
                    if(c instanceof HTMLElement){
                        element = c;
                    }else{
                        element = Popup.createCopyTag("a", c);
                        element.innerText = c;
                    }

                    //Â∞ÜÂ§çÂà∂ÊñáÊú¨Âä†ÂÖ•Â§çÂà∂ÂàóË°®
                    const copyText = element.getAttribute("copy-text");
                    if(copyText) contentsText.push(copyText);

                    contentElement.appendChild(element);
                }

                //‰∏∫Ê†áÈ¢òÊ∑ªÂä†Â§çÂà∂ÊñáÊú¨
                titleElement.setCopyText(contentsText.join(sepText));
            }).catch(e => {
                if(rjCode !== popup.getAttribute(RJCODE_ATTRIBUTE)) return;
                rowElement.innerHTML = Csp.createHTML("");
                //console.error(e);
            }).finally(() => {
                Popup.adjustPopup(ele._state.mouseX, ele._state.mouseY, true);
            });

            if(suffixProvider){
                suffixProvider.then((element) => {
                    if(rjCode !== popup.getAttribute(RJCODE_ATTRIBUTE)) return;
                    rowElement.appendChild(element);
                }).catch(_ => {});
            }

            return rowElement;
        },
        set_dl_count: function (rjCode, category){
            const id = `${category}__dl_count`;
            const element = Popup.set_info_row(rjCode, id, Popup.popupElement.dl_count, localizePopup(localizationMap.dl_count),
                WorkPromise.getDLCount(rjCode));
            if(element) Popup.popupElement.info_container.appendChild(element);
        },
        set_circle_name: function (rjCode, category){
            const id = `${category}__circle_name`;
            const element = Popup.set_info_row(rjCode, id, Popup.popupElement.circle_name, localizePopup(localizationMap.circle_name),
                WorkPromise.getCircle(rjCode), null);
            if(element) Popup.popupElement.info_container.appendChild(element);
        },
        set_translator_name: function (rjCode, category){
            const id = `${category}__translator_name`;
            const element = Popup.set_info_row(rjCode, id, Popup.popupElement.translator_name,
                localizePopup(localizationMap.translator_name), WorkPromise.getTranslatorName(rjCode), null);
            if(element) Popup.popupElement.info_container.appendChild(element);
        },
        set_release_date: function (rjCode, category){
            const id = `${category}__release_date`;
            const element = Popup.set_info_row(rjCode, id, Popup.popupElement.release_date, localizePopup(localizationMap.release_date),
                WorkPromise.getReleaseDate(rjCode).then(async (date) => {
                    const [dateStr, isAnnounce] = date;
                    const e = Popup.createCopyTag("a", dateStr);
                    e.innerText = dateStr;
                    if(isAnnounce) e.style.setProperty("color", "gold", "important");
                    return e;
                }), WorkPromise.getReleaseCountDownElement(rjCode).then(element => {
                    element.style.setProperty("margin-left", "16px", "important");
                    return element;
                }));

            if(element) Popup.popupElement.info_container.appendChild(element);
        },
        set_update_date: function (rjCode, category){
            const id = `${category}__update_date`;
            const element = Popup.set_info_row(rjCode, id, Popup.popupElement.update_date, localizePopup(localizationMap.update_date),
                WorkPromise.getUpdateDate(rjCode));
            if(element) Popup.popupElement.info_container.appendChild(element);
        },
        set_age_rating: function (rjCode, category){
            const id = `${category}__age_rating`;
            const element = Popup.set_info_row(rjCode, id, Popup.popupElement.age_rating, localizePopup(localizationMap.age_rating),
                WorkPromise.getAgeRating(rjCode).then(rating => {
                    let ratingClass = `${VOICELINK_CLASS}_age-all`;
                    if(rating.includes("18")){
                        ratingClass = `${VOICELINK_CLASS}_age-18`;
                    }
                    let e = Popup.createCopyTag("a", rating);
                    e.innerText = rating;
                    e.classList.add(ratingClass);
                    return e;
                }));
            if(element) Popup.popupElement.info_container.appendChild(element);
        },
        set_scenario: function (rjCode, category){
            const id = `${category}__scenario`;
            const element = Popup.set_info_row(rjCode, id, Popup.popupElement.scenario, localizePopup(localizationMap.scenario),
                WorkPromise.getScenario(rjCode), null, " / ");
            if(element) Popup.popupElement.info_container.appendChild(element);
        },
        set_illustration: function (rjCode, category){
            const id = `${category}__illustration`;
            const element = Popup.set_info_row(rjCode, id, Popup.popupElement.illustration, localizePopup(localizationMap.illustration),
                WorkPromise.getIllustrator(rjCode), null, " / ");
            if(element) Popup.popupElement.info_container.appendChild(element);
        },
        set_voice_actor: function (rjCode, category){
            const id = `${category}__voice_actor`;
            const element = Popup.set_info_row(rjCode, id, Popup.popupElement.voice_actor, localizePopup(localizationMap.voice_actor),
                WorkPromise.getCV(rjCode), null, " / ");
            if(element) Popup.popupElement.info_container.appendChild(element);
        },
        set_music: function (rjCode, category) {
            const id = `${category}__music`;
            const element = Popup.set_info_row(rjCode, id, Popup.popupElement.music, localizePopup(localizationMap.music),
                WorkPromise.getMusic(rjCode), null, " / ");
            if(element) Popup.popupElement.info_container.appendChild(element);
        },
        set_genre: function (rjCode, category){
            const id = `${category}__genre`;
            const element = Popup.set_info_row(rjCode, id, Popup.popupElement.genre, localizePopup(localizationMap.genre),
                WorkPromise.getTags(rjCode), null, "\u3000");
            if(element) Popup.popupElement.info_container.appendChild(element);
        },
        set_file_size: function (rjCode, category){
            const id = `${category}__file_size`;
            const element = Popup.set_info_row(rjCode, id, Popup.popupElement.file_size, localizePopup(localizationMap.file_size),
                WorkPromise.getFileSize(rjCode));
            if(element) Popup.popupElement.info_container.appendChild(element);
        },

        get_tag: function (text, tagClass) {
            if(!tagClass.startsWith(`${VOICELINK_CLASS}_`)){
                tagClass = `${VOICELINK_CLASS}_${tagClass}`
            }
            const tag = document.createElement("span");
            tag.classList.add(`${VOICELINK_CLASS}_tag_tight`);
            tag.classList.add(tagClass);
            tag.innerText = text;
            return tag;
        },
        get_tag_rate: async function (rjCode) {
            let rate = await WorkPromise.getRateAvg(rjCode);
            let cot = await WorkPromise.getRateCount(rjCode);
            return Popup.get_tag(`${rate.toFixed(2)}‚òÖ` + (settings._s_show_rate_count ? ` (${cot})` : ""), "tag-yellow");
        },
        get_tag_no_longer_available: async function (rjCode) {
            let sale = await WorkPromise.getSale(rjCode);
            if(sale) return;
            return Popup.get_tag(localizePopup(localizationMap.tag_no_longer_available),
                "tag-gray");
        },
        get_tag_work_type: async function (rjCode) {
            let type = await WorkPromise.getWorkTypeText(rjCode);
            let tagClass = "tag-gray";
            switch (type) {
                case localizePopup(localizationMap.work_type_game):
                    tagClass = "tag-purple";
                    break;
                case localizePopup(localizationMap.work_type_comic):
                    tagClass = "tag-green";
                    break;
                case localizePopup(localizationMap.work_type_illustration):
                    tagClass = "tag-teal";
                    break;
                case localizePopup(localizationMap.work_type_novel):
                    tagClass = "tag-gray";
                    break;
                case localizePopup(localizationMap.work_type_video):
                    tagClass = "tag-darkblue";
                    break;
                case localizePopup(localizationMap.work_type_voice):
                    tagClass = "tag-orange";
                    break;
                case localizePopup(localizationMap.work_type_music):
                    tagClass = "tag-yellow";
                    break;
                case localizePopup(localizationMap.work_type_tool):
                    tagClass = "tag-gray";
                    break;
                case localizePopup(localizationMap.work_type_voice_comic):
                    tagClass = "tag-blue";
                    break;
                case localizePopup(localizationMap.work_type_other):
                    tagClass = "tag-gray";
                    break;
                default:
                    tagClass = "tag-gray";
                    break;
            }
            return Popup.get_tag(type, tagClass);
        },
        get_tag_translatable: async function (rjCode) {
            let able = await WorkPromise.getTranslatable(rjCode);
            if(!able) return;
            return Popup.get_tag(localizePopup(localizationMap.tag_translatable),
                "tag-green");
        },
        get_tag_not_translatable: async function (rjCode) {
            let able = await WorkPromise.getTranslatable(rjCode);
            let translated = await WorkPromise.getTranslated(rjCode);
            if(able || translated) return;
            return Popup.get_tag(localizePopup(localizationMap.tag_not_translatable),
                "tag-red");
        },
        get_tag_translated: async function (rjCode) {
            let translated = await WorkPromise.getTranslated(rjCode);
            if(!translated) return;
            return Popup.get_tag(localizePopup(localizationMap.tag_translated), "tag-teal");
        },
        get_tag_bonus_work: async function (rjCode) {
            let bonus = await WorkPromise.getBonus(rjCode);
            if(!bonus) return;
            return Popup.get_tag(localizePopup(localizationMap.tag_bonus_work),
                "tag-yellow");
        },
        get_tag_has_bonus: async function (rjCode) {
            let has = await WorkPromise.getHasBonus(rjCode);
            if(!has) return;
            return Popup.get_tag(localizePopup(localizationMap.tag_has_bonus),
                "tag-orange");
        },
        get_tag_language_support: async function (rjCode) {
            const lang = await WorkPromise.getLanguages(rjCode);
            if(!lang || lang.length <= 0){
                return;
            }
            let txt = "";
            lang.forEach(l => {
                txt += ` | ${l}`;
            });
            txt = txt.substring(3);
            return Popup.get_tag(txt, "tag-pink");
        },
        get_tag_file_format: async function (rjCode) {
            const format = await WorkPromise.getFileFormats(rjCode);
            if(!format || format.length <= 0){
                return;
            }
            let txt = "";
            format.forEach(f => {
                txt += ` | ${f}`;
            });
            txt = txt.substring(3);
            return Popup.get_tag(txt, "tag-darkblue");
        },
        get_tag_ai: async function (rjCode) {
            const ai = await WorkPromise.getAIUsedText(rjCode);
            if(!ai) return;
            return Popup.get_tag(ai, "tag-purple");
        },
        get_translatable_tag: async function (rjCode, tag_id) {
            if(settings[`_s_${tag_id}`] !== true) return;

            if(tag_id.startsWith("tag_")) tag_id = tag_id.substring(4);
            const t = await WorkPromise.getWorkPromise(rjCode).translatable;
            const stat = t[tag_id];

            const hasRequest = stat.request > 0;
            const hasSale = stat.sale > 0;
            const displayCount = stat.agree || hasRequest || hasSale;
            const lang = tag_id.substring("translation_request_".length);
            const tag = Popup.get_tag(`${localizePopup(localizationMap[`language_${lang}_abbr`])}${stat.agree ? "" : (stat.agree === false ? " ‚úò" : " ?")} ${displayCount ? ` ${stat.request}-${stat.sale}` : ""}`,
                hasSale ? "tag-green" : (hasRequest ? "tag-orange" : "tag-gray"));
            tag.classList.add(`${VOICELINK_CLASS}_tag_small`);
            return tag;
        },

        get_tag_container: function (rjCode, tag_list) {
            const container = document.createElement("div");
            container.classList.add(`${VOICELINK_CLASS}_tags`);
            for (const tag_id of tag_list) {
                if(settings[`_s_${tag_id}`] !== true) continue;

                let shadowTag = document.createElement("span");
                shadowTag.style.setProperty("display", "none", "important");  //display = "none !important";
                shadowTag.setAttribute("data-id", tag_id);
                container.appendChild(shadowTag);

                let tag_get = this[`get_${tag_id}`];
                tag_get(rjCode).then(tag => {
                    if(tag){
                        container.insertBefore(tag, shadowTag);
                        shadowTag.remove();
                    }
                });
            }
            return container;
        },
        get_translatable_tag_container: function (rjCode, tag_list) {
            const container = document.createElement("div");
            container.classList.add(`${VOICELINK_CLASS}_tags`);
            container.style.setProperty("margin-top", "0", "important");  //marginTop = "0 !important";
            for (const tag_id of tag_list) {
                let shadowTag = document.createElement("span");
                shadowTag.style.setProperty("display", "none", "important");  //display = "none !important";
                shadowTag.setAttribute("data-id", tag_id);
                container.appendChild(shadowTag);

                Popup.get_translatable_tag(rjCode, tag_id).then(tag => {
                    if(tag){
                        container.insertBefore(tag, shadowTag);
                        shadowTag.remove();
                    }
                }).catch(e => {});
            }
            return container;
        },

        //Êï¥ÂêàÈ°∫Â∫è
        set_info_container: function (rjCode, category) {
            //Ê∏ÖÈô§‰∏äÊ¨°ÁöÑ‰ø°ÊÅØ
            for(let child of [...this.popupElement.info_container.children]){
                if(child === this.popupElement.loader) {
                    child.style.setProperty("display", "none", "important");  //display = "none !important";
                    continue;
                }
                child.remove();
            }

            //TAGÈÉ®ÂàÜ
            const infoContainer = this.popupElement.info_container;
            let tagContainer = null;
            if(settings._s_tag_main_switch === true){
                const container = this.get_tag_container(rjCode,
                    settings[`_s_tag_display_order`]);
                tagContainer = container;
                infoContainer.appendChild(container);
            }

            //ÁøªËØëÁî≥ËØ∑ÊÉÖÂÜµ
            const shadowContainer = document.createElement("div");
            shadowContainer.style.setProperty("display", "none", "important");  //display = "none !important";
            infoContainer.appendChild(shadowContainer);
            WorkPromise.getTranslatable(rjCode).then(able => {
                if(rjCode !== Popup.popupElement.popup.getAttribute(RJCODE_ATTRIBUTE)) return;
                if(able && settings._s_tag_translation_request === true){
                    const translatableContainer = this.get_translatable_tag_container(rjCode,
                        settings._s_tag_translation_request_display_order);
                    infoContainer.insertBefore(translatableContainer, shadowContainer);
                    shadowContainer.remove();
                }
            }).catch(e => {});

            //‰ø°ÊÅØÈÉ®ÂàÜ
            const order = settings[`_s_${category}__info_display_order`];
            order.forEach(id => {
                try{
                    id = id.substring(id.indexOf("__") + 2);
                    this["set_" + id](rjCode, category);
                }catch (e) {
                    console.error(e);
                }
            });

            const debugElement = document.createElement("div");
            this.popupElement.info_container.appendChild(debugElement);
            WorkPromise.getDebug(rjCode).then(t => {
                debugElement.innerHTML = Csp.createHTML(t);
            });
        },

        //Ë∞ÉÊï¥ÂºπÊ°Ü‰ΩçÁΩÆ
        adjustPopup: function (mouseX, mouseY, force = false){
            // console.log("ÂÆö‰Ωç‰øÆÊ≠£")

            //ÂÆö‰Ωç‰øÆÊ≠£
            const popup = Popup.popupElement.popup;
            if(!Popup.pinRJ || force){
                if (popup.offsetWidth + mouseX + 10 < window.innerWidth - 10) {
                    popup.style.setProperty("left", (mouseX + 10) + "px", "important");
                }
                else {
                    popup.style.setProperty("left", (window.innerWidth - popup.offsetWidth - 10) + "px", "important");
                }
            }

            let rect = popup.getBoundingClientRect();
            if(!Popup.pinRJ || force || rect.top < 0 || rect.bottom > window.innerHeight){
                if (mouseY > window.innerHeight / 2) {
                    let top = Math.max(mouseY - popup.offsetHeight - 8, 0);
                    popup.style.setProperty("top", top + "px", "important");
                }
                else {
                    let top = Math.min(mouseY + 20, window.innerHeight - popup.offsetHeight);
                    popup.style.setProperty("top", top + "px", "important");
                }
            }

            //Â§ßÂ∞è‰øÆÊ≠£
            let currentFontSize = popup.computedStyleMap().get("font-size").toString();
            currentFontSize = parseFloat(currentFontSize.substring(0, Math.max(currentFontSize.indexOf("px"), 1)));
            const sizeLevel = [15, 14.5, 14, 13.5, 13, 12.5, 12];
            let size = sizeLevel[sizeLevel.length - 1];
            if(popup.offsetHeight > window.innerHeight){
                //ËÆ°ÁÆópopupÁöÑÈ´òÂ∫¶‰∏éwindowÈ´òÂ∫¶ÁöÑÊØîÂÄºÔºåÊâæÂà∞Á¶ªÂÆÉÊúÄÁõ∏Ëøë‰∏îÊõ¥Â§ßÁöÑÂΩìÂâçÂ≠ó‰ΩìÂ§ßÂ∞èÂíåsizeLevelÁöÑÊØîÂÄº
                for (const s of sizeLevel) {
                    if(popup.offsetHeight / window.innerHeight < currentFontSize / s){
                        size = s;
                        break;
                    }
                }
                popup.style.setProperty("font-size", size + "px", "important");
            }
        },

        pinRJ: undefined,
        setPinState: function (rjCode, pin, close = true){
            const ele = Popup.popupElement;
            const popup = ele.popup;
            if(!pin){
                //ÂÖ≥Èó≠ÂºπÊ°Ü
                popup.style.setProperty("pointer-events", "none", "important");
                Popup.pinRJ = undefined;
                popup.removeAttribute("pin");

                if(close) popup.style.setProperty("display", "none", "important");

                //ÂèñÊ∂àÊ≥®ÂÜåËá™Âä®ÂÖ≥Èó≠ÁõëÂê¨
                document.removeEventListener("keyup", Popup.keyup);
                document.removeEventListener("mousemove", Popup.domMove);
                return
            }

            popup.style.setProperty("pointer-events", "auto", "important");
            Popup.pinRJ = rjCode;
            popup.setAttribute("pin", "");

            //Ê∑ªÂä†ÁõëÂê¨Âô®
            document.addEventListener("keyup", Popup.keyup);
            document.addEventListener("mousemove", Popup.domMove);
        },
        hasPinned: function (){
            return Popup.popupElement.popup.hasAttribute("pin");
        },
        /**
         * @param e {KeyboardEvent}
         */
        isHoldPinKey: function(e){
            if(getOS() === "Mac"){
                return e.metaKey;
            }
            return e.ctrlKey;
        },
        /**
         * @param e {KeyboardEvent}
         */
        isPinKeyDown: function (e) {
            if(getOS() === "Mac"){
                return e.key === "Meta";
            }
            return e.key === "Control";
        },

        /**
         * Èº†Ê†áÁ¶ªÂºÄÂõ∫ÂÆöÂºπÁ™óÊó∂ÔºåÂ¶ÇÊûúÊ≤°ÊúâÊåâ‰ΩèpinÈîÆÂàôÊ∂àÂ§±
         * @param e {MouseEvent}
         */
        /*pinLeave: function (e) {
            if(Popup.isHoldPinKey(e)){
                return;
            }
            Popup.setPinState(null, false, true);
        },*/
        /**
         * ÁõëÂê¨ÁΩëÈ°µÂÜÖÁöÑÈº†Ê†áÁßªÂä®‰∫ã‰ª∂ÔºåÊù•‰øùËØÅÂºπÊ°ÜÊ≠£Â∏∏ÁßªÈô§
         * @param e {MouseEvent}
         */
        domMove: function (e) {
            if(!Popup.hasPinned() || Popup.isHoldPinKey(e)){
                return;
            }
            Popup.setPinState(null, false);
        },
        /**
         * Èº†Ê†áÁßªÂä®Âà∞ÈìæÊé•‰∏äËß¶Âèë
         * @param e {MouseEvent}
         */
        over: function (e) {
            const target = isInDLSite() ? e.target : getVoiceLinkTarget(e.target);
            if(!target || !target.classList.contains(VOICELINK_CLASS)) return;

            const rjCode = target.getAttribute(RJCODE_ATTRIBUTE);
            if(rjCode === null) return;

            //ËÆ∞ÂΩïÈº†Ê†á‰ΩçÁΩÆ
            let ele = Popup.popupElement;
            ele._state.mouseX = e.clientX;
            ele._state.mouseY = e.clientY;

            //Â¶ÇÊûúÁî®Êà∑Âõ∫ÂÆö‰∫ÜÂºπÊ°ÜÔºåÂàôÊèêÁ§∫Áî®Êà∑ÂøÖÈ°ªctrlÂÖ≥Èó≠ÂºπÊ°ÜÊâçËÉΩËß£Êûê
            if(Popup.isHoldPinKey(e) && Popup.pinRJ){
                ele.hint.innerText = localizePopup(localizationMap.hint_unpin);
                return;
            }else{
                //Ê≤°ÊúâÂõ∫ÂÆöÂºπÊ°ÜÁöÑËØùÊ∏ÖÁêÜpinRJÔºåÂõ†‰∏∫ÊúâÊó∂ÂÄôpinRJÊ≤°ÂäûÊ≥ïË¢´keyupÊ∏ÖÁêÜÔºàÂ¶ÇkeyupÊú™Ëß¶ÂèëÔºâ
                Popup.pinRJ = undefined
                ele.hint.innerText = localizePopup(localizationMap.hint_pin);
            }

            //‰øÆÊ≠£ÈìæÊé•
            if(target.hasAttribute("voicelink-linkified")){
                WorkPromise.getWorkPromise(rjCode).info.then(info => {
                    if(info.is_announce === true){
                        target.href = `https://www.dlsite.com/maniax/announce/=/product_id/${rjCode}.html`;
                    }
                });
            }

            let popup = document.querySelector(`div#${VOICELINK_CLASS}-voice-popup`);  // + rjCode);
            if (popup) {
                popup.style.setProperty("display", "flex", "important");  //display = "flex !important";
                //ÂÖàÂ∞ÜÂ≠ó‰ΩìÂ§ßÂ∞èÂèòÂõûÂéüÊ†∑
                popup.style.setProperty("font-size", "15.4px", "important");
            }
            else {
                Popup.makePopup();
                popup = ele.popup;
            }
            Popup.updatePopup(e, rjCode);

            //Â¶ÇÊûúÊåâ‰Ωè‰∫ÜCTRLÔºåÂàôÂ∞ÜpopupÂèØË¢´ÁÇπÂáªÔºåÂê¶ÂàôËÆæÁΩÆÁ©øÈÄè
            //Âπ∂ËÆæÁΩÆCopyÊòæÁ§∫ÊÉÖÂÜµ
            if(Popup.isHoldPinKey(e)){
                Popup.setPinState(rjCode, true)
                ele.hint.innerText = localizePopup(localizationMap.hint_unpin);
            }else{
                Popup.setPinState(rjCode, false, false)
            }

            //ËÆæÁΩÆÁÑ¶ÁÇπËá≥ÈìæÊé•‰∏ä
            target.focus();
            target.style.setProperty("outline", "none", "important");
        },

        /**
         * Èº†Ê†áÁ¶ªÂºÄÊó∂Ëß¶Âèë
         * @param e {MouseEvent}
         */
        out: function (e) {
            //Â¶ÇÊûúÂõ∫ÂÆöÂàôÁ¶ÅÊ≠¢ÂÖ≥Èó≠
            if(Popup.isHoldPinKey(e)) {
                return
            }

            const target = isInDLSite() ? e.target : getVoiceLinkTarget(e.target);
            if(!target || !target.classList.contains(VOICELINK_CLASS)) return;

            const rjCode = target.getAttribute(RJCODE_ATTRIBUTE);
            if(rjCode === null) return;

            //ÂèñÊ∂àÂõ∫ÂÆöÂπ∂ÂÖ≥Èó≠
            Popup.setPinState(rjCode, false)

            //ÂèñÊ∂àfocus
            target.blur();
            target.style.setProperty("outline", null);
        },

        /**
         * Èº†Ê†áÁßªÂä®Êó∂Ëß¶Âèë
         * @param e {MouseEvent}
         */
        move: function (e) {
            const target = isInDLSite() ? e.target : getVoiceLinkTarget(e.target);
            if(!target || !target.classList.contains(VOICELINK_CLASS)) return;

            const popup = document.querySelector(`div#${VOICELINK_CLASS}-voice-popup`);  // + rjCode);
            if(!popup) return;

            const rjCode = e.target.getAttribute(RJCODE_ATTRIBUTE);
            if(rjCode === null) return;

            let ele = Popup.popupElement;
            ele._state.mouseX = e.clientX;
            ele._state.mouseY = e.clientY;

            //ÁÑ¶ÁÇπ‰∏çÂú®ÊµèËßàÂô®‰∏äÁöÑÊó∂ÂÄôÊó†Ê≥ïËß¶ÂèëkeydownÔºåÂõ†Ê≠§ÈúÄË¶ÅÁî®moveÊù•ËæÖÂä©ÊøÄÊ¥ªpin
            if(Popup.isHoldPinKey(e) && !Popup.pinRJ){
                //Êåâ‰∏ãpinÈîÆ‰ΩÜÊ≤°ÊøÄÊ¥ªpinÊ®°ÂºèÁöÑÊó∂ÂÄôÊâãÂä®ÊøÄÊ¥ª
                Popup.setPinState(rjCode, true);
            }

            //Â¶ÇÊûúÂºπÊ°ÜÂ∑≤Âõ∫ÂÆö‰∏îÂõ∫ÂÆöÁöÑÂπ∂ÈùûÂΩìÂâçÊâÄÈÄâÈìæÊé•RJÂè∑ÔºåÂàô‰∏çËøõË°åÂÆö‰Ωç‰øÆÊ≠£
            if(Popup.pinRJ && rjCode !== Popup.pinRJ){
                return;
            }

            Popup.adjustPopup(e.clientX, e.clientY);

        },

        /**
         * ÊåâÈîÆÊåâ‰∏ãÊó∂Ëß¶Âèë
         * @param e {KeyboardEvent}
         */
        keydown: function (e) {
            const target = isInDLSite() ? e.target : getVoiceLinkTarget(e.target);
            if(!target || !target.classList.contains(VOICELINK_CLASS)) return;

            const rjCode = target.getAttribute(RJCODE_ATTRIBUTE);
            if(rjCode === null) return;

            let popup = Popup.popupElement.popup;
            if(popup.style.display !== "none" && Popup.isPinKeyDown(e)){
                //Êåâ‰ΩèCTRL‰ª•Âõ∫ÂÆöÊòæÁ§∫ÂºπÊ°Ü
                Popup.setPinState(rjCode, true);
            }
        },

        /**
         * ÊåâÈîÆÊä¨Ëµ∑Êó∂Ëß¶Âèë
         * @param e {KeyboardEvent}
         */
        keyup: function (e) {
            let popup = Popup.popupElement.popup;
            if(popup && Popup.isPinKeyDown(e)){
                Popup.setPinState(null, false);
            }
        }
    }

    const WorkPromise = {
        /**
         * Ê†áÈ¢ò„ÄÅÁ§æÂõ¢„ÄÅÂèëË°åÊó•Êúü„ÄÅÊõ¥Êñ∞Êó•Êúü„ÄÅÂπ¥ÈæÑÊåáÂÆö
         * CV„ÄÅÊ†áÁ≠æ„ÄÅÊñá‰ª∂Â§ßÂ∞è„ÄÅÂ∞ÅÈù¢Âú∞ÂùÄ
         */

        checkNotNull: function (obj){
            if(obj === null || obj === undefined) throw new Error();
            return obj;
        },

        getWorkPromise: function (rjCode){
            if(work_promise[rjCode]){
                return work_promise[rjCode];
            }
            work_promise[rjCode] = DLsite.getWorkRequestPromise(rjCode);
            return work_promise[rjCode];
        },

        getFound: async function(rjCode){
            try{
                const data = await WorkPromise.getWorkPromise(rjCode).api2;
                if(data && data.product_id !== undefined) return true;

                //Âê¶ÂàôÂÜçÊ¨°Ê£ÄÊü•api1
                const api = await WorkPromise.getWorkPromise(rjCode).api;
                return api && api.is_sale !== undefined;
            }catch (e){
                //ËØ¥ÊòéÊòØÁΩëÁªúÈóÆÈ¢òÔºåÂà†Èô§ÁºìÂ≠òÂπ∂ËøîÂõûtrue
                delete work_promise[rjCode];
                return true;
            }
        },

        getTranslationInfo: async function(rjCode){
            const p = WorkPromise.getWorkPromise(rjCode);
            let data = await p.api2;
            if(data.translation_info) return data.translation_info;

            data = await p.api;
            return data.translation_info ? data.translation_info : {};
        },

        getRJChain: async function(rjCode) {
            //RJxxx ‚Üí RJxxx ‚Üí RJxxxÔºåËøôÊ†∑‰ªéÂ≠êÁ∫ßÊåáÂêëÁà∂Á∫ß
            const trans = await WorkPromise.getTranslationInfo(rjCode);
            let chain = [rjCode];
            if(trans.is_child){
                chain.push(trans.parent_workno, trans.original_workno);
            }else if(trans.is_parent){
                chain.push(trans.original_workno);
            }
            return chain;
        },

        getParentRJ: async function(rjCode){
            try{
                const p = WorkPromise.getWorkPromise(rjCode);
                let trans = await WorkPromise.getTranslationInfo(rjCode);
                if(trans.is_original || trans.is_parent) return rjCode;
                if(trans.parent_workno) return trans.parent_workno;

                let data = await p.info;
                return data.parentWork;
            }catch (e){
                return null;
            }
        },

        getGirls: async function(rjCode){
            const p = WorkPromise.getWorkPromise(rjCode);
            let data = await p.api2;
            if(data.sex_category && data.sex_category === 2) return true;
            if(data.site_id === "girls") return true;

            //Âê¶ÂàôÂÜçÊ¨°Ê£ÄÊü•api1
            data = await WorkPromise.getWorkPromise(rjCode).api;
            WorkPromise.checkNotNull(data.is_girls)
            return data.is_girls;
        },

        getAnnounce: async function(rjCode) {
            const p = WorkPromise.getWorkPromise(rjCode);
            const info = await p.info;
            return info.is_announce;
        },

        getSale: async function(rjCode, checkAnnounce = true){
            const p = WorkPromise.getWorkPromise(rjCode);
            let data = await p.api;
            if(!checkAnnounce){
                return data.is_sale;
            }
            return data.is_sale || await WorkPromise.getAnnounce(rjCode);
        },

        getDLCount: async function (rjCode) {
            const p = WorkPromise.getWorkPromise(rjCode);
            let data = await p.api;
            WorkPromise.checkNotNull(data.dl_count);
            return data.dl_count;
        },

        getRateAvg: async function (rjCode) {
            const p = WorkPromise.getWorkPromise(rjCode);
            let data = await p.api;
            if(data.rate_average_2dp) return data.rate_average_2dp;

            //ËøòÂèØ‰ª•Á¥ØÂä†api2ÁöÑÁªìÊûúËé∑Âæó
            data = await p.api2;
            this.checkNotNull(data.rate_count_detail);
            let sum = 0;
            let count = 0;
            for (const key in data.rate_count_detail) {
                let rate = parseInt(key);
                let cot = parseInt(data.rate_count_detail[key]);
                count += cot
                sum += rate * cot;
            }
            return sum / count;
        },

        getRateCount: async function (rjCode) {
            const p = WorkPromise.getWorkPromise(rjCode);
            let data = await p.api;
            if(data.rate_count) return data.rate_count;

            //ËøòÂèØ‰ª•Á¥ØÂä†api2ÁöÑÁªìÊûúËé∑Âæó
            data = await p.api2;
            this.checkNotNull(data.rate_count_detail);
            let count = 0;
            for (const key in data.rate_count_detail) {
                count += parseInt(data.rate_count_detail[key]);
            }
            return count;
        },

        getWishlistCount: async function (rjCode) {
            const p = WorkPromise.getWorkPromise(rjCode);
            let data = await p.api;
            this.checkNotNull(data.wishlist_count);
            return data.wishlist_count;
        },

        getPriceText: async function (rjCode) {
            const p = WorkPromise.getWorkPromise(rjCode);
            //TODO: ‰ª∑Ê†º‰ª•ÂêéÂÜçÂä†ÔºåËøòË¶ÅËÄÉËôëÊ±áÁéáÂíåÊ∑ªÂä†ËÆæÁΩÆÈ°π
        },

        getBonus: async function(rjCode) {
            const p = WorkPromise.getWorkPromise(rjCode);
            let data = await p.api;
            return !data.is_sale && data.is_free && data.is_oly && data.wishlist_count === 0;
            // return data.is_bonus;
        },

        getHasBonus: async function(rjCode) {
            const p = WorkPromise.getWorkPromise(rjCode);
            let data = await p.api;
            return data.bonuses && data.bonuses.length > 0;
        },

        getTranslatable: async function(rjCode) {
            const trans = await WorkPromise.getTranslationInfo(rjCode);
            return trans.is_translation_agree === true;
        },

        getTranslated: async function(rjCode) {
            const trans = await WorkPromise.getTranslationInfo(rjCode);
            return trans.is_parent === true || trans.is_child === true;
        },

        getLanguages: async function(rjCode){
            //ËøîÂõûÂ≠óÁ¨¶‰∏≤Êï∞ÁªÑÔºåÊ†πÊçÆpopupËÆæÁΩÆÁöÑËØ≠Ë®ÄËøîÂõûÊîØÊåÅÁöÑËØ≠Ë®ÄÂàóË°®
            const map = {
                JPN: localizePopup(localizationMap.language_japanese),
                ENG: localizePopup(localizationMap.language_english),
                CHI_HANS: localizePopup(localizationMap.language_simplified_chinese),
                CHI_HANT: localizePopup(localizationMap.language_traditional_chinese),
                KO_KR: localizePopup(localizationMap.language_korean),
                SPA: localizePopup(localizationMap.language_spanish),
                FRE: localizePopup(localizationMap.language_french),
                RUS: localizePopup(localizationMap.language_russian),
                THA: localizePopup(localizationMap.language_thai),
                GER: localizePopup(localizationMap.language_german),
                FIN: localizePopup(localizationMap.language_finnish),
                POR: localizePopup(localizationMap.language_portuguese),
                VIE: localizePopup(localizationMap.language_vietnamese),
                ITA: localizePopup(localizationMap.language_italian),
                ARA: localizePopup(localizationMap.language_arabic),
                POL: localizePopup(localizationMap.language_polish),
            }
            const p = WorkPromise.getWorkPromise(rjCode);
            let api = await p.api2;
            api = api.options ? api : await p.api;
            const options = api.options?.split("#");
            const result = [];
            for (const key in map) {
                const lang = map[key];
                if(options?.includes(key)) result.push(lang);
            }
            return result;
        },

        getFileFormats: async function(rjCode){
            //ËøîÂõûÂ≠óÁ¨¶‰∏≤Êï∞ÁªÑÔºåËøîÂõûÊñá‰ª∂Ê†ºÂºèÂàóË°®
            const result = [];
            const p = WorkPromise.getWorkPromise(rjCode);
            let api = await p.api2;
            if(api.file_type === "EXE"){
                result.push("EXE");
            }else if(api.file_type_string){
                result.push(api.file_type_string);
            }
            if(api.file_type_special) result.push(api.file_type_special);

            if(!api.options) api = await p.api;
            if(api.options && api.options.includes("WPD")){
                result.push("PDF");
            }
            if(api.options && api.options.includes("WAP")){
                result.push("APK");
            }

            return result;
        },

        getAIUsedText: async function(rjCode) {
            //ËøîÂõûÊòØÂê¶‰ΩøÁî®ÊàñÈÉ®ÂàÜ‰ΩøÁî®AIÔºåÊ†πÊçÆpopupËØ≠Ë®ÄËøîÂõûÂ≠óÁ¨¶‰∏≤„ÄÇ
            const p = WorkPromise.getWorkPromise(rjCode);
            let api = await p.api2;
            api = api.options ? api : await p.api;
            const options = api.options ? api.options : "";
            if(options.includes("AIG")){
                return localizePopup(localizationMap.tag_aig);
            }else if(options.includes("AIP")){
                return localizePopup(localizationMap.tag_aip);
            }
            return null;
        },

        getDebug: async function(rjCode){
            return "";
            const work = WorkPromise.getWorkPromise(rjCode);
            const api2 = await work.api2;
            const api = await work.api;
            const info = await work.info;
            const circle = work.circle;

            return `is_ana_api2: ${api2.is_ana}<br/>
                    is_ana_api: ${api.is_ana}`;
        },

        getWorkCategory: async function(rjCode){
            const type = await WorkPromise.getWorkType(rjCode);
            /* voice: Èü≥Â£∞
             * game: Ê∏∏Êàè
             * manga: Êº´Áîª/ÊèíÁîª/Èü≥Â£∞Êº´Áîª
             * video: ËßÜÈ¢ë
             * novel: Â∞èËØ¥
             * other: ÂÖ∂ÂÆÉ
            */
            switch (type) {
                case 0:
                    return "voice";
                case 1:
                    return "game";
                case 2 || 3 || 8:
                    return "manga";
                case 5:
                    return "video";
                case 4:
                    return "novel";
                default:
                    return "other";
            }
        },

        getWorkTypeText: async function(rjCode) {
            const mapping = [
                localizePopup(localizationMap.work_type_voice),
                localizePopup(localizationMap.work_type_game),
                localizePopup(localizationMap.work_type_comic),
                localizePopup(localizationMap.work_type_illustration),
                localizePopup(localizationMap.work_type_novel),
                localizePopup(localizationMap.work_type_video),
                localizePopup(localizationMap.work_type_music),
                localizePopup(localizationMap.work_type_tool),
                localizePopup(localizationMap.work_type_voice_comic),
                localizePopup(localizationMap.work_type_other),
            ];
            return mapping[await WorkPromise.getWorkType(rjCode)];
        },

        getWorkType: async function(rjCode) {
            const p = WorkPromise.getWorkPromise(rjCode);
            const api2 = await p.api2;
            let workType = api2.work_type;
            if(!workType) workType = (await p.api).work_type;

            switch (workType) {
                case "SOU":
                    return 0;
                case (["ACN", "QIZ", "ADV", "RPG", "TBL", "DNV", "SLN", "TYP", "STG", "PZL", "ETC"]
                    .includes(workType) ? workType : "ERR"):
                    return 1;
                case (["MNG", "SCM", "WBT"]
                    .includes(workType) ? workType : "ERR"):
                    return 2;
                case "ICG":
                    return 3;
                case (["NRE", "KSV"].includes(workType) ? workType : "ERR"):
                    return 4;
                case "MOV":
                    return 5;
                case "MUS":
                    return 6;
                case (["TOL", "IMT", "AMT"]
                    .includes(workType) ? workType : "ERR"):
                    return 7;
                case "VCM":
                    return 8;
                case "ET3":
                    return 9;
                default:
                    throw new Error("Êó†Ê≥ïËé∑Âèñ‰ΩúÂìÅÁ±ªÂûã/Êú™Áü•‰ΩúÂìÅÁ±ªÂûãÔºö" + workType);
            }
        },

        getImgLink: async function(rjCode){
            let link = undefined;
            const p = WorkPromise.getWorkPromise(rjCode);

            try {
                let data = await p.api2;
                if (data.image_main && data.image_main.url) link = "https:" + data.image_main.url;
            } catch (e) {}

            if(link && !link.includes("no_img_main.gif")){
                return link;
            }

            try{
                const info = await p.info;
                WorkPromise.checkNotNull(info.img);
                return info.img;
            }catch (e) {
            }

            try{
                const apiData = await WorkPromise.getWorkPromise(rjCode).api;
                if(apiData.work_image) return "https:" + apiData.work_image;
            }catch (e){}

            throw new Error("Êó†Ê≥ïËé∑ÂèñÂõæÁâáÈìæÊé•");
        },

        getWorkTitle: async function(rjCode){
            return await WorkPromise.getWorkPromise(rjCode).translated_title;
        },

        getAgeRating: async function(rjCode){
            let p = WorkPromise.getWorkPromise(rjCode);
            let api = await p.api2;
            if(!api.age_category) api = await p.api;
            switch (api.age_category){
                case 1:
                    return "All";
                case 2:
                    return "R15";
                case 3:
                    return "R18";
            }

            const info = await p.info;
            WorkPromise.checkNotNull(info.rating);
            return info.rating;
        },

        getCircle: async function(rjCode, findOriginal = true){
            let trans = await WorkPromise.getTranslationInfo(rjCode);
            if(!trans.is_original && findOriginal){
                //‰ΩøÁî®Âéü‰ΩúRJÂè∑ÂºÄÂßãÂØªÊâæÔºåÂ¶ÇÊûúÊâæ‰∏çÂà∞ÁøªËØë‰ø°ÊÅØÂ∞±Ê≤°ÂäûÊ≥ï‰∫Ü
                rjCode = trans.original_workno ? trans.original_workno : rjCode;
            }

            let work = WorkPromise.getWorkPromise(rjCode);
            let api2 = await work.api2;
            if(api2.maker_name) return api2.maker_name;

            /**
             * Êé•‰∏ãÊù•Êúâ‰∏§ÁßçÊêúÁ¥¢ÊñπÂºèÔºö
             * 1. api1 + circleÊé•Âè£
             * 2. infoÊêúÁ¥¢
             * ÂâçËÄÖÊàêÂäüÁéáÊõ¥È´òÔºà‰∏ãÊû∂ÂêéËøòËÉΩËé∑ÂèñÂà∞api1ÔºåÁ§æÂõ¢Ê≤°Ëß£Êï£Â∞±ËÉΩËé∑ÂæóÁ§æÂõ¢‰ø°ÊÅØÔºâÔºå‰∏§‰∏™Âä†ËΩΩÈÄüÂ∫¶‰∏çÁ°ÆÂÆöË∞ÅÂø´Ë∞ÅÊÖ¢ÔºåÊâÄ‰ª•Êää1ÊîæÂú®ÂâçÈù¢
             */

            const circleInfo = await work.circle;
            if(circleInfo && circleInfo.name) return circleInfo.name;

            let info = await work.info;
            if(info.circle) return info.circle.trim();

            throw new Error("Êó†Ê≥ïËé∑ÂèñÁ§æÂõ¢‰ø°ÊÅØ");
        },

        getTranslatorName: async function(rjCode){
            let trans = await WorkPromise.getTranslationInfo(rjCode);
            if(!trans.is_child) throw new Error("ÈùûÁøªËØë‰ΩúÂìÅRJÂè∑");
            return await WorkPromise.getCircle(rjCode, false);
        },

        getReleaseDate: async function(rjCode){
            const p = WorkPromise.getWorkPromise(rjCode);
            const info = await p.info;
            if(info && !info.is_announce && info.date) return [info.date.trim(), false];
            if(info && info.is_announce && info.dateAnnounce) return [info.dateAnnounce.trim(), true];

            //‰ªéapi‰∏≠Êü•ÊâæÂèëÂîÆÊó∂Èó¥
            let api = await p.api2;
            api = api.regist_date ? api : await p.api;
            WorkPromise.checkNotNull(api.regist_date)

            return [api.regist_date, api.is_announce];
        },

        getReleaseCountDownElement: async function(rjCode) {
            const p = WorkPromise.getWorkPromise(rjCode);
            const info = await p.info;
            if(info && info.is_announce && info.dateAnnounce) {
                return DateParser.getCountDownDateElement(DateParser.parseDateStr(info.dateAnnounce, info.lang));
            }
            return null;
        },

        getUpdateDate: async function(rjCode) {
            const p = WorkPromise.getWorkPromise(rjCode);
            const info = await p.info;
            if(info["update"]) return info["update"].trim();

            throw new Error();
        },

        getScenario: async function(rjCode) {
            const p = WorkPromise.getWorkPromise(rjCode);
            const api2 = await p.api2;
            if(api2.creaters && api2.creaters.scenario_by && api2.creaters.scenario_by.length > 0){
                return api2.creaters.scenario_by.map(v => v.name);
            }

            //Êó†Ê≥ïËé∑Âèñapi2ÂàôÁõ¥Êé•ÈÄöËøáhtmlËé∑Âèñ
            const info = await WorkPromise.getWorkPromise(rjCode).info;
            WorkPromise.checkNotNull(info.scenario);
            return info.scenario;
        },

        getIllustrator: async function(rjCode) {
            const p = WorkPromise.getWorkPromise(rjCode);
            const api2 = await p.api2;
            if(api2.creaters && api2.creaters.illust_by && api2.creaters.illust_by.length > 0){
                return api2.creaters.illust_by.map(v => v.name);
            }

            //Êó†Ê≥ïËé∑Âèñapi2ÂàôÁõ¥Êé•ÈÄöËøáhtmlËé∑Âèñ
            const info = await WorkPromise.getWorkPromise(rjCode).info;
            WorkPromise.checkNotNull(info.illustration);
            return info.illustration;
        },

        getCV: async function(rjCode){
            const p = WorkPromise.getWorkPromise(rjCode);
            const api2 = await p.api2;
            if(api2.creaters && api2.creaters.voice_by && api2.creaters.voice_by.length > 0){
                return api2.creaters.voice_by.map(v => v.name);
            }

            //Êó†Ê≥ïËé∑Âèñapi2ÂàôÁõ¥Êé•ÈÄöËøáhtmlËé∑Âèñ
            const info = await WorkPromise.getWorkPromise(rjCode).info;
            WorkPromise.checkNotNull(info.cv);
            return info.cv;
        },

        getMusic: async function(rjCode) {
            const p = WorkPromise.getWorkPromise(rjCode);
            const api2 = await p.api2;
            if(api2.creaters && api2.creaters.music_by && api2.creaters.music_by.length > 0){
                return api2.creaters.music_by.map(v => v.name);
            }

            //Êó†Ê≥ïËé∑Âèñapi2ÂàôÁõ¥Êé•ÈÄöËøáhtmlËé∑Âèñ
            const info = await WorkPromise.getWorkPromise(rjCode).info;
            WorkPromise.checkNotNull(info.music);
            return info.music;
        },

        getTags: async function(rjCode) {
            //Ê≥®ÊÑèËØ•ÊñπÊ≥ïËøîÂõûÂ≠óÁ¨¶‰∏≤Êï∞ÁªÑËÄå‰∏çÊòØÁ∫ØÂ≠óÁ¨¶‰∏≤
            const p = WorkPromise.getWorkPromise(rjCode);
            const api2 = await p.api2;
            if(api2.genres && api2.genres.length > 0){
                return api2.genres.map(genre => genre.name);
            }

            //Êó†Ê≥ïËé∑Âèñapi2Êó∂ÈÄöËøáhtmlËé∑Âèñ
            const info = await p.info;
            WorkPromise.checkNotNull(info.tags);
            return info.tags;
        },

        getFileSizeStr: function(byteCount = 0){
            const units = ["B", "KB", "MB", "GB", "TB"];
            let unit = "B";
            for (let i = 1; byteCount >= 1024; i++){
                byteCount /= 1024;
                unit = units[i];
            }
            return `${Math.round(byteCount * 100) / 100}${unit}`;
        },

        getFileSize: async function(rjCode) {
            const trans = await WorkPromise.getTranslationInfo(rjCode);
            if(trans.is_parent){
                //ÁøªËØëÁâàÊú¨ÁöÑÁà∂Á∫ßÊ≤°ÊúâÂÜÖÂÆπ‰ø°ÊÅØÔºåËá™ÁÑ∂Êó†Ê≥ïÊòæÁ§∫Êñá‰ª∂Â§ßÂ∞èÔºåÊâÄ‰ª•ÈúÄË¶ÅËé∑ÂæóÂéü‰ΩúÂìÅÁöÑÂ§ßÂ∞è‰ø°ÊÅØ
                //ChildÂíåOriginalÈÉΩÊúâÂêÑËá™ÁöÑÂ§ßÂ∞è‰ø°ÊÅØÔºåÊ≠£Â∏∏Ëé∑ÂèñËÆ°ÁÆóÂç≥ÂèØ
                rjCode = trans.original_workno ? trans.original_workno : rjCode;
            }

            const p = WorkPromise.getWorkPromise(rjCode);
            let api2 = await p.api2;
            if(api2.contents_file_size && api2.contents_file_size > 0){
                return WorkPromise.getFileSizeStr(api2.contents_file_size);
            }

            //ÈÄöËøáhtmlËé∑Âèñ
            let info = trans.is_child && trans.original_workno ? await WorkPromise.getWorkPromise(trans.original_workno).info : await p.info;
            if(info.filesize) return info.filesize;

            throw new Error("Êó†Ê≥ïËé∑ÂèñÊñá‰ª∂Â§ßÂ∞è‰ø°ÊÅØ");
        },
    }

    const DLsite = {
        parseWorkDOM: function (dom, rj) {
            // workInfo: {
            //     rj: any;
            //     img: string;
            //     title: any;
            //     circle: any;
            //     date: any;
            //     rating: any;
            //     tags: any[];
            //     cv: any;
            //     filesize: any;
            //     dateAnnounce: any;
            // }
            const workInfo = {};
            workInfo.rj = rj;

            let metaList = dom.getElementsByTagName("meta")
            for (let i = 0; i < metaList.length; i++){
                let meta = metaList[i];
                if(meta.getAttribute("property") === 'og:image'){
                    workInfo.img = meta.content;
                    break;
                }
            }

            workInfo.lang = dom.querySelector("html").getAttribute("lang");
            workInfo.title = dom.getElementById("work_name").innerText;
            workInfo.circle = dom.querySelector("span.maker_name").innerText;
            workInfo.circleId = dom.querySelector("#work_maker a").href;
            workInfo.circleId = workInfo.circleId.substring(workInfo.circleId.lastIndexOf("/") + 1, workInfo.circleId.lastIndexOf(".")).trim();

            const table_outline = dom.querySelector("table#work_outline");
            for (let i = 0, ii = table_outline.rows.length; i < ii; i++) {
                const row = table_outline.rows[i];
                const row_header = row.cells[0].innerText.trim();
                const row_data = row.cells[1];
                const lambda = text => row_header === text;
                switch (true) {
                    case (["Ë≤©Â£≤Êó•", "Ë¥©ÂçñÊó•", "Ë≤©Ë≥£Êó•", "Release date", "ÌåêÎß§Ïùº", "Lanzamiento", "Ver√∂ffentlicht",
                        "Date de sortie", "Tanggal rilis", "Data di rilascio", "Lan√ßamento", "Utgivningsdatum",
                        "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢", "Ng√†y ph√°t h√†nh"].some(lambda)):
                        workInfo.date = row_data.innerText.trim();
                        break;
                    case (["Êõ¥Êñ∞ÊÉÖÂ†±", "Êõ¥Êñ∞‰ø°ÊÅØ", "Êõ¥Êñ∞Ë≥áË®ä", "Update information", "Í∞±Ïã† Ï†ïÎ≥¥", "Actualizar informaci√≥n",
                        "Aktualisierungen", "Mise √† jour des informations", "Perbarui informasi", "Aggiorna informazioni",
                        "Atualizar informa√ß√µes", "Uppdatera information", "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï", "Th√¥ng tin c·∫≠p nh·∫≠t"].some(lambda)):
                        workInfo.update = row_data.firstChild.data.trim();
                        break;
                    case (["Âπ¥ÈΩ¢ÊåáÂÆö", "Âπ¥ÈæÑÊåáÂÆö", "Âπ¥ÈΩ°ÊåáÂÆö", "Age", "Ïó∞Î†π ÏßÄÏ†ï", "Edad", "Altersfreigabe", "√Çge", "Batas usia",
                        "Et√†", "Idade", "√Ölder", "‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏≠‡∏≤‡∏¢‡∏∏", "ƒê·ªô tu·ªïi ch·ªâ ƒë·ªãnh"].some(lambda)):
                        workInfo.rating = row_data.innerText.trim();
                        break;
                    case (["„Ç∏„É£„É≥„É´", "ÂàÜÁ±ª", "ÂàÜÈ°û", "Genre", "Ïû•Î•¥", "G√©nero", "Genre", "Genre", "Genre", "Genere", "G√™nero",
                        "Genre", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó", "Th·ªÉ lo·∫°i"].some(lambda)):
                        const tag_nodes = row_data.querySelectorAll("a");
                        workInfo.tags = [...tag_nodes].map(a => { return a.innerText.trim() });
                        break;
                    case (["„Ç∑„Éä„É™„Ç™", "Scenario", "ÂâßÊÉÖ", "ÂäáÊú¨", "ÏãúÎÇòÎ¶¨Ïò§", "Gui√≥n", "Szenario", "Sc√©nario", "Skenario",
                        "Scenario", "Cen√°rio", "Scenario", "‡∏ö‡∏ó‡∏•‡∏∞‡∏Ñ‡∏£", "K·ªãch b·∫£n"].some(lambda)):
                        workInfo.scenario = row_data.innerText.trim();
                        break;
                    case (["„Ç§„É©„Çπ„Éà", "Illustration", "ÊèíÁîª", "ÊèíÁï´", "ÏùºÎü¨Ïä§Ìä∏", "Ilustraci√≥n", "AbbilDung", "Illustration",
                        "Ilustrasi", "Illustrazione", "Ilustra√ß√£o", "Illustration", "‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö", "Tranh minh h·ªça"].some(lambda)):
                        workInfo.illustration = row_data.innerText.trim();
                        break;
                    case (["Â£∞ÂÑ™", "Â£∞‰ºò", "ËÅ≤ÂÑ™", "Voice Actor", "ÏÑ±Ïö∞", "Doblador", "Synchronsprecher", "Doubleur",
                        "Pengisi suara", "Doppiatore/Doppiatrice", "Ator de voz", "R√∂stsk√•despelare", "‡∏ô‡∏±‡∏Å‡∏û‡∏≤‡∏Å‡∏¢‡πå",
                        "Di·ªÖn vi√™n l·ªìng ti·∫øng"].some(lambda)):
                        workInfo.cv = row_data.innerText.trim();
                        break;
                    case (["Èü≥Ê•Ω", "Music", "Èü≥‰πê", "Èü≥Ê®Ç", "ÏùåÏïÖ", "M√∫sica", "Musik", "Musique", "Musik", "Musica.",
                        "M√∫sica", "musik", "‡∏î‡∏ô‡∏ï‡∏£‡∏µ", "√Çm nh·∫°c"].some(lambda)):
                        workInfo.music = row_data.innerText.trim();
                        break;
                    case (["„Éï„Ç°„Ç§„É´ÂÆπÈáè", "Êñá‰ª∂ÂÆπÈáè", "Ê™îÊ°àÂÆπÈáè", "File size", "ÌååÏùº Ïö©Îüâ", "Tama√±o del Archivo", "Dateigr√∂√üe",
                        "Taille du fichier", "Ukuran file", "Dimensione del file", "Tamanho do arquivo", "Filstorlek",
                        "‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå", "Dung l∆∞·ª£ng t·ªáp"].some(lambda)):
                        workInfo.filesize = row_data.innerText.trim();
                        break;
                    default:
                        break;
                }
            }

            //Ëé∑ÂèñÂèëÂîÆÈ¢ÑÂëäÊó∂Èó¥
            const work_date_ana = dom.querySelector("strong.work_date_ana");
            if (work_date_ana) {
                workInfo.dateAnnounce = work_date_ana.innerText;
                //workInfo.img = "https://img.dlsite.jp/modpub/images2/ana/doujin/" + rj_group + "/" + rj + "_ana_img_main.jpg"
            }

            return workInfo;
        },

        // Get language code for DLSite API
        getLangCode: function (lang) {
            if(!lang) return "ja-JP";

            switch (lang.toUpperCase()) {
                case "JPN":
                    return "ja-JP";
                case "ENG":
                    return "en-US";
                case "KO_KR":
                    return "ko-KR";
                case "CHI_HANS":
                    return "zh-CN";
                case "CHI_HANT":
                    return "zh-TW";
                default:
                    return "ja-JP"
            }
        },

        parseApiData: function (rjCode, data){
            if(!data) data = {};
            let apiData = data;
            apiData.is_bonus = !data.is_sale && data.is_free && data.is_oly && data.wishlist_count === false;
            apiData.is_girls = (data.options && data.options.indexOf("OTM") >= 0) || (data.site_id === "girls");

            if(data.regist_date){
                let reg_date = data.regist_date.replace(/-/g, '/');
                let releaseDate = new Date(reg_date);
                apiData.regist_timestamp = releaseDate.getTime();
                apiData.regist_date = `${releaseDate.getFullYear()} / ${releaseDate.getMonth() + 1} / ${releaseDate.getDate()}`;
                if(apiData.regist_timestamp > Date.now()){
                    apiData.is_announce = true;
                }
            }
            return apiData;
        },

        parseApi2Data: function (rjCode, data) {
            const translation_info = data.translation_info ? data.translation_info : {};
            data.lang = DLsite.getLangCode(translation_info.lang);

            if(data.regist_date){
                let reg_date = data.regist_date.replace(/-/g, '/');
                let releaseDate = new Date(reg_date);
                data.regist_timestamp = releaseDate.getTime();
                data.regist_date = `${releaseDate.getFullYear()} / ${releaseDate.getMonth() + 1} / ${releaseDate.getDate()}`;
                if(data.regist_timestamp > Date.now()){
                    data.is_announce = true;
                }
            }

            return data;
        },

        getHttpAsync: async function (url, anonymous = false){
            return new Promise((resolve, reject) => {
                getXmlHttpRequest()({
                    method: "GET",
                    url,
                    headers: {
                        "Accept": "text/xml",
                        "User-Agent": "Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:67.0)",
                        "Cache-Control": "no-cache"
                    },
                    onload: resolve,
                    onerror: reject,
                    anonymous: anonymous
                });
            })
        },

        getAnnouncePromise: async function (rjCode, parentRJ) {
            const url = `https://www.dlsite.com/maniax/announce/=/product_id/${rjCode}.html`;
            let resp = await DLsite.getHttpAsync(url);
            if (resp.readyState === 4 && resp.status === 200) {
                const dom = new DOMParser().parseFromString(Csp.createHTML(resp.responseText), "text/html");
                const workInfo = DLsite.parseWorkDOM(dom, rjCode);
                workInfo.parentWork = parentRJ === rjCode ? null : parentRJ;
                workInfo.is_announce = true;
                return workInfo;
            }
            else if (resp.readyState === 4 && resp.status === 404) {
                return {
                    parentWork: parentRJ === rjCode ? null : parentRJ,
                    is_announce: false
                };
            }

        },

        getHtmlPromise: async function (rjCode) {
            const url = `https://www.dlsite.com/maniax/work/=/product_id/${rjCode}.html`;
            let resp = await DLsite.getHttpAsync(url);
            if (resp.readyState === 4 && resp.status === 200) {
                const dom = new DOMParser().parseFromString(Csp.createHTML(resp.responseText), "text/html");
                const workInfo = DLsite.parseWorkDOM(dom, rjCode);
                workInfo.parentWork = DLsite.getParentWorkRjCode(resp.finalUrl);
                workInfo.parentWork = workInfo.parentWork === rjCode ? null : workInfo.parentWork;
                workInfo.is_announce = false;
                return workInfo;
            }
            else if (resp.readyState === 4 && resp.status === 404) {
                return await DLsite.getAnnouncePromise(rjCode, DLsite.getParentWorkRjCode(resp.finalUrl));
            }
        },

        getApi2Promise: async function (rjCode, locale = undefined) {
            let url = `https://www.dlsite.com/maniax/api/=/product.json?workno=${rjCode}` + (locale ? `&locale=${locale}` : "");
            let resp = await DLsite.getHttpAsync(url);
            let data;
            if (resp.readyState === 4 && resp.status === 200) {
                data = JSON.parse(resp.responseText);
                data = data ? data[0] : {};
                data = data ? data : {}
            }
            else if (resp.readyState === 4 && resp.status === 404) {
                return {};
            }
            else {
                throw new Error(`Êó†Ê≥ïÈÄöËøáAPI2Ëé∑Âèñ${rjCode}ÁöÑ‰ø°ÊÅØÔºö${resp.status} ${resp.statusText}`);
            }

            return DLsite.parseApi2Data(rjCode, data);
        },

        getApiPromise: async function (rjCode, locale = undefined) {
            //Ëé∑ÂèñÂØπÂ∫îËØ≠Ë®Ä‰∏ãÁöÑÂÆûÈôÖ‰ø°ÊÅØ
            let url = `https://www.dlsite.com/maniax/product/info/ajax?product_id=${rjCode}&cdn_cache_min=1` + (locale ? `&locale=${locale}` : "");
            let resp = await DLsite.getHttpAsync(url);
            let data;
            if (resp.readyState === 4 && resp.status === 200) {
                data = JSON.parse(resp.responseText);
                data = data ? data[rjCode] : {};
                data = data ? data : {};
            }
            else if(resp.readyState === 4 && resp.status === 404){
                return {};
            }
            else {
                throw new Error(`Êó†Ê≥ïÈÄöËøáAPIËé∑Âèñ${rjCode}ÁöÑ‰ø°ÊÅØÔºö${resp.status} ${resp.statusText}`);
            }

            const translation_info = data.translation_info ? data.translation_info : {};
            data.lang = DLsite.getLangCode(translation_info.lang);

            return DLsite.parseApiData(rjCode, data);
        },

        getCirclePromise: async function (rjCode, apiPromise){
            let apiData = await apiPromise;
            if(!apiData.maker_id) return null;
            const maker_id = apiData.maker_id;

            let url;
            let resp;
            let data;
            try {
                url = `https://media.ci-en.jp/dlsite/lookup/${maker_id}.json`;
                resp = await DLsite.getHttpAsync(url);
                data = undefined;
                if (resp.readyState === 4 && resp.status === 200) {
                    data = JSON.parse(resp.responseText);
                    data = data ? data[0] : {};
                    data = data ? data : {};
                    data.maker_id = maker_id;
                }
            }catch (e){}

            if(!data || !data.name){
                //Êú™Ëé∑ÂèñÂà∞Á§æÂõ¢ÂêçÁß∞Âàô‰ΩøÁî®htmlËß£ÊûêËé∑Âèñ
                url = `https://www.dlsite.com/maniax/circle/profile/=/maker_id/${maker_id}.html`;
                resp = await DLsite.getHttpAsync(url);
                data = data ? data : {};
                if(resp.readyState === 4 && resp.status === 200){
                    let doc = new DOMParser().parseFromString(Csp.createHTML(resp.responseText), "text/html");
                    let name = doc.querySelector("strong.prof_maker_name");
                    name = name ? name.innerText : null;
                    data.name = name;
                }
            }

            return data;
        },

        getTranslatablePromise: async function (rjCode, site = "maniax") {
            rjCode = rjCode.toUpperCase();
            const result = {
                translation_request_english: {
                    agree: undefined,
                    request: undefined,
                    sale: undefined
                },
                translation_request_simplified_chinese:{
                    agree: undefined,
                    request: undefined,
                    sale: undefined
                },
                translation_request_traditional_chinese:{
                    agree: undefined,
                    request: undefined,
                    sale: undefined
                },
                translation_request_korean: {
                    agree: undefined,
                    request: undefined,
                    sale: undefined
                },
                translation_request_spanish: {
                    agree: undefined,
                    request: undefined,
                    sale: undefined
                },
                translation_request_german: {
                    agree: undefined,
                    request: undefined,
                    sale: undefined
                },
                translation_request_french: {
                    agree: undefined,
                    request: undefined,
                    sale: undefined
                },
                translation_request_indonesian: {
                    agree: undefined,
                    request: undefined,
                    sale: undefined
                },
                translation_request_italian: {
                    agree: undefined,
                    request: undefined,
                    sale: undefined
                },
                translation_request_portuguese: {
                    agree: undefined,
                    request: undefined,
                    sale: undefined
                },
                translation_request_swedish: {
                    agree: undefined,
                    request: undefined,
                    sale: undefined
                },
                translation_request_thai: {
                    agree: undefined,
                    request: undefined,
                    sale: undefined
                },
                translation_request_vietnamese: {
                    agree: undefined,
                    request: undefined,
                    sale: undefined
                },
            };
            const data = await DLsite.getTranslatableApiPromise(rjCode, site);
            if(!data.translationStatusForTranslator){
                return result;
            }

            const map = {
                translation_request_english: "ENG",
                translation_request_simplified_chinese: "CHI_HANS",
                translation_request_traditional_chinese: "CHI_HANT",
                translation_request_korean: "KO_KR",
                translation_request_spanish: "SPA",
                translation_request_german: "GER",
                translation_request_french: "FRE",
                translation_request_indonesian: "IND",
                translation_request_italian: "ITA",
                translation_request_portuguese: "POR",
                translation_request_swedish: "SWE",
                translation_request_thai: "THA",
                translation_request_vietnamese: "VIE",
            };
            for (let key in map) {
                let lang = map[key];
                let status = data.translationStatusForTranslator[lang];
                if(!status){
                    //Áä∂ÂÜµÊú™Áü•
                    continue;
                }
                result[key].agree = status.available;
                result[key].request = status.count;
                result[key].sale = status.on_sale_count;
            }

            return result;
        },

        getTranslatableApiPromise: async function (rjCode, site = "maniax") {
            //Êñ∞ÁöÑÂèØÁî®apiÔºåÁî®‰∫éÊêúÁ¥¢‰ΩúÂìÅÁøªËØëÊÉÖÂÜµÔºå‰ΩÜ‰πüÂèØ‰ª•Ëé∑ÂæóÂÖ∂ÂÆÉ‰ø°ÊÅØ„ÄÇ
            rjCode = rjCode.toUpperCase();
            let url = `https://www.dlsite.com/${site}/api/=/translatableProducts.json?keyword=${rjCode}`;    //ÂèØ‰ª•‰ΩøÁî®localeÂèÇÊï∞ÊåáÂÆöËØ≠Ë®ÄÔºå‰ΩÜËøôÈáå‰∏çÈúÄË¶Å
            let resp = await DLsite.getHttpAsync(url, true);
            let data;
            if (resp.readyState === 4 && resp.status === 200) {
                data = JSON.parse(resp.responseText);
            }
            else {
                throw new Error(`Êó†Ê≥ïÈÄöËøáAPIËé∑Âèñ${rjCode}ÁöÑÁøªËØë‰ø°ÊÅØÔºö${resp.status} ${resp.statusText}`);
            }

            //‰ªéÁªìÊûú‰∏≠ÊâæÂà∞ÂØπÂ∫îRJÂè∑ÔºåÁî±‰∫éÂÖ≥ÈîÆÂ≠óÊòØRJÂè∑ÁöÑËØùÁªìÊûú‰∏ÄËà¨ÈÉΩÂú®Á¨¨‰∏ÄÈ°µÔºåÊâÄ‰ª•Â∞±ÊîæÂºÉÁøªÈ°µÂØªÊâæ‰∫Ü
            if(data.meta && data.meta.code !== 200){
                throw new Error(`Êó†Ê≥ïÈÄöËøáAPIÊü•ËØ¢${rjCode}ÁöÑÁøªËØë‰ø°ÊÅØÔºö${data.meta.code} - ${data.meta.errorType} - ${data.meta.errorMessage}`);
            }
            if(!data.data || !Array.isArray(data.data.products)){
                throw new Error(`Êó†Ê≥ïÈÄöËøáAPIÊü•ËØ¢${rjCode}ÁöÑÁøªËØë‰ø°ÊÅØÔºöÊú™È¢ÑÊñôÂà∞ÁöÑÂìçÂ∫îÊ†ºÂºè„ÄÇ`);
            }

            for (const work of data.data.products) {
                if(work.id === rjCode){
                    return work;
                }
            }

            //Êú™ÊâæÂà∞ÂàôËøîÂõûÁ©∫ÂØπË±°
            return {};

        },

        getWorkRequestPromise: function (rjCode) {
            return {
                _info: undefined,
                _api: undefined,
                _api2: undefined,
                _circle: undefined,
                _translatable: undefined,
                _translated_title: undefined,
                get info(){
                    return this._info ? this._info : this._info = DLsite.getHtmlPromise(rjCode);
                },
                get api() {
                    return this._api ? this._api : this._api = DLsite.getApiPromise(rjCode);
                },
                get api2() {
                    return this._api2 ? this._api2 : this._api2 = DLsite.getApi2Promise(rjCode);
                },
                get circle(){
                    return this._circle ? this._circle : this._circle = DLsite.getCirclePromise(rjCode, this.api);
                },
                get translatable() {
                    async function getter(t){
                        let api = await t.api2;
                        if(!api.site_id) api = await t.api;

                        return t._translatable ? t._translatable : t._translatable = DLsite.getTranslatablePromise(rjCode,
                            api.site_id ? api.site_id : "maniax");
                    }
                    return getter(this);
                },
                get translated_title(){
                    async function getter(t){
                        if(t._translated_title) return t._translated_title;

                        let api = await t.api2;
                        if(api.translation_info){
                            //api2ÊúâÊïà
                            if(!api.translation_info.is_original) {
                                //ÈÄöËøáÂÜçÊ¨°Êü•ËØ¢Ëé∑ÂæóÁøªËØëÊ†áÈ¢ò
                                api = await DLsite.getApi2Promise(rjCode, api.lang);
                            }
                            t._translated_title = api.work_name;
                            return t._translated_title;
                        }

                        //api2Êó†ÊïàÔºåÈÄöËøáapiÊü•ËØ¢
                        api = await t.api;
                        if(!api.translation_info){
                            //apiÊó†ÊïàÂàôÊó†Ê≥ïËé∑ÂèñÊ†áÈ¢òÔºàÁΩëÈ°µËé∑ÂèñÂ∏åÊúõÊ∏∫Ëå´Ôºâ
                            t._translated_title = null;
                            return null;
                        }

                        if(!api.translation_info.is_original) {
                            //ÈùûÂéü‰ΩúÂàôÂÜçÊ¨°Êü•ËØ¢
                            api = await DLsite.getApiPromise(rjCode, api.lang);
                        }
                        t._translated_title = api.work_name;
                        return t._translated_title;
                    }

                    return getter(this);
                }
            }
        },

        getParentWorkRjCode: function (redirectUrl){
            const reg = new RegExp("(?<=product_id/)((R[JE][0-9]{8})|(R[JE][0-9]{6})|([VB]J[0-9]{8})|([VB]J[0-9]{6}))")
            return redirectUrl.match(reg)[0];
        }
    }

    function getSettingsUi() {
        return {
            //Ëøô‰∏ÄÂ±ÇÊòØËÆæÁΩÆÁïåÈù¢ÊúÄÈ°∂Â±ÇÔºåÁºñËæëÂ§ßÊ†áÈ¢ò‰ø°ÊÅØ
            title: localize(localizationMap.title_settings),
            items: [
                {
                    //Ëøô‰∏ÄÂ±ÇÊòØËÆæÁΩÆÁïåÈù¢ÁöÑÂ§ßÂàÜÁ±ª
                    title: localize(localizationMap.title_language_settings),
                    items: [
                        {
                            //Ëøô‰∏ÄÂ±ÇÊòØËÆæÁΩÆÈ°πÂàóË°®ÈõÜÂêàÔºà‰ΩøÁî®Ë°®Ê†ºÂëàÁé∞ËÆæÁΩÆÈ°πÔºâ"
                            items: [
                                {
                                    //Ëøô‰∏ÄÂ±ÇÊòØËÆæÁΩÆÈ°π
                                    type: "dropdown",
                                    title: localize(localizationMap.display_language),
                                    id: "lang",
                                    ignore_reset: true,
                                    options: [
                                        {
                                            title: "ÁÆÄ‰Ωì‰∏≠Êñá",
                                            value: "zh_CN"
                                        },
                                        {
                                            title: "ÁπÅÈ´î‰∏≠Êñá",
                                            value: "zh_TW"
                                        },
                                        {
                                            title: "English",
                                            value: "en_US"
                                        }
                                    ]
                                },
                                {
                                    //Ëøô‰∏ÄÂ±ÇÊòØËÆæÁΩÆÈ°π
                                    type: "dropdown",
                                    title: localize(localizationMap.popup_language),
                                    id: "popup_lang",
                                    ignore_reset: true,
                                    tooltip: localize(localizationMap.popup_language_tooltip),
                                    options: [
                                        {
                                            title: "ÁÆÄ‰Ωì‰∏≠Êñá",
                                            value: "zh_CN"
                                        },
                                        {
                                            title: "ÁπÅÈ´î‰∏≠Êñá",
                                            value: "zh_TW"
                                        },
                                        {
                                            title: "English",
                                            value: "en_US"
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },

                {
                    //Ëøô‰∏ÄÂ±ÇÊòØËÆæÁΩÆÁïåÈù¢ÁöÑÂ§ßÂàÜÁ±ª
                    title: localize(localizationMap.title_general_settings),
                    items: [
                        {
                            //Ëøô‰∏ÄÂ±ÇÊòØËÆæÁΩÆÈ°πÂàóË°®ÈõÜÂêàÔºà‰ΩøÁî®Ë°®Ê†ºÂëàÁé∞ËÆæÁΩÆÈ°πÔºâ
                            items: [
                                {
                                    //Ëß£ÊûêURL
                                    type: "checkbox",
                                    title: localize(localizationMap.parse_url),
                                    id: "parse_url",
                                    tooltip: localize(localizationMap.parse_url_tooltip)
                                },
                                {
                                    //DL‰∏äËß£ÊûêURL
                                    binding: {
                                        target: "parse_url",
                                        value: true
                                    },

                                    type: "checkbox",
                                    title: localize(localizationMap.parse_url_in_dl),
                                    id: "parse_url_in_dl",
                                    indent: 1,  //ËÆæÁΩÆÈ°πÁº©Ëøõ
                                    tooltip: localize(localizationMap.parse_url_in_dl_tooltip)
                                },
                                {
                                    //DLÊòæÁ§∫ÁøªËØëÊ†áÈ¢ò
                                    type: "checkbox",
                                    title: localize(localizationMap.show_translated_title_in_dl),
                                    id: "show_translated_title_in_dl",
                                    tooltip: localize(localizationMap.show_translated_title_in_dl_tooltip)
                                },
                                {
                                    //‚ÄúÂ§çÂà∂‰∏∫ÊúâÊïàÊñá‰ª∂Âêç‚ÄùÊåâÈíÆ
                                    type: "checkbox",
                                    title: localize(localizationMap.copy_as_filename_btn),
                                    id: "copy_as_filename_btn",
                                    tooltip: localize(localizationMap.copy_as_filename_btn_tooltip)
                                },
                                {
                                    //**ÊòæÁ§∫ÂÖºÂÆπÊÄßË≠¶Âëä**
                                    type: "checkbox",
                                    title: `<strong>**${localize(localizationMap.show_compatibility_warning)}**</strong>`,
                                    id: "show_compatibility_warning",
                                    tooltip: localize(localizationMap.show_compatibility_warning_tooltip)
                                },
                                {
                                    //ÂØºÂêëÊñáÊú¨ÊèíÂÖ•ÊñπÂºè
                                    type: "dropdown",
                                    title: localize(localizationMap.url_insert_mode),
                                    id: "url_insert_mode",
                                    tooltip: localize(localizationMap.url_insert_mode_tooltip),
                                    options: [
                                        {
                                            title: localize(localizationMap.url_insert_mode_none),
                                            value: "none"
                                        },
                                        {
                                            title: localize(localizationMap.url_insert_mode_prefix),
                                            value: "prefix"
                                        },
                                        {
                                            title: localize(localizationMap.url_insert_mode_before_rj),
                                            value: "before_rj"
                                        }
                                    ]
                                },
                                {
                                    //ÂØºÂêëÊñáÊú¨
                                    type: "input",
                                    title: localize(localizationMap.url_insert_text),
                                    id: "url_insert_text",
                                    indent: 1
                                },

                                {
                                    //NSFWÊ®°Âºè
                                    type: "checkbox",
                                    title: localize(localizationMap.sfw_mode),
                                    id: "sfw_mode",
                                    tooltip: localize(localizationMap.sfw_mode_tooltip)
                                },
                                {
                                    //Ê®°Á≥äÁ®ãÂ∫¶
                                    binding: {
                                        target: "sfw_mode",
                                        value: true
                                    },

                                    type: "dropdown",
                                    title: localize(localizationMap.sfw_blur_level),
                                    id: "sfw_blur_level",
                                    indent: 1,
                                    options: [
                                        {
                                            title: localize(localizationMap.low),
                                            value: "low"
                                        },
                                        {
                                            title: localize(localizationMap.medium),
                                            value: "medium"
                                        },
                                        {
                                            title: localize(localizationMap.high),
                                            value: "high"
                                        }
                                    ]
                                },
                                {
                                    //Èº†Ê†áÁßªËá≥ÂõæÁâá‰∏äÊñπÁßªÈô§Ê®°Á≥ä
                                    binding: {
                                        target: "sfw_mode",
                                        value: true
                                    },

                                    type: "checkbox",
                                    title: localize(localizationMap.sfw_remove_when_hover),
                                    id: "sfw_remove_when_hover",
                                    indent: 1,
                                },
                                {
                                    //ÊòØÂê¶ÂºÄÂêØÊ®°Á≥äÂä®Áîª
                                    binding: {
                                        target: "sfw_mode",
                                        value: true
                                    },

                                    type: "checkbox",
                                    title: localize(localizationMap.sfw_blur_transition),
                                    id: "sfw_blur_transition",
                                    indent: 1,
                                }
                            ]
                        }
                    ]
                },
                {
                    //ÂàÜÁ±ªÔºö‰ø°ÊÅØÊòæÁ§∫
                    title: localize(localizationMap.title_info_settings),
                    items: [
                        {
                            //È¢ÑËÆæË°®Ê†º
                            items: [
                                {
                                    type: "dropdown",
                                    title: localize(localizationMap.category_preset),
                                    id: "category_preset",
                                    tooltip: localize(localizationMap.category_preset_tooltip),
                                    ignore_reset: true,  //‰∏çÊòæÁ§∫ÈáçÁΩÆÊåâÈíÆ
                                    options: [
                                        {
                                            title: localize(localizationMap.work_type_voice),
                                            value: "voice"
                                        },
                                        {
                                            title: localize(localizationMap.work_type_game),
                                            value: "game"
                                        },
                                        {
                                            title: `${localize(localizationMap.work_type_comic)} / ${localize(localizationMap.work_type_illustration)} / ${localize(localizationMap.work_type_voice_comic)}`,
                                            value: "manga"
                                        },
                                        {
                                            title: localize(localizationMap.work_type_video),
                                            value: "video"
                                        },
                                        {
                                            title: localize(localizationMap.work_type_novel),
                                            value: "novel"
                                        },
                                        {
                                            title: localize(localizationMap.work_type_other),
                                            value: "other"
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            //Èü≥Â£∞PresetÂØπÂ∫îÁöÑË°®Ê†ºÔºåÊ≥®ÊÑè‰ΩøÁî®BindingÊù•ÂÜ≥ÂÆöË°®Ê†ºÊòØÂê¶ÊòæÁ§∫
                            binding: {
                                target: "category_preset",
                                value: "voice"
                            },
                            sortable: true,  //‰∏∫trueÂàô‰ª£Ë°®ËØ•Ë°®Ê†ºÂÜÖÁöÑË°åÂèØ‰ª•ÊéíÂ∫è
                            sort_id: "voice__info_display_order",  //Ëã•ÊéíÂ∫èÂàô‰∏ÄÂÆöË¶ÅÊåáÂÆöidÔºåËØ•idÂ∞Ü‰ºöÂ≠òÂÇ®Âú®ËÆæÁΩÆÈ°π‰∏≠Ôºå‰Ωú‰∏∫ÂàóË°®ËÆ∞ÂΩïÊØè‰∏™ÂÖÉÁ¥†ÁöÑÈ°∫Â∫è
                            items: [
                                {
                                    //ÈîÄÈáè
                                    type: "checkbox",
                                    title: localize(localizationMap.dl_count),
                                    id: "voice__dl_count",  //Ê≥®ÊÑèËøôÈáå‰∏çÂêåÁöÑpresetË¶ÅÊîπÊàê‰∏çÂêåÁöÑÂÄº
                                },
                                {
                                    //Á§æÂõ¢Âêç
                                    type: "checkbox",
                                    title: localize(localizationMap.circle_name),
                                    id: "voice__circle_name",  //Ê≥®ÊÑèËøôÈáå‰∏çÂêåÁöÑpresetË¶ÅÊîπÊàê‰∏çÂêåÁöÑÂÄº
                                },
                                {
                                    //ÁøªËØëËÄÖ
                                    type: "checkbox",
                                    title: localize(localizationMap.translator_name),
                                    id: "voice__translator_name",
                                },
                                {
                                    //ÂèëÂîÆÊó•
                                    type: "checkbox",
                                    title: localize(localizationMap.release_date),
                                    id: "voice__release_date",
                                },
                                {
                                    //Êõ¥Êñ∞Êó•
                                    type: "checkbox",
                                    title: localize(localizationMap.update_date),
                                    id: "voice__update_date",
                                },
                                {
                                    //Âπ¥ÈæÑÊåáÂÆö
                                    type: "checkbox",
                                    title: localize(localizationMap.age_rating),
                                    id: "voice__age_rating",
                                },
                                {
                                    //ÂâßÊÉÖ‰ΩúËÄÖ
                                    type: "checkbox",
                                    title: localize(localizationMap.scenario),
                                    id: "voice__scenario",
                                },
                                {
                                    //ÊèíÁîª‰ΩúËÄÖ
                                    type: "checkbox",
                                    title: localize(localizationMap.illustration),
                                    id: "voice__illustration",
                                },
                                {
                                    //ÈÖçÈü≥ËÄÖ
                                    type: "checkbox",
                                    title: localize(localizationMap.voice_actor),
                                    id: "voice__voice_actor",
                                },
                                {
                                    //Èü≥‰πê‰ΩúËÄÖ
                                    type: "checkbox",
                                    title: localize(localizationMap.music),
                                    id: "voice__music",
                                },
                                {
                                    //‰ΩúÂìÅÊ†áÁ≠æ/ÂàÜÁ±ª
                                    type: "checkbox",
                                    title: localize(localizationMap.genre),
                                    id: "voice__genre",
                                },
                                {
                                    //Êñá‰ª∂Â§ßÂ∞è
                                    type: "checkbox",
                                    title: localize(localizationMap.file_size),
                                    id: "voice__file_size",
                                }
                            ]
                        },
                        {
                            //Ê∏∏ÊàèPresetÂØπÂ∫îÁöÑË°®Ê†º
                            binding: {
                                target: "category_preset",
                                value: "game"
                            },
                            sortable: true,  //‰∏∫trueÂàô‰ª£Ë°®ËØ•Ë°®Ê†ºÂÜÖÁöÑË°åÂèØ‰ª•ÊéíÂ∫è
                            sort_id: "game__info_display_order",
                            items: [
                                {
                                    //ÈîÄÈáè
                                    type: "checkbox",
                                    title: localize(localizationMap.dl_count),
                                    id: "game__dl_count",
                                },
                                {
                                    //Á§æÂõ¢Âêç
                                    type: "checkbox",
                                    title: localize(localizationMap.circle_name),
                                    id: "game__circle_name",
                                },
                                {
                                    //ÁøªËØëËÄÖ
                                    type: "checkbox",
                                    title: localize(localizationMap.translator_name),
                                    id: "game__translator_name",
                                },
                                {
                                    //ÂèëÂîÆÊó•
                                    type: "checkbox",
                                    title: localize(localizationMap.release_date),
                                    id: "game__release_date",
                                },
                                {
                                    //Êõ¥Êñ∞Êó•
                                    type: "checkbox",
                                    title: localize(localizationMap.update_date),
                                    id: "game__update_date",
                                },
                                {
                                    //Âπ¥ÈæÑÊåáÂÆö
                                    type: "checkbox",
                                    title: localize(localizationMap.age_rating),
                                    id: "game__age_rating",
                                },
                                {
                                    //ÂâßÊÉÖ‰ΩúËÄÖ
                                    type: "checkbox",
                                    title: localize(localizationMap.scenario),
                                    id: "game__scenario",
                                },
                                {
                                    //ÊèíÁîª‰ΩúËÄÖ
                                    type: "checkbox",
                                    title: localize(localizationMap.illustration),
                                    id: "game__illustration",
                                },
                                {
                                    //ÈÖçÈü≥ËÄÖ
                                    type: "checkbox",
                                    title: localize(localizationMap.voice_actor),
                                    id: "game__voice_actor",
                                },
                                {
                                    //Èü≥‰πê‰ΩúËÄÖ
                                    type: "checkbox",
                                    title: localize(localizationMap.music),
                                    id: "game__music",
                                },
                                {
                                    //‰ΩúÂìÅÊ†áÁ≠æ/ÂàÜÁ±ª
                                    type: "checkbox",
                                    title: localize(localizationMap.genre),
                                    id: "game__genre",
                                },
                                {
                                    //Êñá‰ª∂Â§ßÂ∞è
                                    type: "checkbox",
                                    title: localize(localizationMap.file_size),
                                    id: "game__file_size",
                                }
                            ]
                        },
                        {
                            //Êº´ÁîªÂØπÂ∫îpreset
                            binding: {
                                target: "category_preset",
                                value: "manga"
                            },
                            sortable: true,  //‰∏∫trueÂàô‰ª£Ë°®ËØ•Ë°®Ê†ºÂÜÖÁöÑË°åÂèØ‰ª•ÊéíÂ∫è
                            sort_id: "manga__info_display_order",
                            items: [
                                {
                                    //ÈîÄÈáè
                                    type: "checkbox",
                                    title: localize(localizationMap.dl_count),
                                    id: "manga__dl_count",
                                },
                                {
                                    //Á§æÂõ¢Âêç
                                    type: "checkbox",
                                    title: localize(localizationMap.circle_name),
                                    id: "manga__circle_name",
                                },
                                {
                                    //ÁøªËØëËÄÖ
                                    type: "checkbox",
                                    title: localize(localizationMap.translator_name),
                                    id: "manga__translator_name",
                                },
                                {
                                    //ÂèëÂîÆÊó•
                                    type: "checkbox",
                                    title: localize(localizationMap.release_date),
                                    id: "manga__release_date",
                                },
                                {
                                    //Êõ¥Êñ∞Êó•
                                    type: "checkbox",
                                    title: localize(localizationMap.update_date),
                                    id: "manga__update_date",
                                },
                                {
                                    //Âπ¥ÈæÑÊåáÂÆö
                                    type: "checkbox",
                                    title: localize(localizationMap.age_rating),
                                    id: "manga__age_rating",
                                },
                                {
                                    //ÂâßÊÉÖ‰ΩúËÄÖ
                                    type: "checkbox",
                                    title: localize(localizationMap.scenario),
                                    id: "manga__scenario",
                                },
                                {
                                    //ÊèíÁîª‰ΩúËÄÖ
                                    type: "checkbox",
                                    title: localize(localizationMap.illustration),
                                    id: "manga__illustration",
                                },
                                {
                                    //ÈÖçÈü≥ËÄÖ
                                    type: "checkbox",
                                    title: localize(localizationMap.voice_actor),
                                    id: "manga__voice_actor",
                                    tooltip: localize(localizationMap.work_type_voice_comic)
                                },
                                {
                                    //Èü≥‰πê‰ΩúËÄÖ
                                    type: "checkbox",
                                    title: localize(localizationMap.music),
                                    id: "manga__music",
                                },
                                {
                                    //‰ΩúÂìÅÊ†áÁ≠æ/ÂàÜÁ±ª
                                    type: "checkbox",
                                    title: localize(localizationMap.genre),
                                    id: "manga__genre",
                                },
                                {
                                    //Êñá‰ª∂Â§ßÂ∞è
                                    type: "checkbox",
                                    title: localize(localizationMap.file_size),
                                    id: "manga__file_size",
                                }
                            ]
                        },
                        {
                            //ËßÜÈ¢ëÂØπÂ∫îpreset
                            binding: {
                                target: "category_preset",
                                value: "video"
                            },
                            sortable: true,  //‰∏∫trueÂàô‰ª£Ë°®ËØ•Ë°®Ê†ºÂÜÖÁöÑË°åÂèØ‰ª•ÊéíÂ∫è
                            sort_id: "video__info_display_order",
                            items: [
                                {
                                    //ÈîÄÈáè
                                    type: "checkbox",
                                    title: localize(localizationMap.dl_count),
                                    id: "video__dl_count",
                                },
                                {
                                    //Á§æÂõ¢Âêç
                                    type: "checkbox",
                                    title: localize(localizationMap.circle_name),
                                    id: "video__circle_name",
                                },
                                {
                                    //ÁøªËØëËÄÖ
                                    type: "checkbox",
                                    title: localize(localizationMap.translator_name),
                                    id: "video__translator_name",
                                },
                                {
                                    //ÂèëÂîÆÊó•
                                    type: "checkbox",
                                    title: localize(localizationMap.release_date),
                                    id: "video__release_date",
                                },
                                {
                                    //Êõ¥Êñ∞Êó•
                                    type: "checkbox",
                                    title: localize(localizationMap.update_date),
                                    id: "video__update_date",
                                },
                                {
                                    //Âπ¥ÈæÑÊåáÂÆö
                                    type: "checkbox",
                                    title: localize(localizationMap.age_rating),
                                    id: "video__age_rating",
                                },
                                {
                                    //ÂâßÊÉÖ‰ΩúËÄÖ
                                    type: "checkbox",
                                    title: localize(localizationMap.scenario),
                                    id: "video__scenario",
                                },
                                {
                                    //ÊèíÁîª‰ΩúËÄÖ
                                    type: "checkbox",
                                    title: localize(localizationMap.illustration),
                                    id: "video__illustration",
                                },
                                {
                                    //ÈÖçÈü≥ËÄÖ
                                    type: "checkbox",
                                    title: localize(localizationMap.voice_actor),
                                    id: "video__voice_actor",
                                },
                                {
                                    //Èü≥‰πê‰ΩúËÄÖ
                                    type: "checkbox",
                                    title: localize(localizationMap.music),
                                    id: "video__music",
                                },
                                {
                                    //‰ΩúÂìÅÊ†áÁ≠æ/ÂàÜÁ±ª
                                    type: "checkbox",
                                    title: localize(localizationMap.genre),
                                    id: "video__genre",
                                },
                                {
                                    //Êñá‰ª∂Â§ßÂ∞è
                                    type: "checkbox",
                                    title: localize(localizationMap.file_size),
                                    id: "video__file_size",
                                }
                            ]
                        },
                        {
                            //Â∞èËØ¥ÂØπÂ∫îPreset
                            binding: {
                                target: "category_preset",
                                value: "novel"
                            },
                            sortable: true,  //‰∏∫trueÂàô‰ª£Ë°®ËØ•Ë°®Ê†ºÂÜÖÁöÑË°åÂèØ‰ª•ÊéíÂ∫è
                            sort_id: "novel__info_display_order",
                            items: [
                                {
                                    //ÈîÄÈáè
                                    type: "checkbox",
                                    title: localize(localizationMap.dl_count),
                                    id: "novel__dl_count",
                                },
                                {
                                    //Á§æÂõ¢Âêç
                                    type: "checkbox",
                                    title: localize(localizationMap.circle_name),
                                    id: "novel__circle_name",
                                },
                                {
                                    //ÁøªËØëËÄÖ
                                    type: "checkbox",
                                    title: localize(localizationMap.translator_name),
                                    id: "novel__translator_name",
                                },
                                {
                                    //ÂèëÂîÆÊó•
                                    type: "checkbox",
                                    title: localize(localizationMap.release_date),
                                    id: "novel__release_date",
                                },
                                {
                                    //Êõ¥Êñ∞Êó•
                                    type: "checkbox",
                                    title: localize(localizationMap.update_date),
                                    id: "novel__update_date",
                                },
                                {
                                    //Âπ¥ÈæÑÊåáÂÆö
                                    type: "checkbox",
                                    title: localize(localizationMap.age_rating),
                                    id: "novel__age_rating",
                                },
                                {
                                    //ÂâßÊÉÖ‰ΩúËÄÖ
                                    type: "checkbox",
                                    title: localize(localizationMap.scenario),
                                    id: "novel__scenario",
                                },
                                {
                                    //ÊèíÁîª‰ΩúËÄÖ
                                    type: "checkbox",
                                    title: localize(localizationMap.illustration),
                                    id: "novel__illustration",
                                },
                                {
                                    //ÈÖçÈü≥ËÄÖ
                                    type: "checkbox",
                                    title: localize(localizationMap.voice_actor),
                                    id: "novel__voice_actor",
                                },
                                {
                                    //Èü≥‰πê‰ΩúËÄÖ
                                    type: "checkbox",
                                    title: localize(localizationMap.music),
                                    id: "novel__music",
                                },
                                {
                                    //‰ΩúÂìÅÊ†áÁ≠æ/ÂàÜÁ±ª
                                    type: "checkbox",
                                    title: localize(localizationMap.genre),
                                    id: "novel__genre",
                                },
                                {
                                    //Êñá‰ª∂Â§ßÂ∞è
                                    type: "checkbox",
                                    title: localize(localizationMap.file_size),
                                    id: "novel__file_size",
                                }
                            ]
                        },
                        {
                            //ÂÖ∂‰ªñÂØπÂ∫îPreset
                            binding: {
                                target: "category_preset",
                                value: "other"
                            },
                            sortable: true,  //‰∏∫trueÂàô‰ª£Ë°®ËØ•Ë°®Ê†ºÂÜÖÁöÑË°åÂèØ‰ª•ÊéíÂ∫è
                            sort_id: "other__info_display_order",
                            items: [
                                {
                                    //ÈîÄÈáè
                                    type: "checkbox",
                                    title: localize(localizationMap.dl_count),
                                    id: "other__dl_count",
                                },
                                {
                                    //Á§æÂõ¢Âêç
                                    type: "checkbox",
                                    title: localize(localizationMap.circle_name),
                                    id: "other__circle_name",
                                },
                                {
                                    //ÁøªËØëËÄÖ
                                    type: "checkbox",
                                    title: localize(localizationMap.translator_name),
                                    id: "other__translator_name",
                                },
                                {
                                    //ÂèëÂîÆÊó•
                                    type: "checkbox",
                                    title: localize(localizationMap.release_date),
                                    id: "other__release_date",
                                },
                                {
                                    //Êõ¥Êñ∞Êó•
                                    type: "checkbox",
                                    title: localize(localizationMap.update_date),
                                    id: "other__update_date",
                                },
                                {
                                    //Âπ¥ÈæÑÊåáÂÆö
                                    type: "checkbox",
                                    title: localize(localizationMap.age_rating),
                                    id: "other__age_rating",
                                },
                                {
                                    //ÂâßÊÉÖ‰ΩúËÄÖ
                                    type: "checkbox",
                                    title: localize(localizationMap.scenario),
                                    id: "other__scenario",
                                },
                                {
                                    //ÊèíÁîª‰ΩúËÄÖ
                                    type: "checkbox",
                                    title: localize(localizationMap.illustration),
                                    id: "other__illustration",
                                },
                                {
                                    //ÈÖçÈü≥ËÄÖ
                                    type: "checkbox",
                                    title: localize(localizationMap.voice_actor),
                                    id: "other__voice_actor",
                                },
                                {
                                    //Èü≥‰πê‰ΩúËÄÖ
                                    type: "checkbox",
                                    title: localize(localizationMap.music),
                                    id: "other__music",
                                },
                                {
                                    //‰ΩúÂìÅÊ†áÁ≠æ/ÂàÜÁ±ª
                                    type: "checkbox",
                                    title: localize(localizationMap.genre),
                                    id: "other__genre",
                                },
                                {
                                    //Êñá‰ª∂Â§ßÂ∞è
                                    type: "checkbox",
                                    title: localize(localizationMap.file_size),
                                    id: "other__file_size",
                                }
                            ]
                        }
                    ]
                },
                {
                    //ÂàÜÁ±ªÔºöÊ†áÁ≠æÊòæÁ§∫
                    title: localize(localizationMap.title_tag_settings),
                    items: [
                        {
                            //ÊÄªÂºÄÂÖ≥Ë°®Ê†º
                            items: [
                                {
                                    type: "checkbox",
                                    title: localize(localizationMap.tag_main_switch),
                                    tooltip: localize(localizationMap.tag_main_switch_tooltip),
                                    id: "tag_main_switch"
                                },
                                {
                                    //ÊòæÁ§∫ËØÑÂàÜ‰∫∫Êï∞
                                    type: "checkbox",
                                    title: localize(localizationMap.show_rate_count),
                                    id: "show_rate_count",
                                    indent: 1
                                }
                            ]
                        },
                        {
                            //Ê†áÁ≠æÂºÄÂÖ≥Ë°®Ê†º
                            binding: {
                                target: "tag_main_switch",
                                value: true
                            },
                            items: [
                                {
                                    //ÊâÄÊúâÁöÑÊ†áÁ≠æÂºÄÂÖ≥ÈõÜÂêà
                                    type: "tag_switch",
                                    //Ê†áÁ≠æ‰πãÈó¥ÂèØ‰ª•ÊéíÂ∫è
                                    sortable: true,
                                    sort_id: "tag_display_order",
                                    items: [
                                        {
                                            //ÈîÄÈáè
                                            title: localize(localizationMap.rate),
                                            id: "tag_rate",
                                            class: "tag-yellow",
                                            tooltip: localize(localizationMap.rate_tooltip)
                                        },
                                        {
                                            //‰ΩúÂìÅÁ±ªÂûã
                                            title: localize(localizationMap.tag_work_type),
                                            id: "tag_work_type",
                                            class: "tag-darkblue",
                                            tooltip: `
<div class="${VOICELINK_CLASS}_tags">
    <span class="${VOICELINK_CLASS}_tag-purple">${localize(localizationMap.work_type_game)}</span>
    <span class="${VOICELINK_CLASS}_tag-green">${localize(localizationMap.work_type_comic)}</span>
    <span class="${VOICELINK_CLASS}_tag-teal">${localize(localizationMap.work_type_illustration)}</span>
    <span class="${VOICELINK_CLASS}_tag-gray">${localize(localizationMap.work_type_novel)}</span>
    <span class="${VOICELINK_CLASS}_tag-darkblue">${localize(localizationMap.work_type_video)}</span>
    <span class="${VOICELINK_CLASS}_tag-orange">${localize(localizationMap.work_type_voice)}</span>
    <span class="${VOICELINK_CLASS}_tag-yellow">${localize(localizationMap.work_type_music)}</span>
    <span class="${VOICELINK_CLASS}_tag-gray">${localize(localizationMap.work_type_tool)}</span>
    <span class="${VOICELINK_CLASS}_tag-blue">${localize(localizationMap.work_type_voice_comic)}</span>
    <span class="${VOICELINK_CLASS}_tag-gray">${localize(localizationMap.work_type_other)}</span>
</div>`,
                                        },
                                        {
                                            //ÂèØÁøªËØë
                                            title: localize(localizationMap.tag_translatable),
                                            id: "tag_translatable",
                                            class: "tag-green",
                                            tooltip: localize(localizationMap.tag_translatable_tooltip)
                                        },
                                        {
                                            //‰∏çÂèØÁøªËØë
                                            title: localize(localizationMap.tag_not_translatable),
                                            id: "tag_not_translatable",
                                            class: "tag-red",
                                            tooltip: localize(localizationMap.tag_not_translatable_tooltip)
                                        },
                                        {
                                            //ÁøªËØë‰ΩúÂìÅ
                                            title: localize(localizationMap.tag_translated),
                                            id: "tag_translated",
                                            class: "tag-teal",
                                            tooltip: localize(localizationMap.tag_translated_tooltip)
                                        },
                                        {
                                            //ÊîØÊåÅËØ≠Ë®Ä
                                            title: localize(localizationMap.tag_language_support),
                                            id: "tag_language_support",
                                            class: "tag-pink",
                                            tooltip: `
<div class="${VOICELINK_CLASS}_tags">
<span class="${VOICELINK_CLASS}_tag-pink">${localize(localizationMap.language_japanese)}</span>
<span class="${VOICELINK_CLASS}_tag-pink">${localize(localizationMap.language_simplified_chinese)}</span>
<span class="${VOICELINK_CLASS}_tag-pink">${localize(localizationMap.language_traditional_chinese)}</span>
<span class="${VOICELINK_CLASS}_tag-pink">${localize(localizationMap.language_english)}</span>
<span class="${VOICELINK_CLASS}_tag-pink">${localize(localizationMap.language_korean)}</span>
<span class="${VOICELINK_CLASS}_tag-pink">${localize(localizationMap.language_german)}</span>
<span class="${VOICELINK_CLASS}_tag-pink">${localize(localizationMap.language_french)}</span>
<span class="${VOICELINK_CLASS}_tag-pink">${localize(localizationMap.language_indonesian)}</span>
<span class="${VOICELINK_CLASS}_tag-pink">${localize(localizationMap.language_italian)}</span>
<span class="${VOICELINK_CLASS}_tag-pink">${localize(localizationMap.language_portuguese)}</span>
<span class="${VOICELINK_CLASS}_tag-pink">${localize(localizationMap.language_swedish)}</span>
<span class="${VOICELINK_CLASS}_tag-pink">${localize(localizationMap.language_thai)}</span>
<span class="${VOICELINK_CLASS}_tag-pink">${localize(localizationMap.language_vietnamese)}</span>
</div>
                  `
                                        },
                                        {
                                            //ÁâπÂÖ∏‰ΩúÂìÅ
                                            title: localize(localizationMap.tag_bonus_work),
                                            id: "tag_bonus_work",
                                            class: "tag-yellow",
                                            tooltip: localize(localizationMap.tag_bonus_work_tooltip)
                                        },
                                        {
                                            //Âê´ÁâπÂÖ∏
                                            title: localize(localizationMap.tag_has_bonus),
                                            id: "tag_has_bonus",
                                            class: "tag-orange",
                                            tooltip: localize(localizationMap.tag_has_bonus_tooltip)
                                        },
                                        {
                                            //Êñá‰ª∂Ê†ºÂºè
                                            title: localize(localizationMap.tag_file_format),
                                            id: "tag_file_format",
                                            class: "tag-darkblue",
                                            tooltip: localize(localizationMap.tag_file_format_tooltip)
                                        },
                                        {
                                            //Â∑≤‰∏ãÊû∂
                                            title: localize(localizationMap.tag_no_longer_available),
                                            id: "tag_no_longer_available",
                                            class: "tag-gray",
                                        },
                                        {
                                            //AI & ÈÉ®ÂàÜAI
                                            title: localize(localizationMap.tag_ai),
                                            id: "tag_ai",
                                            class: "tag-purple",
                                            tooltip: localize(localizationMap.tag_ai_tooltip)
                                        }
                                    ]
                                },
                            ]
                        },
                        {
                            //ÁøªËØëÊÉÖÂÜµÊòæÁ§∫Ë°®Ê†º
                            items: [
                                {
                                    //ÁøªËØëÊÉÖÂÜµÊòæÁ§∫ÂºÄÂÖ≥
                                    type: "checkbox",
                                    title: localize(localizationMap.tag_translation_request),
                                    id: "tag_translation_request",
                                    tooltip: localize(localizationMap.tag_translation_request_tooltip)
                                },
                            ]
                        },
                        {
                            //ÁøªËØëÊÉÖÂÜµÊ†áÁ≠æÊòæÁ§∫Ë°®Ê†º
                            binding: {
                                target: "tag_translation_request",
                                value: true
                            },
                            items: [
                                {
                                    //ÂêÑÁßçÁøªËØëÊÉÖÂÜµÊòæÁ§∫
                                    type: "tag_switch",
                                    sortable: true,
                                    sort_id: "tag_translation_request_display_order",
                                    items: [
                                        {
                                            //Ëã±ËØ≠
                                            title: `${localize(localizationMap.language_english_abbr)} 1-1`,
                                            id: "tag_translation_request_english",
                                            class: "tag-orange",
                                            tooltip: localize(localizationMap.language_english)
                                        },
                                        {
                                            //ÁÆÄ‰Ωì‰∏≠Êñá
                                            title: `${localize(localizationMap.language_simplified_chinese_abbr)} 1-1`,
                                            id: "tag_translation_request_simplified_chinese",
                                            class: "tag-orange",
                                            tooltip: localize(localizationMap.language_simplified_chinese)
                                        },
                                        {
                                            //ÁπÅ‰Ωì‰∏≠Êñá
                                            title: `${localize(localizationMap.language_traditional_chinese_abbr)} 1-1`,
                                            id: "tag_translation_request_traditional_chinese",
                                            class: "tag-orange",
                                            tooltip: localize(localizationMap.language_traditional_chinese)
                                        },
                                        {
                                            //Èü©ËØ≠
                                            title: `${localize(localizationMap.language_korean_abbr)} 1-1`,
                                            id: "tag_translation_request_korean",
                                            class: "tag-orange",
                                            tooltip: localize(localizationMap.language_korean)
                                        },
                                        {
                                            //Ë•øÁè≠ÁâôËØ≠
                                            title: `${localize(localizationMap.language_spanish_abbr)} 1-1`,
                                            id: "tag_translation_request_spanish",
                                            class: "tag-orange",
                                            tooltip: localize(localizationMap.language_spanish)
                                        },
                                        {
                                            //Âæ∑ËØ≠
                                            title: `${localize(localizationMap.language_german_abbr)} 1-1`,
                                            id: "tag_translation_request_german",
                                            class: "tag-orange",
                                            tooltip: localize(localizationMap.language_german)
                                        },
                                        {
                                            //Ê≥ïËØ≠
                                            title: `${localize(localizationMap.language_french_abbr)} 1-1`,
                                            id: "tag_translation_request_french",
                                            class: "tag-orange",
                                            tooltip: localize(localizationMap.language_french)
                                        },
                                        {
                                            //Âç∞Â∞ºËØ≠
                                            title: `${localize(localizationMap.language_indonesian_abbr)} 1-1`,
                                            id: "tag_translation_request_indonesian",
                                            class: "tag-orange",
                                            tooltip: localize(localizationMap.language_indonesian)
                                        },
                                        {
                                            //ÊÑèÂ§ßÂà©ËØ≠
                                            title: `${localize(localizationMap.language_italian_abbr)} 1-1`,
                                            id: "tag_translation_request_italian",
                                            class: "tag-orange",
                                            tooltip: localize(localizationMap.language_italian)
                                        },
                                        {
                                            //Ëë°ËêÑÁâôËØ≠
                                            title: `${localize(localizationMap.language_portuguese_abbr)} 1-1`,
                                            id: "tag_translation_request_portuguese",
                                            class: "tag-orange",
                                            tooltip: localize(localizationMap.language_portuguese)
                                        },
                                        {
                                            //ÁëûÂÖ∏ËØ≠
                                            title: `${localize(localizationMap.language_swedish_abbr)} 1-1`,
                                            id: "tag_translation_request_swedish",
                                            class: "tag-orange",
                                            tooltip: localize(localizationMap.language_swedish)
                                        },
                                        {
                                            //Ê≥∞ËØ≠
                                            title: `${localize(localizationMap.language_thai_abbr)} 1-1`,
                                            id: "tag_translation_request_thai",
                                            class: "tag-orange",
                                            tooltip: localize(localizationMap.language_thai)
                                        },
                                        {
                                            //Ë∂äÂçóËØ≠
                                            title: `${localize(localizationMap.language_vietnamese_abbr)} 1-1`,
                                            id: "tag_translation_request_vietnamese",
                                            class: "tag-orange",
                                            tooltip: localize(localizationMap.language_vietnamese)
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                }
            ]
        };
    }
    class SettingPageBuilder {
        constructor(structure, settings) {
            this.structure = structure;
            this.settings = settings;
            this.container = null;
        }

        getClass(name) {
            if(!VOICELINK_CLASS || VOICELINK_CLASS === "") return name;
            return `${VOICELINK_CLASS}_${name}`;
        }

        build(useTemp = false) {
            const f = this.structure;
            let tempSettings = this.settings;

            //Ëã•Êú™Ë¶ÅÊ±ÇÂàôÊ∏ÖÁ©∫ËÆæÁΩÆÊöÇÂ≠ò
            if(useTemp){
                tempSettings = {};
                for(let key in this.settings.temp_edited){
                    if(!key.startsWith("_s_")) continue;
                    tempSettings[key] = this.settings.temp_edited[key];
                }
            }else{
                this.settings.clearTemp();
            }

            //ÂàõÂª∫container
            const container = document.createElement("div");
            container.className = this.getClass("container");
            container.id = this.getClass("settings-container");
            this.container = container;

            //ÂàõÂª∫ÂÖ≥Èó≠ÊåâÈíÆ
            const closeButton = document.createElement("button");
            closeButton.id = this.getClass("button-close");
            closeButton.innerText = "X";
            closeButton.onclick = () => {
                container.remove();
            };
            container.appendChild(closeButton);

            //ÂàõÂª∫Ê†áÈ¢ò
            const title = document.createElement("h1");
            title.innerText = f.title;
            container.appendChild(title);

            //ÈÅçÂéÜÊûÑÂª∫Section
            for(const section of f.items){
                container.appendChild(this.buildSection(section));
            }

            //Ê∑ªÂä†‰øùÂ≠ò„ÄÅÈáçÁΩÆÊåâÈíÆ
            const buttonContainer = document.createElement("div");
            buttonContainer.className = this.getClass("button-container");
            const saveButton = document.createElement("button");
            saveButton.id = this.getClass("button-save");
            saveButton.innerText = localize(localizationMap.button_save);
            saveButton.onclick = () => {
                try{
                    this.settings.save();
                    window.alert(localize(localizationMap.save_complete))
                    container.remove();
                }catch (e){
                    window.alert(e);
                }
            };
            const resetButton = document.createElement("button");
            resetButton.id = this.getClass("button-reset");
            resetButton.innerText = localize(localizationMap.button_reset);
            resetButton.onclick = () => {
                if(!window.confirm(localize(localizationMap.reset_confirm))){
                    return;
                }
                try{
                    // this.settings.reset();
                    window.alert(localize(localizationMap.reset_complete))
                }catch (e) {
                    window.alert(e);
                }
                this.refreshSettings(this.settings.default_backup);
            };
            buttonContainer.appendChild(saveButton);
            buttonContainer.appendChild(resetButton);
            container.appendChild(buttonContainer);

            this.initSortableElement();
            this.refreshSettings(tempSettings);
            return container;
        };

        buildSection(section){
            //ÂàõÂª∫ÂÆπÂô®
            const container = document.createElement("div");
            container.className = this.getClass("section-container");

            //ÂàõÂª∫Ê†áÈ¢ò
            const title = document.createElement("h2");
            title.innerText = section.title;
            container.appendChild(title);

            //ÈÅçÂéÜÊûÑÂª∫Table
            for(const item of section.items){
                container.appendChild(this.buildTable(item, container));
            }

            return container;
        };

        buildTable(table, section){
            //ÂàõÂª∫table
            const tableElement = document.createElement("table");

            //ÂàõÂª∫ÂèØËÉΩÂ≠òÂú®ÁöÑpresetÁªëÂÆö
            this.createBinding(table, tableElement, section);

            //ÈÅçÂéÜÊûÑÂª∫RowÔºàÂÖàÊäärowÁºìÂ≠òÂú®ÂàóË°®ÈáåÔºåÁªèËøáÊéíÂ∫èÂêéÊûÑÂª∫Ôºâ
            let rowList = [];
            const nodesCache = document.createElement("div");
            for(const row of table.items){
                let rowElement = this.buildRow(row, nodesCache);
                if(table.sortable){
                    this.setSortable(rowElement);
                }
                rowList.push(rowElement);

                //Â≠òÂÖ•ÁºìÂ≠òÁî®‰∫éÁªëÂÆö
                nodesCache.appendChild(rowElement);
            }

            //ÈáçÁΩÆÊåâÈíÆË°å
            let resetRow;
            if(table.sortable){
                tableElement.setAttribute("data-sort-id", table.sort_id);
                this.sortSortable(rowList, table.sort_id);

                //Ëã•ÂèØÊéíÂ∫èÂàôËøòË¶ÅÊ∑ªÂä†ÈáçÁΩÆÊåâÈíÆ
                if(table.ignore_reset !== true){
                    resetRow = document.createElement("tr");
                    const resetCell = document.createElement("td");
                    resetCell.classList.add(this.getClass("input-cell"))
                    resetCell.colSpan = 2;
                    resetCell.style.setProperty("text-align", "right", "important");  //textAlign = "right !important";
                    const resetButton = document.createElement("button");
                    resetButton.classList.add(this.getClass("button-flat"));
                    resetButton.title = localize(localizationMap.reset_order);
                    resetButton.style.setProperty("margin-right", "0", "important");  //marginRight = "0 !important";
                    resetButton.style.setProperty("margin-bottom", "0", "important");  //marginBottom = "0 !important";
                    const icon = document.createElement("span");
                    icon.classList.add(this.getClass("reset-btn-small"));
                    resetButton.appendChild(icon);
                    const title = document.createElement("span");
                    title.innerText = localize(localizationMap.reset_order);
                    resetButton.appendChild(title);
                    resetButton.onclick = () => {
                        if(!window.confirm(localize(localizationMap.reset_order_confirm))){
                            return;
                        }
                        this.reorderSortable(table.sort_id, this.settings.getDefaultValue(table.sort_id));
                        // tableElement.insertBefore(resetRow, tableElement.firstChild);
                    };
                    resetCell.appendChild(resetButton);
                    resetRow.appendChild(resetCell);
                    // tableElement.appendChild(resetRow);
                }
            }

            rowList.forEach((row) => {
                tableElement.appendChild(row);
            });
            if(resetRow){
                tableElement.appendChild(resetRow);
            }

            return tableElement;
        };

        buildRow(row, table){
            //ÂàõÂª∫row
            let rowElement = document.createElement("tr");

            //Ê†πÊçÆÁ±ªÂûãÂàõÂª∫ÂÜÖÂÆπ
            switch (row.type) {
                case "checkbox":
                    rowElement = this.createToggleRow(row);
                    break;
                case "dropdown":
                    rowElement = this.createDropdownRow(row);
                    break;
                case "input":
                    rowElement = this.createInputRow(row);
                    break;
                case "tag_switch":
                    rowElement = this.createTagSwitchRow(row);
                    break;
                default:
                    console.error(`Unknown row type: ${row.type}`);
                    break;
            }

            //ËÆæÁΩÆBinding
            if(row.binding){
                this.createBinding(row, rowElement, table)
            }

            rowElement.classList.add(this.getClass("setting"));
            if(row.id){
                rowElement.setAttribute("data-id", row.id);
            }
            return rowElement;
        };

        createToggleRow(row){
            //ÂàõÂª∫Row
            const rowElement = document.createElement("tr");
            if(row.indent) {
                rowElement.classList.add(this.getClass(`indent-${row.indent}`));
            }

            //ÂàõÂª∫ËÆæÁΩÆÈ°πÊ†áÈ¢ò
            const titleCell = document.createElement("td");
            titleCell.className = this.getClass("tooltip");
            const title = document.createElement("span");
            title.className = this.getClass("row-title") + " " + this.getClass("ignore-drag");
            title.innerHTML = Csp.createHTML(row.title);
            titleCell.appendChild(title);

            if(row.tooltip) {
                const tooltip = document.createElement("span");
                tooltip.className = this.getClass("tooltip-text");
                tooltip.innerHTML = Csp.createHTML(row.tooltip);
                titleCell.appendChild(tooltip);
            }

            //ÂàõÂª∫ÂºÄÂÖ≥ÂíåÈáçÁΩÆÊåâÈíÆ
            const settingId = `_s_${row.id}`;
            const inputCell = document.createElement("td");
            inputCell.classList.add(this.getClass("input-cell"));
            const inputContainer = document.createElement("div");
            inputContainer.classList.add(this.getClass("toggle-container"));
            inputCell.appendChild(inputContainer);

            //ÂàõÂª∫ÂºÄÂÖ≥
            const input = document.createElement("input");
            input.type = "checkbox";
            input.id = this.getClass(row.id);
            input.name = input.id;
            // inputCell.appendChild(input);
            inputContainer.appendChild(input);

            const label = document.createElement("label");
            label.classList.add(this.getClass("toggle"));
            label.setAttribute("for", input.id);
            const hidden = document.createElement("span");
            hidden.classList.add(this.getClass("hidden"));
            hidden.innerHTML = Csp.createHTML(row.title);
            label.appendChild(hidden);
            // inputCell.appendChild(label);
            inputContainer.appendChild(label);

            //ÂàõÂª∫ÈáçÁΩÆÊåâÈíÆ
            if(row.ignore_reset !== true){
                const defaultValue = this.settings.getDefaultValue(settingId);
                const resetButton = document.createElement("button");
                resetButton.className = this.getClass("reset-btn-small") + " " + this.getClass("ignore-drag");
                resetButton.title = localize(localizationMap.button_reset);
                resetButton.onclick = () => {
                    input.checked = defaultValue === true;
                    input.dispatchEvent(new Event("change"));
                };
                // inputCell.insertBefore(resetButton, inputCell.firstChild);
                inputContainer.insertBefore(resetButton, inputContainer.firstChild);

                input.addEventListener("change", () => {
                    //ÂÜ≥ÂÆöÊòØÂê¶ÊòæÁ§∫ÈáçÁΩÆÊåâÈíÆ
                    resetButton.style.setProperty("display", input.checked === defaultValue ? "none" : "inline-block", "important");  //display = input.checked === defaultValue ? "none" : "inline-block";
                });
            }

            //ÁõëÂê¨Âô®ÈÉΩÂàõÂª∫Â•Ω‰∫ÜÂÜçËÆæÁΩÆÂàùÂßãÂÄº
            input.addEventListener("change", () => {
                //Êõ¥Êñ∞Âà∞ÊöÇÂ≠òËÆæÁΩÆ
                this.settings.saveTemp(settingId, input.checked);
            })
            input.checked = this.settings[settingId] === true;
            input.dispatchEvent(new Event("change"));

            rowElement.appendChild(titleCell);
            rowElement.appendChild(inputCell);
            return rowElement;
        };

        createDropdownRow(row){
            const rowElement = document.createElement("tr");
            if(row.indent) {
                rowElement.classList.add(this.getClass(`indent-${row.indent}`));
            }

            const titleCell = document.createElement("td");
            titleCell.className = this.getClass("tooltip");
            const label = document.createElement("label");
            label.className = this.getClass("row-title") + " " + this.getClass("ignore-drag");
            label.setAttribute("for", this.getClass(row.id));
            label.innerHTML = Csp.createHTML(row.title);
            titleCell.appendChild(label);

            if(row.tooltip) {
                const tooltip = document.createElement("span");
                tooltip.className = this.getClass("tooltip-text");
                tooltip.innerHTML = Csp.createHTML(row.tooltip);
                titleCell.appendChild(tooltip);
            }

            const inputCell = document.createElement("td");
            inputCell.classList.add(this.getClass("input-cell"));
            const select = document.createElement("select");
            select.className = this.getClass("ignore-drag");
            select.id = this.getClass(row.id);
            select.name = select.id;
            for(const item of row.options){
                const option = document.createElement("option");
                option.value = item.value;
                option.innerText = item.title;
                select.appendChild(option);
            }
            inputCell.appendChild(select);

            //ÂàõÂª∫ÈáçÁΩÆÊåâÈíÆ
            const settingId = `_s_${row.id}`;
            if(row.ignore_reset !== true){
                const defaultValue = this.settings.getDefaultValue(settingId);
                const resetButton = document.createElement("button");
                resetButton.className = this.getClass("reset-btn-small") + " " + this.getClass("ignore-drag");
                resetButton.title = localize(localizationMap.button_reset);
                resetButton.onclick = () => {
                    select.value = defaultValue;
                    select.dispatchEvent(new Event("change"));
                };
                inputCell.insertBefore(resetButton, inputCell.firstChild);

                select.addEventListener("change", () => {
                    //ÂÜ≥ÂÆöÊòØÂê¶ÊòæÁ§∫ÈáçÁΩÆÊåâÈíÆ
                    resetButton.style.setProperty("display", select.value === defaultValue ? "none" : "inline-block", "important");  //display = select.value === defaultValue ? "none" : "inline-block";
                });
            }

            //ÁõëÂê¨Âô®ÈÉΩÂàõÂª∫Â•Ω‰∫ÜÂÜçËÆæÁΩÆÂàùÂßãÂÄº
            select.addEventListener("change", () => {
                //Êõ¥Êñ∞Âà∞ÊöÇÂ≠òËÆæÁΩÆ
                this.settings.saveTemp(settingId, select.value);
            })
            select.value = this.settings[settingId];
            select.dispatchEvent(new Event("change"));

            rowElement.appendChild(titleCell);
            rowElement.appendChild(inputCell);
            return rowElement;
        };

        createInputRow(row){
            const rowElement = document.createElement("tr");
            if(row.indent) {
                rowElement.classList.add(this.getClass(`indent-${row.indent}`));
            }

            const titleCell = document.createElement("td");
            titleCell.className = this.getClass("tooltip");
            const label = document.createElement("label");
            label.className = this.getClass("row-title") + " " + this.getClass("ignore-drag");
            label.setAttribute("for", this.getClass(row.id));
            label.innerHTML = Csp.createHTML(row.title);
            titleCell.appendChild(label);

            if(row.tooltip) {
                const tooltip = document.createElement("span");
                tooltip.className = this.getClass("tooltip-text");
                tooltip.innerHTML = Csp.createHTML(row.tooltip);
                titleCell.appendChild(tooltip);
            }

            const inputCell = document.createElement("td");
            inputCell.classList.add(this.getClass("input-cell"));
            const input = document.createElement("input");
            input.type = "text";
            input.id = this.getClass(row.id);
            input.name = input.id;
            inputCell.appendChild(input);

            //ÂàõÂª∫ÈáçÁΩÆÊåâÈíÆ
            const settingId = `_s_${row.id}`;
            if(row.ignore_reset !== true){
                const defaultValue = this.settings.getDefaultValue(settingId);
                const resetButton = document.createElement("button");
                resetButton.className = this.getClass("reset-btn-small") + " " + this.getClass("ignore-drag");
                resetButton.title = localize(localizationMap.button_reset);
                resetButton.onclick = () => {
                    input.value = defaultValue;
                    input.dispatchEvent(new Event("change"));
                };
                inputCell.insertBefore(resetButton, inputCell.firstChild);

                input.addEventListener("change", () => {
                    //ÂÜ≥ÂÆöÊòØÂê¶ÊòæÁ§∫ÈáçÁΩÆÊåâÈíÆ
                    resetButton.style.setProperty("display", input.value === defaultValue ? "none" : "inline-block", "important");  //display = input.value === defaultValue ? "none" : "inline-block";
                });
            }

            //ÁõëÂê¨Âô®ÈÉΩÂàõÂª∫Â•Ω‰∫ÜÂÜçËÆæÁΩÆÂàùÂßãÂÄº
            input.addEventListener("change", () => {
                //Êõ¥Êñ∞Âà∞ÊöÇÂ≠òËÆæÁΩÆ
                this.settings.saveTemp(settingId, input.value);
            })
            input.value = this.settings[settingId];
            input.dispatchEvent(new Event("change"));

            rowElement.appendChild(titleCell);
            rowElement.appendChild(inputCell);
            return rowElement;
        };

        createTagSwitchRow(row){
            const rowElement = document.createElement("tr");
            if(row.indent) {
                rowElement.classList.add(this.getClass(`indent-${row.indent}`));
            }

            const tagCell = document.createElement("td");
            tagCell.colSpan = 2;
            //Áî®ÂÜÖÈÉ®ÂÆπÂô®ÂÜçÊ¨°ÂåÖË£πÊ†áÁ≠æÔºå‰øùËØÅÈáçÁΩÆÊåâÈíÆÁöÑ‰ΩçÁΩÆ
            const tagContainer = document.createElement("div");
            tagContainer.className = this.getClass("tags");
            tagCell.appendChild(tagContainer);

            const tagList = [];
            for(const tag of row.items){
                const tagSpan = document.createElement("label");
                tagSpan.classList.add(this.getClass(tag["class"]));
                tagSpan.innerText = tag.title;
                tagSpan.setAttribute("for", this.getClass(tag.id));
                tagSpan.setAttribute("data-id", tag.id);
                this.setSortable(tagSpan);

                //Ê∑ªÂä†switch
                const settingId = `_s_${tag.id}`;
                const switchInput = document.createElement("input");
                switchInput.style.setProperty("display", "none", "important");  //display = "none !important";
                switchInput.type = "checkbox";
                switchInput.id = this.getClass(tag.id);
                switchInput.name = switchInput.id;
                switchInput.addEventListener("change", (event) => {
                    if(event.target.checked) {
                        tagSpan.classList.remove(this.getClass("tag-off"));
                    }else if(!tagSpan.classList.contains(this.getClass("tag-off"))) {
                        tagSpan.classList.add(this.getClass("tag-off"));
                    }

                    //Êõ¥Êñ∞Âà∞ÊöÇÂ≠òËÆæÁΩÆ
                    this.settings.saveTemp(settingId, switchInput.checked);
                })
                switchInput.checked = this.settings[`_s_${tag.id}`] === true;
                switchInput.dispatchEvent(new Event("change"));

                tagSpan.classList.toggle(this.getClass("tag-off"), !switchInput.checked);
                tagSpan.appendChild(switchInput);

                if(tag.tooltip) {
                    tagSpan.classList.add(this.getClass("tooltip"));
                    const tooltip = document.createElement("span");
                    tooltip.className = this.getClass("tooltip-text");
                    tooltip.innerHTML = Csp.createHTML(tag.tooltip);
                    tagSpan.appendChild(tooltip);
                }

                tagList.push(tagSpan);
            }

            if(row.sortable){
                tagContainer.setAttribute("data-sort-id", row.sort_id);
                this.sortSortable(tagList, row.sort_id);

                //Ê∑ªÂä†ÊéíÂàóÈáçÁΩÆÊåâÈíÆ
                if(row.ignore_reset !== true){
                    const resetOrderButton = document.createElement("button");
                    resetOrderButton.classList.add(this.getClass("button-flat"));
                    resetOrderButton.title = localize(localizationMap.button_reset);
                    resetOrderButton.onclick = () => {
                        if(!window.confirm(localize(localizationMap.reset_order_confirm))){
                            return;
                        }
                        this.reorderSortable(row.sort_id, this.settings.getDefaultValue(row.sort_id));
                    };

                    const icon = document.createElement("span");
                    icon.classList.add(this.getClass("reset-btn-small"));
                    resetOrderButton.appendChild(icon);

                    const title = document.createElement("span");
                    title.innerText = localize(localizationMap.reset_order);
                    resetOrderButton.appendChild(title);

                    tagCell.appendChild(resetOrderButton);
                    // tagCell.insertBefore(resetOrderButton, tagCell.firstChild);
                }
            }

            //Ê∑ªÂä†ËÆæÁΩÆÈáçÁΩÆÊåâÈíÆ
            if(row.ignore_reset !== true){
                const resetSettingsButton = document.createElement("button");
                resetSettingsButton.classList.add(this.getClass("button-flat"));
                resetSettingsButton.title = localize(localizationMap.button_reset);
                resetSettingsButton.onclick = () => {
                    if(!window.confirm(localize(localizationMap.reset_confirm))){
                        return;
                    }
                    for (const item of row.items) {
                        let tag = tagContainer.querySelector("#" + this.getClass(item.id));
                        if(!tag) continue;
                        tag.checked = this.settings.getDefaultValue(item.id);
                        tag.dispatchEvent(new Event("change"));
                    }
                };

                const icon = document.createElement("span");
                icon.classList.add(this.getClass("reset-btn-small"));
                resetSettingsButton.appendChild(icon);

                const title = document.createElement("span");
                title.innerText = localize(localizationMap.button_reset);
                resetSettingsButton.appendChild(title);

                tagCell.appendChild(resetSettingsButton);
                // tagCell.insertBefore(resetOrderButton, tagCell.firstChild);
            }


            tagList.forEach((tag) => {
                tagContainer.appendChild(tag);
            });
            rowElement.appendChild(tagCell);
            return rowElement;
        };

        createBinding(data, element, section){
            if(!data.binding || !this.container) return;

            const binding = data.binding;
            const target = section.querySelector("#" + this.getClass(binding.target));
            if(!target) return;

            let showState = "unset";
            switch (element.nodeName){
                case "TABLE":
                    showState = "table";
                    break;
                case "TR":
                    showState = "table-row";
                    break;
            }

            target.addEventListener("change", (event) => {
                const value = event.target.value;
                const checked = event.target.checked;
                element.style.setProperty("display", value === binding.value || checked === binding.value ? showState : "none", "important");  //display = value === binding.value || checked === binding.value ? showState : "none";
            });

            element.style.setProperty("display", target.value === binding.value || target.checked === binding.value ? showState : "none", "important");  //display = target.value === binding.value || target.checked === binding.value ? showState : "none";
        };

        sortSortable(sortList, sortId, orderList){
            orderList = orderList ? orderList : this.settings[`_s_${sortId}`];
            if(!orderList) return;

            for (let i = 0; i < orderList.length; ++i) {
                for (let j = 0; j < sortList.length; ++j){
                    if(orderList[i] === sortList[j].getAttribute("data-id")) {
                        let tmp = sortList[i];
                        sortList[i] = sortList[j];
                        sortList[j] = tmp;
                        break;
                    }
                }
            }
        };

        setSortable(ele){
            ele.classList.add(this.getClass("sortable"));
        };

        refreshSettings(settings) {
            //Âà∑Êñ∞ËÆæÁΩÆÈ°πÂÄºÁöÑÂ±ïÁ§∫ÊÉÖÂÜµÔºà‰øùÊåÅinputÂÄºÂíåËÆæÁΩÆ‰∏≠ÁöÑÂÆûÈôÖÂÄº‰∏ÄËá¥Ôºâ
            //Ê∏ÖÁ©∫ËÆæÁΩÆÊöÇÂ≠ò
            this.settings.clearTemp();
            settings = settings ? settings : this.settings;

            //Âà∑Êñ∞ËÆæÁΩÆÈ°π
            for(const key in settings){
                if(!key.startsWith("_s_")) continue;
                const targetId = this.getClass(key.substring(3));

                if(settings[key] && Array.isArray(settings[key])){
                    //ÂèØËÉΩÊòØÊéíÂ∫èÂØπË±°ÔºåÂÖàÊêúÁ¥¢ÊéíÂ∫èÁõÆÊ†áÔºåÊêú‰∏çÂà∞ÂÜçÊåâÈªòËÆ§ÂÄºÂ§ÑÁêÜ
                    if(this.reorderSortable(key.substring(3), settings[key])) continue;
                }

                //ÈùûÊéíÂ∫èÂØπË±°
                const target = this.container.querySelector("#" + targetId);
                if(!target) continue;

                if(target.tagName === "INPUT") {
                    if(target.type === "checkbox") {
                        target.checked = settings[key] === true;
                    }else{
                        target.value = settings[key];
                    }
                }else if(target.tagName === "SELECT") {
                    target.value = settings[key];
                }

                if(key === "_s_lang") continue;
                target.dispatchEvent(new Event("change"));
            }
        };

        reorderSortable(sort_id, orderList) {
            const target = this.container.querySelector(`*[data-sort-id="${sort_id}"]`);
            if(target) {
                let list = [...target.children];
                this.sortSortable(list, sort_id, orderList);

                for(let i = 0; i < list.length; ++i) {
                    target.removeChild(list[i]);
                }

                for(let i = 0; i < list.length; ++i) {
                    target.appendChild(list[i]);
                }

                this.settings.saveTemp(sort_id, list.map(ele => ele.getAttribute("data-id")).filter(val => val && val !== ""));
                return true;
            }
            return false;
        }

        initSortableElement() {
            //ÂàùÂßãÂåñÊéíÂ∫èÁªÑ‰ª∂
            const sortableGroups = this.container.querySelectorAll(`.${this.getClass('sortable')}`);
            sortableGroups.forEach(group => {
                new Sortable(group, group.parentElement.getAttribute("data-sort-id"), this.settings);
            });
        };

    }
    class Sortable {
        constructor(element, sort_id, settings, options) {
            this.element = element;
            this.options = options;
            this.sortId = sort_id;
            this.settings = settings;
            this.dragging = null;

            if(!sort_id) {
                throw new Error("sort_id is required");
            }

            this.init();
        }

        getClass(name) {
            if(!VOICELINK_CLASS || VOICELINK_CLASS === "") return name;
            return `${VOICELINK_CLASS}_${name}`;
        }

        init() {
            this.element.addEventListener('mousedown', this.onMouseDown.bind(this));
            document.addEventListener('mousemove', this.onMouseMove.bind(this));
            document.addEventListener('mouseup', this.onMouseUp.bind(this));
        }

        onMouseDown(event) {
            if(event.target.nodeName === "INPUT" || event.target.classList.contains(this.getClass("toggle")) || event.target.classList.contains(this.getClass("ignore-drag"))) return;
            if (event.target.closest(`.${this.getClass('sortable')}`)) {
                this.dragging = event.target.closest(`.${this.getClass('sortable')}`);
                this.dragging.classList.add(this.getClass('dragging'));
            }
        }

        onMouseMove(event) {
            if (this.dragging) {
                event.preventDefault();

                try{
                    let sibling = document.elementFromPoint(event.clientX, event.clientY).closest(`.${this.getClass('sortable')}`);
                    if (sibling && sibling !== this.dragging) {
                        this.element.parentNode.insertBefore(this.dragging, sibling.nextSibling === this.dragging ? sibling : sibling.nextSibling);
                        //ÊöÇÂ≠òÂΩìÂâçÈ°∫Â∫è
                        const order = [...this.element.parentNode.children].map(item => item.getAttribute("data-id")).filter(item => item || item === "");
                        this.settings.saveTemp(this.sortId, order);
                    }
                }catch (e) {
                    console.error(e)
                }

            }
        }

        onMouseUp(event) {
            if (this.dragging) {
                this.dragging.classList.remove(this.getClass('dragging'));
                this.dragging = null;
            }
        }
    }
    const SettingsPopup = {
        showPopup(useTemp = false) {
            let uiBuilder = new SettingPageBuilder(getSettingsUi(), settings);
            let ui = uiBuilder.build(useTemp);
            const displayLangElement = ui.querySelector(`#${VOICELINK_CLASS}_lang`);
            displayLangElement.addEventListener("change", e => {
                settings._s_lang = displayLangElement.value;
                GM_setValue("lang", settings._s_lang);
                ui.remove();
                SettingsPopup.showPopup(true);
            });
            document.body.appendChild(ui);
        }
    };

    let isInit = false;
    let observing = false;
    function init () {
        if(!isInit) {
            const style = document.createElement("style");
            style.innerHTML = Csp.createHTML(POPUP_CSS + SETTINGS_CSS);
            document.head.appendChild(style);
            // SettingsPopup.getPopup()
            GM_registerMenuCommand("Settings - ËÆæÁΩÆ", () => SettingsPopup.showPopup())
            GM_registerMenuCommand("Notice - ÂÖ¨Âëä", () => showUpdateNotice(true));
            GM_registerMenuCommand("Home / Update - ‰∏ªÈ°µ / Êõ¥Êñ∞", () =>
                GM_openInTab(IS_PREVIEW ? "https://sleazyfork.org/zh-CN/scripts/521128-voicelinks-preview" : "https://sleazyfork.org/zh-CN/scripts/456775-voicelinks", {active: true}));

            document.addEventListener("securitypolicyviolation", function (e) {
                if (e.blockedURI.includes("img.dlsite.jp")) {
                    const img = document.querySelector(`img[src="${e.blockedURI}"]`);
                    img.remove();

                    const imgContainer = Popup.popupElement.img.container;
                    if(imgContainer){
                        imgContainer.style.setProperty("display", "none", "important");  //display = "none !important";
                        Popup.hideImg = true;
                    }
                }
            });

            isInit = true;
        }

        if(!document.body || observing){
            return;
        }

        Parser.walkNodes(document.body);
        if(!document.getElementById(`${VOICELINK_CLASS}-voice-popup`)) Popup.makePopup(false);

        const observer = new MutationObserver(function (m) {
            for (let i = 0; i < m.length; ++i) {
                let addedNodes = m[i].addedNodes;
                let removedNodes = m[i].removedNodes;

                for (let j = 0; j < removedNodes.length; ++j){
                    let node = removedNodes[j];
                }

                for (let j = 0; j < addedNodes.length; ++j) {
                    Parser.walkNodes(addedNodes[j]);
                }
            }
        });

        observer.observe(document.body, { childList: true, subtree: true})
        setUserSelectTitle();

        //ÊòæÁ§∫ÈáçË¶ÅÈÄöÁü•
        showUpdateNotice();

        observing = true;
    }

    document.addEventListener("DOMContentLoaded", init);

    function showUpdateNotice(force = false) {
        const firstTimeToken = 105;
        if(GM_getValue("first_token", undefined) === firstTimeToken && !force){
            return;
        }
        GM_setValue("first_token", firstTimeToken);

        if(!force && window.confirm(localize(localizationMap.notice_update)) === false) {
            return;
        }

        GM_openInTab(
            IS_PREVIEW ? `https://github.com/IceFoxy062/VoiceLinks-Extend/blob/dev/docs/major_updates/v4.8.6/v4.8.6-${settings._s_lang}.md` : `https://github.com/IceFoxy062/VoiceLinks-Extend/blob/dev/docs/major_updates/v4.8.6/v4.8.6-${settings._s_lang}.md`,
            {active: true});

        /*let popup = document.createElement("div");
        popup.style = `
        position: fixed;
        width: 60%;
        max-width: 800px;
        height: auto;
        margin: 20px auto;
        padding: 10px;
        left: 0;
        right: 0;
        top: 0;
        background: rgba(255, 255, 255, 0.9);
        z-index: 999;

        border-radius: 10px;
        border: 2px solid gray`;
        popup.innerHTML = Csp.createHTML(`
        <h1 style="text-indent: 0; color: black;">Notice from VoiceLinks</h1>
        <p>
        <strong><span style="font-size:14px;">ÈáçÂ§ßÊõ¥Êñ∞ÔºåÊ∑ªÂä†Â§ßÈáèËá™ÂÆö‰πâËÆæÁΩÆÔºåÈÉ®ÂàÜÂéüÊúâËÆæÁΩÆË¢´ÈáçÁΩÆÔºåËØ∑ÊâìÂºÄ<a data-link="settings">ËÆæÁΩÆ</a>ÁïåÈù¢ÈáçÊñ∞ËÆæÁΩÆ„ÄÇ</span></strong>
        </p>
        <p>
        <strong><span style="font-size:14px;">A large number of custom settings have been added, and some original settings have been reset. Please open the <a data-link="settings">settings</a> interface to set up.</span></strong>
        </p>
        <p>
        <br />
        </p>
        <p>
        ÂÖ∑‰ΩìÊõ¥Êñ∞Ôºö
        </p>
        <p>
        - <strong>ËÆæÁΩÆÁïåÈù¢ÂÆåÂÖ®ÈáçÊûÑ</strong>ÔºåÂπ∂Â¢ûÂä†Â§ßÈáèÂèØËÆæÁΩÆÈ°πÔºåÂåÖÊã¨<strong>Ëá™ÂÆö‰πâ‰ø°ÊÅØÁöÑÊòæÁ§∫ÊÉÖÂÜµ‰∏éÊòæÁ§∫È°∫Â∫è</strong>
        </p>
        <p>
        - ‰ΩøÁî®<strong>Ê†áÁ≠æ</strong>Êù•Ê†áËÆ∞È¢ùÂ§ñÁöÑ‰ΩúÂìÅ‰ø°ÊÅØ
        </p>
        <p>
        - Áé∞Âú®ÂèØ‰ª•Êü•Áúã<strong>ÁøªËØëÁî≥ËØ∑ÊÉÖÂÜµ</strong>‰∫Ü
        </p>
        <input style="font-size: 16px; text-align: center; width: 100%; padding: 5px 10px" type="button" value="OK">
        `);
        popup.querySelectorAll("a[data-link=settings]").forEach(link => {
            link.style.color = "blue !important";
            link.style.cursor = "pointer !important";
            link.style.textDecoration = "underline !important";
            link.addEventListener("click", function () {
                SettingsPopup.showPopup();
            })
        })
        popup.querySelector("input[type=button][value=OK]").addEventListener("click", function(){
            popup.remove();
            GM_setValue("first_token", firstTimeToken);
        })

        document.body.appendChild(popup);*/
    }

    //Deal with Trusted Types

    let Csp = {
        createHTML: (str) => str
    };
    if(window.isSecureContext === true && trustedTypes){
        Csp = trustedTypes.createPolicy(
            trustedTypes.defaultPolicy ? "VoiceLinkTrustedTypes" : "VoiceLinkTrustedTypes",
            Csp);
    }

    init();
})();
